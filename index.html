<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניטור יין</title>
     <link rel="icon" href="image_00b206.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&family=Playfair+Display:wght@400;700&family=Noto+Sans+Hebrew:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@digicole/pdfmake-rtl/build/pdfmake.min.js"></script>
    <script src="https://unpkg.com/@digicole/pdfmake-rtl/build/vfs_fonts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
/* קוד CSS מעודכן למובייל */
/* שינויים במובייל: .project-details-card עכשיו עם left: -280px; כדי שתציץ קצת */

@media (max-width: 768px) {
    .hamburger-menu-btn {
        top: 35px;
        right: 20px;
    }
    
    /* Sidebar improvements for mobile */
    .sidebar {
        width: 250px; /* Smaller width */
        right: -250px;
        max-height: 100vh;
        overflow-y: auto; /* Scrollable */
    }
    
    .sidebar-toggle-handle {
        display: none !important;
    }
    
    .sidebar.open {
        right: 0;
    }
    
    .sidebar.open .sidebar-toggle-handle {
        left: -35px;
    }
    
    .project-details-card {
        width: 250px;
        left: -280px; /* Card hidden by default - fully off-screen */
        height: auto; /* Changed from 300px to auto */
        max-height: 80vh; /* Allow taller card */
        /* Transition is added via JS after page load to prevent flickering */
        overflow-y: auto; /* Make scrollable */
        /* Prevent animation on page load */
        animation: none !important;
        will-change: left; /* Hint browser to optimize left position changes */
    }
    .pull-handle {
        right: -22px;
        display: none; /* Hidden in favor of floating button */
        width: 42px;
        height: 42px;
        border-radius: 50%;
        top: 50%;
        transform: translateY(-50%);
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }
    .close-card-btn {
        top: 5px;
        left: 5px;
        font-size: calc(var(--font-size-base) * 1);
        display: block; /* Show close button on mobile */
    }
    .stage-nav-container {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 6px;
        padding: 8px 4px;
        justify-content: center;
        align-items: center;
    }
    .stage-nav-container > div {
        width: 100%;
        display: flex !important; /* Force display */
        visibility: visible !important; /* Force visibility */
        justify-content: center;
        flex-wrap: nowrap;
        gap: 6px;
        order: 1;
    }
    .stage-nav-container > div:first-child {
        order: 0; /* Top row - first 3 stages */
        display: flex !important; /* Ensure first row shows */
    }
    .wine-icon-container {
        order: 1; /* Middle - wine logo */
        width: 100%;
        display: flex !important;
        visibility: visible !important;
        justify-content: center;
        margin: 4px 0;
    }
    .stage-nav-container > div:last-child {
        order: 2; /* Bottom row - last 3 stages */
        display: flex !important; /* Ensure second row shows */
        visibility: visible !important;
    }
    .wine-icon-container img {
        width: 45px;
        height: 45px;
    }
    .stage-nav-button {
        min-width: 50px;
        max-width: none;
        padding: 6px 8px;
        font-size: calc(var(--font-size-base) * 0.68);
        flex: 1 1 calc(33.333% - 4px);
        border-radius: 8px;
        min-height: 44px; /* Ensure minimum touch target size on mobile */
        line-height: 1.2;
        text-align: center;
        white-space: normal;
        word-break: keep-all;
        overflow-wrap: normal;
    }

    .stage-nav-button.tight-hebrew {
        font-size: calc(var(--font-size-base) * 0.63);
    }
    .close-button {
        top: 20px;
        left: 20px;
    }
    
    /* Mobile portrait: 2 cards per row */
    .input-section {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        padding-top: 10px;
    }
    
    /* Smaller text in input groups for mobile */
    .input-group {
        padding: 10px;
    }
    
    .input-group label {
        font-size: calc(var(--font-size-base) * 0.78);
        margin-bottom: 4px;
    }
    
    .input-group h5 {
        font-size: calc(var(--font-size-base) * 0.85);
    }
    
    .input-group input,
    .input-group select,
    .input-group textarea {
        font-size: calc(var(--font-size-base) * 0.8);
        padding: 6px;
    }
    
    .input-group button {
        font-size: calc(var(--font-size-base) * 0.75);
        padding: 6px 10px;
        min-height: 38px;
    }
    
    /* Dashboard: Add metric button above indicators on mobile */
    .dashboard-section {
        display: grid !important;
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        align-items: center;
        padding: 8px 10px;
        gap: 4px;
    }
    
    .dashboard-collapse-btn {
    position: absolute;
    top: 6px;
    left: 10px;
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
}

.dashboard-collapse-btn i {
    transition: transform 0.3s ease;
}

.dashboard-section.collapsed-mobile .dashboard-collapse-btn i {
    transform: rotate(180deg);
}

.dashboard-section h2 {
        grid-column: 1 !important;
        grid-row: 2 !important;
        font-size: calc(var(--font-size-base) * 0.95);
        margin: 0;
        text-align: center;
        line-height: 1.4em;
    }
    
    .add-data-cube {
        grid-column: 1 !important;
        grid-row: 2 !important;
        width: calc(var(--font-size-base) * 1.4);
        height: calc(var(--font-size-base) * 1.4);
        border-radius: 50%;
        padding: 0;
        display: flex !important;
        align-items: center;
        justify-content: center;
        margin: 0;
        margin-right: auto;
        margin-left: 8px;
        flex-shrink: 0;
        justify-self: start;
    }
    
    .dashboard-grid {
        grid-column: 1 !important;
        grid-row: 3 !important;
    }

    .dashboard-collapse-btn {
        display: flex;
    }

    .dashboard-section.collapsed-mobile {
        transform: translateY(calc(100% - 42px));
        bottom: 10px;
        padding-top: 4px;
    }
    
    .add-data-cube span {
        display: none; /* Hide text on mobile */
    }
    
    .add-data-cube i {
        margin: 0;
        font-size: calc(var(--font-size-base) * 0.7);
    }
    
    .dashboard-grid {
        width: 100%;
        justify-content: center;
    }
    .dashboard-item {
        flex: 0 0 72px;
        min-width: 72px;
        max-width: 72px;
        padding: 4px 5px;
        min-height: 50px;
    }

    .stage-overview-container::before {
        display: none;
    }

    .mobile-stage-metric-separator {
        display: block;
    }
    
    .dashboard-item h3 {
        font-size: calc(var(--font-size-base) * 0.64);
        white-space: normal;
        word-break: break-word;
        overflow-wrap: anywhere;
        line-height: 1.2;
        max-width: 100%;
    }
    
    .dashboard-item p {
        font-size: calc(var(--font-size-base) * 0.88);
    }
    .card-fab {
        display: flex;
        align-items: center;
        justify-content: center;
        top: 35px;
        left: 15px;
        right: auto;
        bottom: auto;
        width: 42px;
        height: 42px;
        font-size: 18px;
    }
    
    /* Modal improvements for mobile */
    .modal {
        padding: 10px;
        z-index: 1000; /* Ensure modals are above dashboard */
    }
    
    .modal-content {
        width: 95%;
        max-width: 95vw;
        max-height: 85vh;
        padding: 20px 15px;
        overflow-y: auto;
    }
    
    .modal-content h3 {
        font-size: calc(var(--font-size-base) * 1.2);
        margin-bottom: 15px;
        padding-right: 30px; /* Space for close button */
    }
    
    .modal-content label {
        font-size: calc(var(--font-size-base) * 0.9);
    }
    
    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content input[type="email"],
    .modal-content input[type="password"],
    .modal-content input[type="datetime-local"],
    .modal-content textarea,
    .modal-content select {
        width: 100%;
        font-size: calc(var(--font-size-base) * 0.95);
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
    }
    
    .modal-content button {
        font-size: calc(var(--font-size-base) * 0.95);
        padding: 12px 16px;
        min-height: 44px; /* Touch-friendly */
        width: 100%; /* Full width buttons on mobile */
        margin-bottom: 8px;
    }
    
    .modal-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }
    
    .modal-actions button {
        width: 100%;
    }
    
    /* Project modal specific */
    .project-modal-content {
        padding: 25px 15px;
    }
    
    .project-modal-content input {
        width: 100%;
        box-sizing: border-box;
    }
    
    /* Login modal adjustments for mobile */
    .login-modal-content {
        width: 90%;
        max-width: 90vw;
        padding: 30px 20px;
    }
    
    .login-modal-content .google-btn {
        width: 100%;
        justify-content: center;
    }
    
    /* Show email/password login on mobile as well */
    .desktop-only-login {
        display: flex !important;
    }
    
    /* Stage overview section - mobile specific styling */
    .stage-overview-container {
        margin-top: 15px;
        margin-bottom: 10px;
        padding: 15px 10px;
        background: linear-gradient(135deg, var(--card-background), #f0f0f0);
        border-radius: 12px;
        border: 2px solid var(--primary-color);
    }
    
    .stage-overview-container h4 {
        font-size: calc(var(--font-size-base) * 1.1);
        margin-bottom: 15px;
        text-align: center;
        color: var(--primary-color);
    }
    
    .stage-overview-empty-state {
        text-align: center;
        color: var(--light-text-color);
        font-size: calc(var(--font-size-base) * 0.9);
        padding: 15px;
    }
    
    .stage-overview-empty-state i {
        margin-left: 8px;
    }
    .step-cards-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
    }
    
    .step-preview-card {
        padding: 10px;
        border-radius: 10px;
    }
    
    .step-preview-card h5 {
        font-size: calc(var(--font-size-base) * 0.9);
        margin-bottom: 6px;
    }
    
    .step-preview-card p {
        font-size: calc(var(--font-size-base) * 0.75);
        margin: 2px 0;
    }
    
    /* Show mobile description, hide desktop description */
    .login-description-mobile {
        display: block !important;
    }
    
    .login-description-desktop {
        display: none !important;
    }
}

/* Further reduce font size on very small screens */
@media (max-width: 380px) {
    :root {
        --font-size-base: 15px;
    }
}

/* Mobile landscape mode */
@media (max-width: 768px) and (orientation: landscape) {
    .project-details-card {
        left: -280px;
    }
    
    .pull-handle {
        display: none; /* Floating button handles toggling */
    }
    .card-fab {
        top: 50%;
        left: 15px;
        right: auto;
        bottom: auto;
        transform: translateY(-50%);
    }
}

/* Base styles for all screen sizes */
:root {
    --primary-color: #65162f;
    --secondary-color: #7f1d3a;
    --accent-color: #D4AF37; /* Golden accent */
    --background-color: #FAF7F2;
    --background-color-mid: #F5EEE6;
    --background-color-end: #E8DFD5;
    --card-background: #ffffff;
    --text-color: #2C2C2C;
    --light-text-color: #5A5A5A;
    --border-color: #E8DFD5;
    --shadow: 0 4px 20px rgba(123, 31, 61, 0.08);
    --border-radius: 16px;
    --animation-speed: 0.4s;
    --graph-line-color: #DAA520;
    --graph-area-color: rgba(218, 165, 32, 0.2);
    --graph-point-color: #B8860B;
    --graph-average-color: #6B8E23;
    --top-section-background: linear-gradient(135deg, #FFF8E1, #F5F5DC);
    --top-section-border: #D4C6B1;
    --dark-background-color: #1A1A1D;
    --dark-background-color-mid: #0F0F11;
    --dark-background-color-end: #000000;
    --dark-card-background: #2A2A2E;
    --dark-text-color: #E8DFD5;
    --dark-light-text-color: #B8AFA0;
    --dark-border-color: #3A3A40;
    --dark-shadow: 0 4px 24px rgba(0, 0, 0, 0.6);
    --dark-primary-color: #a12c4a;
    --dark-secondary-color: #9D2449;
    --dark-accent-color: #E5C158; /* Golden accent for dark mode */
    --dark-graph-line-color: #C73659;
    --dark-graph-area-color: rgba(255, 215, 0, 0.2);
    --font-size-base: 16px;
    --mobile-add-button-size: 42px;
    --card-width-desktop: 205px;
    --card-max-height-desktop: 85vh;
}

* {
    box-sizing: border-box;
}

/* Reset and ensure all buttons and inputs have proper styling */
button {
    font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
    cursor: pointer;
    border: none;
    outline: none;
}

input, textarea, select {
    font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
    outline: none;
}

button:focus, input:focus, textarea:focus, select:focus {
    outline: 2px solid var(--primary-color);
    outline-offset: 2px;
}

button, .stage-nav-button, .add-data-cube, .finance-item-actions button {
    touch-action: manipulation;
}

body.dark-mode button:focus, 
body.dark-mode input:focus, 
body.dark-mode textarea:focus, 
body.dark-mode select:focus {
    outline-color: var(--dark-primary-color);
}

/* Checkbox styling */
input[type="checkbox"]:not(.switch input) {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--card-background);
    cursor: pointer;
    position: relative;
    vertical-align: middle;
    margin-left: 5px;
    transition: all 0.3s ease;
}

input[type="checkbox"]:not(.switch input):checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

input[type="checkbox"]:not(.switch input):checked::after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    font-weight: bold;
}

body.dark-mode input[type="checkbox"]:not(.switch input) {
    border-color: var(--dark-border-color);
    background-color: var(--dark-card-background);
}

body.dark-mode input[type="checkbox"]:not(.switch input):checked {
    background-color: var(--dark-primary-color);
    border-color: var(--dark-primary-color);
}

/* Label styling for checkboxes */
label {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
}

body {
    font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
    font-weight: 400;
    font-size: var(--font-size-base);
    margin: 0;
    padding: 0;
    padding-bottom: 180px;
    background: linear-gradient(135deg, var(--background-color) 0%, var(--background-color-mid) 50%, var(--background-color-end) 100%);
    background-attachment: fixed;
    color: var(--text-color);
    direction: rtl;
    line-height: 1.6;
    overflow-x: hidden;
    transition: all var(--animation-speed);
}

/* Prevent all animations and transitions on page load */
body.preload * {
    animation-duration: 0s !important;
    animation-delay: 0s !important;
    transition-duration: 0s !important;
    transition-delay: 0s !important;
}

/* Apply fade in animation only after page is loaded */
body.loaded {
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInRight {
    from { 
        opacity: 0; 
        transform: translateX(100px);
    }
    to { 
        opacity: 1; 
        transform: translateX(0);
    }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

body.dark-mode {
    background: linear-gradient(135deg, var(--dark-background-color) 0%, var(--dark-background-color-mid) 50%, var(--dark-background-color-end) 100%);
    background-attachment: fixed;
    color: var(--dark-text-color);
}

h1, h2 {
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    font-size: calc(var(--font-size-base) * 1.5);
    color: var(--primary-color);
    margin-bottom: 20px;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    transition: color var(--animation-speed);
}

h3, h4 {
    font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
    font-weight: 700;
    font-size: calc(var(--font-size-base) * 1.2);
    color: var(--secondary-color);
    margin-bottom: 15px;
}

p, span, div {
    font-family: 'Noto Sans Hebrew', 'Heebo', sans-serif;
    font-weight: 300;
}

.top-section-wrapper {
    background: var(--top-section-background);
    padding-top: 5px;
    padding-left: 25px;
    padding-right: 25px;
    border-bottom-left-radius: var(--border-radius);
    border-bottom-right-radius: var(--border-radius);
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    transition: all var(--animation-speed);
    border-bottom: 1px solid var(--top-section-border);
    animation: slideInDown 0.5s ease-out;
}

@keyframes slideInDown {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

body.dark-mode .top-section-wrapper {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
    border-color: var(--dark-border-color);
}

.container {
    max-width: 900px;
    margin: 20px auto;
    background-color: var(--card-background);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 30px;
    animation: fadeInUp 0.5s ease-out;
    transition: all var(--animation-speed);
    position: relative;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

body.dark-mode .container {
    background-color: var(--dark-card-background);
}

.project-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    gap: 5px;
    padding-top: 5px;
}

#currentProjectName {
    font-family: 'Playfair Display', serif;
    font-size: calc(var(--font-size-base) * 1.5);
    color: var(--primary-color);
    font-weight: 700;
    cursor: pointer;
    transition: color var(--animation-speed);
    margin: 0;
    text-align: center;
}

#currentProjectName:hover {
    text-decoration: underline;
    color: var(--secondary-color);
}

#editProjectNameInput {
    font-family: 'Noto Sans Hebrew', sans-serif;
    font-size: calc(var(--font-size-base) * 1.2);
    padding: 5px 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--card-background);
    color: var(--text-color);
    transition: all var(--animation-speed);
    text-align: center;
    max-width: 80%;
}

.stage-nav-container {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap; /* Changed from nowrap to wrap to allow all categories to display */
    overflow-x: visible; /* Changed from auto to visible to show all categories */
    gap: 6px;
    margin-top: 12px;
    margin-bottom: 16px;
    padding: 8px;
    background: linear-gradient(135deg, #F8F0E3, #E6D7C3);
    border-radius: var(--border-radius);
    transition: all var(--animation-speed);
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

body.dark-mode .stage-nav-container {
    background: linear-gradient(135deg, var(--dark-card-background), #3a3a3a);
}

.stage-nav-button {
    background-color: var(--light-text-color);
    color: white;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.85);
    font-weight: 700;
    transition: all 0.3s ease, transform 0.2s ease;
    min-width: 90px;
    text-align: center;
    position: relative;
    overflow: hidden;
    /* Ensure touch events work on mobile */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

.stage-nav-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.stage-nav-button:hover::before {
    left: 100%;
}

.stage-nav-button:hover {
    background-color: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(123, 31, 61, 0.25);
}

.stage-nav-button.active {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(123, 31, 61, 0.35);
}

.shared-access-notice {
    display: none;
    padding: 8px 12px;
    margin-top: 6px;
    border-radius: 10px;
    background: #f0f4ff;
    color: #1f3b73;
    font-size: calc(var(--font-size-base) * 0.85);
    border: 1px solid rgba(0,0,0,0.06);
}

.shared-access-notice.view-only {
    background: #fff5f5;
    color: #8b0000;
    border-color: rgba(139,0,0,0.15);
}

body.view-only .editable,
body.view-only .add-data-cube,
body.view-only .add-project-btn,
body.view-only .finance-item-actions button,
body.view-only .finance-input-buttons button,
body.view-only .add-income-btn,
body.view-only .add-expense-btn,
body.view-only .add-custom-property-btn,
body.view-only .delete-custom-prop-btn {
    pointer-events: none;
    opacity: 0.5;
}

body.dark-mode .stage-nav-button {
    background-color: var(--dark-secondary-color);
    border-color: var(--dark-border-color);
    color: var(--dark-text-color);
}

body.dark-mode .stage-nav-button.active {
    background-color: var(--dark-primary-color);
    border-color: var(--dark-primary-color);
}

body.dark-mode .stage-nav-button:hover {
    background-color: var(--dark-primary-color);
}

.wine-icon-container {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 15px;
}

.wine-icon-container img {
    width: 70px;
    height: auto;
    vertical-align: middle;
    transition: transform 0.3s ease;
}

.wine-icon-container img:hover {
    transform: scale(1.1) rotate(5deg);
}


.dashboard-collapse-btn {
    position: absolute;
    top: 6px;
    left: 10px;
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.2);
    color: #fff;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 2;
}

.dashboard-collapse-btn i {
    transition: transform 0.3s ease;
}

.dashboard-section.collapsed-mobile .dashboard-collapse-btn i {
    transform: rotate(180deg);
}

.dashboard-section {
    position: fixed;
    bottom: 58px;
    left: 0;
    width: 100%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-top-left-radius: 30px;
    border-top-right-radius: 30px;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.2);
    padding: 10px 15px;
    color: white;
    text-align: center;
    transition: all var(--animation-speed);
    z-index: 999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.dashboard-section h2 {
    text-align: center;
    color: var(--accent-color);
    margin-top: 0;
    margin-bottom: 5px;
    font-family: 'Playfair Display', serif;
    font-size: calc(var(--font-size-base) * 1.0);
    font-weight: 700;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    transition: color var(--animation-speed);
}

.dashboard-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    width: 100%;
    max-width: none;
}

.dashboard-item {
    background-color: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--border-radius);
    padding: 10px 12px;
    text-align: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
    flex: 0 0 110px;
    min-width: 110px;
    max-width: 110px;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    min-height: 68px;
}

.dashboard-item:hover {
    transform: translateY(-5px) scale(1.02);
    background-color: rgba(255, 255, 255, 0.25);
}

.dashboard-item h3 {
    margin-top: 0;
    margin-bottom: 2px;
    color: var(--accent-color);
    font-family: 'Noto Sans Hebrew', sans-serif;
    font-size: calc(var(--font-size-base) * 0.62);
    font-weight: 700;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    line-height: 1.2;
    transition: color var(--animation-speed);
}

.dashboard-item p {
    font-size: calc(var(--font-size-base) * 0.9);
    font-weight: 700;
    color: white;
    margin: 0;
    font-family: 'Playfair Display', serif;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

body.dark-mode .dashboard-item h3 {
    color: var(--dark-text-color);
}

.input-section {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 220px));
    justify-content: center;
    gap: 25px;
    margin-bottom: 15px;
    padding-top: 20px;
}

.input-group {
    background: linear-gradient(135deg, #fdfdfd, #f0f0f0);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease, all var(--animation-speed);
}

.input-group:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

body.dark-mode .input-group {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
    border-color: var(--dark-border-color);
}

.input-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 700;
    color: var(--light-text-color);
    font-size: calc(var(--font-size-base) * 0.85);
    transition: color var(--animation-speed);
}

.input-group input[type="number"], .input-group input[type="text"], .input-group select, .input-group textarea {
    width: calc(100% - 16px);
    padding: 6px 8px;
    margin-bottom: 8px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: calc(var(--font-size-base) * 0.85);
    color: var(--text-color);
    transition: all 0.3s ease, background-color var(--animation-speed), color var(--animation-speed);
    background-color: var(--card-background);
}

body.dark-mode .input-group input[type="number"], body.dark-mode .input-group input[type="text"], body.dark-mode .input-group select, body.dark-mode .input-group textarea {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.input-group input[type="number"]:focus, .input-group input[type="text"]:focus, .input-group select:focus, .input-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.2);
}

.input-group button {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.85);
    font-weight: 400; /* Thinner font */
    transition: all 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    align-self: flex-end;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 36px; /* Minimum touch target size */
}
.delete-metric-btn {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    align-self: flex-start;
    margin-top: 5px;
}
.delete-metric-btn:hover,
.delete-metric-btn:active {
    background: linear-gradient(135deg, #d32f2f, #b71c1c);
}

.input-group button:hover,
.input-group button:active {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.graph-container {
    flex-grow: 1;
    height: 40px;
    background-color: #f0f0f0;
    border-radius: 8px;
    margin: 0 20px;
    position: relative;
    overflow: hidden;
    border: 1px solid #ddd;
    transition: background-color var(--animation-speed), border-color var(--animation-speed);
}

.graph-bar {
    height: 100%;
    position: absolute;
    top: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: calc(var(--font-size-base) * 0.9);
    font-weight: 700;
    transition: all var(--animation-speed) ease-out;
    background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
}

.graph-bar.positive {
    background: linear-gradient(90deg, #4CAF50, #66BB6A);
}

.graph-bar.negative {
    background: linear-gradient(90deg, #F44336, #E57373);
}

.graph-scale {
    position: absolute;
    height: 100%;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 5px;
    font-size: calc(var(--font-size-base) * 0.7);
    color: #888;
    z-index: 1;
    transition: color var(--animation-speed);
}

.graph-scale span {
    min-width: unset;
    font-weight: normal;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    animation: fadeInModal 0.3s ease-out;
}

/* Higher z-index for modals that open on top of other modals */
#newProjectModal,
#customPropertyModal,
#addMetricModal,
#financeEditModal,
#datePickerModal {
    z-index: 1100;
}

@keyframes fadeInModal {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: linear-gradient(135deg, var(--card-background), #f9f9f9);
    margin: auto;
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    width: 80%;
    max-width: 1000px;
    animation: slideInModal 0.4s ease-out;
    position: relative;
    display: flex;
    flex-direction: column;
    max-height: 90vh;
    transition: all var(--animation-speed);
}

@keyframes slideInModal {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

body.dark-mode .modal-content {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
}

.close-button {
    color: #aaa;
    float: left;
    font-size: calc(var(--font-size-base) * 1.8);
    font-weight: bold;
    transition: color 0.3s ease;
    position: absolute;
    top: 5px;
    left: 10px;
    right: auto;
}

.close-button:hover, .close-button:focus {
    color: var(--primary-color);
    text-decoration: none;
    cursor: pointer;
}

.modal-content h3 {
    text-align: center;
    color: var(--primary-color);
    font-family: 'Playfair Display', serif;
    font-size: calc(var(--font-size-base) * 1.5);
    margin-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 10px;
    transition: color var(--animation-speed);
}
.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 10px;
}

.custom-property-modal-content {
    max-width: 420px;
    width: min(92vw, 420px);
    border: 1px solid rgba(101, 22, 47, 0.2);
}

.custom-property-modal-content .modal-actions {
    justify-content: stretch;
}

.custom-property-modal-content .modal-actions button {
    flex: 1;
    min-height: 42px;
    border-radius: 10px;
    font-weight: 700;
}

.custom-property-modal-content input {
    border-radius: 10px;
}

.modal-graph-container {
    width: 100%;
    height: 350px;
    margin: 20px auto 30px auto;
    background-color: #f0f0f0;
    border-radius: 8px;
    border: 1px solid #ddd;
    position: relative;
    overflow: hidden;
    transition: background-color var(--animation-speed), border-color var(--animation-speed);
    display: flex;
    justify-content: center;
}

body.dark-mode .modal-graph-container {
    background-color: var(--dark-card-background);
    border-color: var(--dark-border-color);
}

.modal-graph-svg {
    width: 100%;
    height: 100%;
    overflow: visible;
}

.modal-graph-line-path {
    fill: none;
    stroke: var(--graph-line-color);
    stroke-width: 3;
    transition: stroke-dasharray 1s ease-out;
}

.modal-graph-area-path {
    fill: var(--graph-area-color);
    opacity: 0.8;
    transition: fill 0.3s ease-out;
}

.modal-graph-point {
    fill: var(--graph-point-color);
    stroke: #fff;
    stroke-width: 2;
    cursor: pointer;
    transition: r 0.2s ease-out, fill 0.3s ease-out;
}

.modal-graph-point:hover {
    r: 7;
}

.modal-graph-label-x {
    font-size: calc(var(--font-size-base) * 0.6);
    fill: #888;
    text-anchor: middle;
    transition: fill var(--animation-speed);
}

.modal-graph-label-y {
    font-size: calc(var(--font-size-base) * 0.6);
    fill: #888;
    text-anchor: end;
    transition: fill var(--animation-speed);
}

.modal-graph-grid-line {
    stroke: #ccc;
    stroke-dasharray: 2,2;
    stroke-width: 0.5;
    transition: stroke var(--animation-speed);
}

.graph-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
}

.graph-controls button {
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    border: none;
    border-radius: 5px;
    padding: 8px 12px; /* Increased padding for better touch */
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.8);
    font-weight: 400; /* Thinner font */
    transition: background 0.3s ease;
    color: white;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
    min-width: 44px;
}

.graph-controls button:hover,
.graph-controls button:active {
    background: linear-gradient(135deg, #FFB366, #FFC999);
}

.history-list {
    list-style-type: none;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    direction: rtl;
    margin-top: 20px;
}

.history-list li {
    background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: calc(var(--font-size-base) * 1);
    color: var(--text-color);
    box-shadow: 0 1px 4px rgba(0,0,0,0.03);
    position: relative;
    transition: all var(--animation-speed);
}

.history-entry-main {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    flex: 1;
    min-width: 0;
}

.history-entry-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
}

.history-upload-btn {
    background: linear-gradient(135deg, #1e88e5, #1565c0);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.72);
}

.history-upload-btn:hover {
    background: linear-gradient(135deg, #1565c0, #0d47a1);
}

body.dark-mode .history-list li {
    background: linear-gradient(135deg, #3a3a5e, #2a2a2a);
    border-color: var(--dark-border-color);
    color: var(--dark-text-color);
}

.history-list li strong {
    color: var(--secondary-color);
    font-size: calc(var(--font-size-base) * 1.1);
    flex-basis: 30%;
    text-align: right;
    transition: color var(--animation-speed);
}

.history-list li span.timestamp {
    color: var(--light-text-color);
    font-size: calc(var(--font-size-base) * 0.8);
    flex-basis: 60%;
    text-align: left;
    transition: color var(--animation-speed);
}

.history-list li .undo-button {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.7);
    transition: background 0.3s ease;
    margin-right: 10px;
    flex-shrink: 0;
}

.history-list li .undo-button:hover {
    background: linear-gradient(135deg, #d32f2f, #b71c1c);
}

.hamburger-menu-btn {
    position: fixed;
    top: 35px;
    right: 20px;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: var(--border-radius);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    z-index: 1100;
    box-shadow: var(--shadow);
    transition: all 0.3s ease, transform 0.2s ease;
}

.hamburger-menu-btn:hover {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: scale(1.05);
}

.hamburger-menu-btn span {
    display: block;
    width: 25px;
    height: 3px;
    background-color: white;
    border-radius: 2px;
    transition: all 0.3s ease;
}

.hamburger-menu-btn.open span:nth-child(1) {
    transform: translateY(9px) rotate(45deg);
}

.hamburger-menu-btn.open span:nth-child(2) {
    opacity: 0;
}

.hamburger-menu-btn.open span:nth-child(3) {
    transform: translateY(-9px) rotate(-45deg);
}
.card-fab {
    position: fixed;
    left: 15px;
    bottom: 100px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    box-shadow: 0 4px 16px rgba(123, 31, 61, 0.4);
    cursor: pointer;
    z-index: 950;
    display: none;
    font-size: 20px;
    transition: all 0.3s ease;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
}
.card-fab-icon {
    width: 36px;
    height: 36px;
    object-fit: contain;
}
.card-fab:hover,
.card-fab:active {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(123, 31, 61, 0.5);
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
}
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
}

.sidebar {
    position: fixed;
    top: 0;
    right: -300px;
    width: 280px;
    height: 100%;
    background: linear-gradient(135deg, var(--card-background), #f0f0f0);
    box-shadow: -6px 0 16px rgba(0,0,0,0.2);
    z-index: 1050;
    transition: right 0.4s ease-out;
    padding-top: 80px;
    display: flex;
    flex-direction: column;
    border-left: 1px solid var(--border-color);
    overflow-y: auto;
}

.sidebar-toggle-handle {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: -35px;
    width: 35px;
    height: 70px;
    background: var(--primary-color);
    border-radius: 10px 0 0 10px;
    cursor: pointer;
    z-index: 1051;
    display: flex; /* Changed from none to flex as default for mobile-first */
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    box-shadow: -2px 0 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.sidebar-toggle-handle:hover {
    background: var(--secondary-color);
    left: -37px;
}

.sidebar-toggle-handle:active {
    background: var(--secondary-color);
}

body.dark-mode .sidebar-toggle-handle {
    background: var(--dark-primary-color);
}

body.dark-mode .sidebar-toggle-handle:hover,
body.dark-mode .sidebar-toggle-handle:active {
    background: var(--dark-secondary-color);
}

body.dark-mode .sidebar {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
    box-shadow: -6px 0 16px rgba(0, 0, 0, 0.5);
    border-color: var(--dark-border-color);
}

.sidebar.open {
    right: 0;
}

.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    z-index: 1040;
}

.sidebar.open + .sidebar-overlay {
    display: block;
}

.sidebar ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.sidebar ul li {
    margin-bottom: 5px;
}

.sidebar ul li a, .sidebar ul li button {
    display: block;
    padding: 15px 25px;
    color: var(--text-color);
    text-decoration: none;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    transition: all 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    text-align: right;
    border: none;
    background: none;
    width: 100%;
    cursor: pointer;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

body.dark-mode .sidebar ul li a, body.dark-mode .sidebar ul li button {
    color: var(--dark-text-color);
}

.sidebar ul li a:hover, .sidebar ul li button:hover {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
}

body.dark-mode .sidebar ul li a:hover, body.dark-mode .sidebar ul li button:hover {
    background: linear-gradient(135deg, var(--dark-secondary-color), var(--dark-primary-color));
    color: white;
}

.sidebar .divider {
    height: 1px;
    background-color: var(--border-color);
    margin: 15px 20px;
    transition: background-color var(--animation-speed);
}

/* Inbox badge styles */
.inbox-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    margin-right: 8px;
    background: linear-gradient(135deg, #F44336, #D32F2F);
    color: white;
    font-size: calc(var(--font-size-base) * 0.75);
    font-weight: 700;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(244, 67, 54, 0.4);
    animation: pulseBadge 2s infinite;
}

@keyframes pulseBadge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

body.dark-mode .inbox-badge {
    background: linear-gradient(135deg, #EF5350, #E53935);
}

body.dark-mode .sidebar .divider {
    background-color: var(--dark-border-color);
}

.sidebar-footer {
    margin-top: auto;
    padding: 20px 25px;
    border-top: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: border-color var(--animation-speed);
}

body.dark-mode .sidebar-footer {
    border-color: var(--dark-border-color);
}

.theme-switch {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--light-text-color);
    transition: color var(--animation-speed);
}

.switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 20px;
}

body.dark-mode .slider {
    background-color: #555;
}

.slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-color);
}

body.dark-mode input:checked + .slider {
    background-color: var(--dark-primary-color);
}

input:focus + .slider {
    box-shadow: 0 0 1px var(--primary-color);
}

input:checked + .slider:before {
    transform: translateX(20px);
}

.zoom-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.zoom-controls button {
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    cursor: pointer;
    font-size: 18px;
    font-weight: 400; /* Thinner font */
    transition: all 0.3s ease;
    color: white;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
}

.zoom-controls button:hover,
.zoom-controls button:active {
    background: linear-gradient(135deg, #FFB366, #FFC999);
    transform: scale(1.1);
}

.project-modal-content {
    padding: 30px;
    text-align: right;
}

.project-modal-content h3 {
    text-align: center;
}

.project-filter {
    margin-bottom: 20px;
    text-align: center;
}

.project-filter select {
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--card-background);
    color: var(--text-color);
    font-size: calc(var(--font-size-base) * 0.9);
}

body.dark-mode .project-filter select {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.project-list {
    list-style: none;
    padding: 0;
    max-height: 400px;
    overflow-y: auto;
}

.project-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: calc(var(--font-size-base) * 1);
    position: relative;
}

body.dark-mode .project-list li {
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
    color: var(--dark-text-color);
}

.project-list li:hover {
    background: linear-gradient(135deg, #e0e0e0, #d0d0d0);
    transform: translateY(-2px);
}

body.dark-mode .project-list li:hover {
    background: linear-gradient(135deg, #3a3a3a, #2a3a3a);
}

.project-list li.active-project {
    background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
    color: white;
    font-weight: 700;
}

.project-list li.active-project:hover {
    background: linear-gradient(135deg, var(--primary-color), #8B0000);
}

.project-list li.closed {
    opacity: 0.6;
    background: linear-gradient(135deg, #ccc, #aaa);
}

.project-list li.closed::after {
    content: 'סגור';
    position: absolute;
    top: 5px;
    left: 5px;
    background: #f44336;
    color: white;
    padding: 2px 5px;
    border-radius: 4px;
    font-size: calc(var(--font-size-base) * 0.7);
}

.project-actions {
    display: flex;
    gap: 5px;
}

.project-actions button {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    margin-right: 10px;
    font-size: calc(var(--font-size-base) * 0.9);
    transition: color 0.2s ease;
}

.project-actions .select-project-btn {
    background: linear-gradient(135deg, #1E88E5, #42A5F5);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    margin-right: 0;
}

.project-actions .select-project-btn:hover {
    color: #fff;
    text-decoration: none;
    background: linear-gradient(135deg, #1976D2, #1E88E5);
}

.project-actions .current-project-btn {
    background: linear-gradient(135deg, #2E7D32, #66BB6A);
}

.project-actions button:hover {
    color: var(--secondary-color);
    text-decoration: underline;
}

.project-actions button.delete {
    color: #f44336;
}

.project-actions button.delete:hover {
    color: #d32f2f;
}

.project-actions button.close-project {
    color: #ff9800;
}

.project-actions button.close-project:hover {
    color: #f57c00;
}

.add-project-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 20px;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

.add-project-btn:hover,
.add-project-btn:active {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
}

.finance-modal-content {
    padding: 30px;
    text-align: right;
    max-height: 80vh;
    overflow-y: auto;
}

.finance-modal-content h3 {
    text-align: center;
}

.finance-input-group {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: linear-gradient(135deg, #fcfcfc, #f0f0f0);
    transition: all var(--animation-speed);
}

body.dark-mode .finance-input-group {
    background: linear-gradient(135deg, #242424, #1a1a1a);
    border-color: #444;
}

.finance-input-group label {
    font-weight: 700;
    color: var(--light-text-color);
    transition: color var(--animation-speed);
}

.finance-input-group input, .finance-input-group textarea {
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    background-color: var(--card-background);
    color: var(--text-color);
    transition: all var(--animation-speed);
}

body.dark-mode .finance-input-group input, body.dark-mode .finance-input-group textarea {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.finance-input-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.finance-input-buttons button {
    flex: 1;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    transition: all 0.3s ease;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

.finance-input-buttons .add-income-btn {
    background: linear-gradient(135deg, #4CAF50, #66BB6A);
    font-weight: 400; /* Thinner font */
}

.finance-input-buttons .add-income-btn:hover,
.finance-input-buttons .add-income-btn:active {
    background: linear-gradient(135deg, #43a047, #4CAF50);
}

.finance-input-buttons .add-expense-btn {
    background: linear-gradient(135deg, #F44336, #E57373);
    font-weight: 400; /* Thinner font */
}

.finance-input-buttons .add-expense-btn:hover,
.finance-input-buttons .add-expense-btn:active {
    background: linear-gradient(135deg, #d32f2f, #F44336);
}

.finance-list {
    list-style: none;
    padding: 0;
    max-height: 250px;
    overflow-y: auto;
    margin-bottom: 15px;
}

.finance-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    transition: all var(--animation-speed);
}

body.dark-mode .finance-list li {
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
    border-color: #444;
    color: var(--dark-text-color);
}

.finance-item-details {
    flex-grow: 1;
}

.finance-item-details .amount {
    font-weight: 700;
}

.finance-item-details .amount.income {
    color: #4CAF50;
}

.finance-item-details .amount.expense {
    color: #F44336;
}

body.dark-mode .finance-item-details .amount.income {
    color: #8BC34A;
}

body.dark-mode .finance-item-details .amount.expense {
    color: #EF5350;
}

.finance-item-actions button {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    margin-right: 8px;
    font-size: calc(var(--font-size-base) * 0.8);
    transition: color 0.2s ease;
}

.finance-item-actions button:hover {
    color: var(--secondary-color);
    text-decoration: underline;
}

.finance-item-actions button.delete {
    color: #f44336;
}

.finance-item-actions button.delete:hover {
    color: #d32f2f;
}

.finance-balance-total {
    text-align: center;
    font-size: calc(var(--font-size-base) * 1.2);
    font-weight: 700;
    padding-top: 15px;
    border-top: 1px solid var(--border-color);
    color: var(--primary-color);
    transition: all var(--animation-speed);
}

body.dark-mode .finance-balance-total {
    border-color: var(--dark-border-color);
    color: var(--dark-primary-color);
}

.finance-balance-total span {
    color: var(--secondary-color);
    margin-right: 5px;
    transition: color var(--animation-speed);
}

.finance-balance-total span.positive {
    color: #4CAF50;
}

.finance-balance-total span.negative {
    color: #F44336;
}

body.dark-mode .finance-balance-total span.positive {
    color: #8BC34A;
}

body.dark-mode .finance-balance-total span.negative {
    color: #EF5350;
}

.current-project-finance-report-modal .modal-content {
    max-width: 600px;
}

.current-project-finance-report-modal h3 {
    margin-bottom: 30px;
}

.current-project-finance-report-summary {
    margin-bottom: 20px;
    font-size: calc(var(--font-size-base) * 1);
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
    transition: border-color var(--animation-speed);
}

body.dark-mode .current-project-finance-report-summary {
    border-color: var(--dark-border-color);
}

.current-project-finance-report-summary div {
    padding: 5px 0;
    font-weight: 700;
}

.current-project-finance-report-summary .total-income {
    color: #4CAF50;
}

.current-project-finance-report-summary .total-expense {
    color: #F44336;
}

.current-project-finance-report-summary .total-balance {
    color: var(--secondary-color);
}

body.dark-mode .current-project-finance-report-summary .total-income {
    color: #8BC34A;
}

body.dark-mode .current-project-finance-report-summary .total-expense {
    color: #EF5350;
}

body.dark-mode .current-project-finance-report-summary .total-balance {
    color: var(--dark-primary-color);
}

.current-project-finance-report-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.current-project-finance-report-table th, .current-project-finance-report-table td {
    border: 1px solid var(--border-color);
    padding: 8px;
    text-align: center;
    transition: border-color var(--animation-speed);
}

.current-project-finance-report-table th {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
}

body.dark-mode .current-project-finance-report-table th, body.dark-mode .current-project-finance-report-table td {
    border-color: var(--dark-border-color);
}

.global-finance-modal-content {
    padding: 30px;
    text-align: right;
}

.global-finance-modal-content h3 {
    text-align: center;
}

@media (min-width: 1024px) {
    .project-modal-content,
    .finance-modal-content,
    .global-finance-modal-content {
        width: min(760px, 88vw);
        max-width: 760px;
        max-height: 78vh;
    }
}

.global-finance-report-summary {
    margin-bottom: 20px;
    font-size: calc(var(--font-size-base) * 1);
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
    transition: all var(--animation-speed);
}

body.dark-mode .global-finance-report-summary {
    border-color: var(--dark-border-color);
}

.global-finance-report-summary div {
    padding: 5px 0;
    font-weight: 700;
}

.global-finance-report-summary .total-income {
    color: #4CAF50;
}

.global-finance-report-summary .total-expense {
    color: #F44336;
}

.global-finance-report-summary .total-balance {
    color: var(--secondary-color);
}

body.dark-mode .global-finance-report-summary .total-income {
    color: #8BC34A;
}

body.dark-mode .global-finance-report-summary .total-expense {
    color: #EF5350;
}

body.dark-mode .global-finance-report-summary .total-balance {
    color: var(--dark-primary-color);
}

.global-finance-project-section {
    margin-bottom: 20px;
    background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 15px;
    transition: all var(--animation-speed);
}

body.dark-mode .global-finance-project-section {
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
    border-color: #444;
}

.global-finance-project-section h4 {
    color: var(--primary-color);
    margin-top: 0;
    margin-bottom: 10px;
    font-size: calc(var(--font-size-base) * 1.1);
    transition: color var(--animation-speed);
}

.global-finance-project-section p {
    margin: 5px 0;
    font-size: calc(var(--font-size-base) * 0.9);
}

.global-finance-project-section .project-balance {
    font-weight: 700;
}

.global-finance-project-section .project-balance.positive {
    color: #4CAF50;
}

.global-finance-project-section .project-balance.negative {
    color: #F44336;
}

body.dark-mode .global-finance-project-section .project-balance.positive {
    color: #8BC34A;
}

body.dark-mode .global-finance-project-section .project-balance.negative {
    color: #EF5350;
}

.stage-overview-container {
    margin-bottom: 15px;
    position: relative;
}

.stage-overview-container h4 {
    text-align: center;
    color: var(--secondary-color);
    margin-bottom: 20px;
    font-family: 'Playfair Display', serif;
    font-size: calc(var(--font-size-base) * 1.3);
    font-weight: 700;
    transition: color var(--animation-speed);
}

.stage-overview-empty-state {
    text-align: center;
    color: var(--light-text-color);
    font-size: calc(var(--font-size-base) * 0.95);
    padding: 20px 15px;
    line-height: 1.6;
}

.stage-overview-empty-state i {
    margin-left: 8px;
    color: var(--primary-color);
}

body.dark-mode .stage-overview-empty-state {
    color: var(--dark-light-text-color);
}

body.dark-mode .stage-overview-empty-state i {
    color: var(--dark-primary-color);
}

.step-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.step-preview-card {
    background: linear-gradient(135deg, var(--card-background), #f9f9f9);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 10px 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
}

.step-preview-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.step-preview-card h5 {
    margin-top: 0;
    margin-bottom: 8px;
    color: var(--primary-color);
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    transition: color var(--animation-speed);
}

.step-preview-card p {
    margin: 3px 0;
    font-size: calc(var(--font-size-base) * 0.8);
    color: var(--text-color);
    transition: color var(--animation-speed);
}

.step-preview-card .summary-value {
    font-weight: 700;
    color: var(--secondary-color);
    margin-right: 5px;
    transition: color var(--animation-speed);
}

body.dark-mode .stage-overview-container {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
    border-color: var(--dark-primary-color);
}

body.dark-mode .stage-overview-container h4 {
    color: var(--dark-primary-color);
}

body.dark-mode .step-preview-card {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
    border-color: var(--dark-border-color);
}

body.dark-mode .step-preview-card h5 {
    color: var(--dark-primary-color);
}

body.dark-mode .step-preview-card p {
    color: var(--dark-text-color);
}

body.dark-mode .step-preview-card .summary-value {
    color: var(--dark-accent-color);
}

.project-details-card {
    position: fixed;
    top: 15px;
    left: 15px;
    width: var(--card-width-desktop); /* Narrower for desktop */
    height: auto;
    max-height: var(--card-max-height-desktop); /* Taller for desktop */
    background: linear-gradient(135deg, var(--card-background), #f9f9f9);
    border-radius: var(--border-radius);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2), 0 0 10px var(--primary-color);
    border: 2px solid var(--primary-color);
    padding: 15px 10px;
    z-index: 998;
    font-family: 'Noto Sans Hebrew', sans-serif;
    text-align: right;
    /* Transition is added via JS after page load to prevent flickering */
    overflow-y: auto;
}

.pull-handle {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    right: -30px; /* Increased from -20px to be more visible */
    width: 30px; /* Increased from 20px */
    height: 60px; /* Increased from 40px */
    background: var(--primary-color);
    border-radius: 0 10px 10px 0;
    cursor: pointer;
    z-index: 999;
    display: none; /* Hidden on desktop by default */
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 16px; /* Larger icon */
    box-shadow: 2px 0 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
}

.pull-handle:hover {
    background: var(--secondary-color);
    right: -32px;
}

.close-card-btn {
    position: absolute;
    top: 5px;
    left: 5px;
    background: none;
    border: none;
    color: #aaa;
    font-size: calc(var(--font-size-base) * 1.2);
    cursor: pointer;
    transition: color 0.3s ease;
}

.close-card-btn:hover {
    color: var(--primary-color);
}

.project-details-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px dashed var(--border-color);
    cursor: pointer;
    transition: background-color 0.2s ease;
    word-break: break-word;
    overflow-wrap: break-word;
}

.project-details-item:last-of-type {
    border-bottom: none;
}

.project-details-item:hover {
    background-color: rgba(139, 0, 0, 0.1);
}

.project-details-item .detail-label {
    font-size: calc(var(--font-size-base) * 0.9);
    color: var(--light-text-color);
    margin-right: 5px;
    flex-shrink: 0;
}

.project-details-item .detail-value {
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    color: var(--text-color);
    flex-grow: 1;
    text-align: left;
    min-width: 30px;
}

.project-details-item input[type="text"], .project-details-item input[type="number"], .project-details-item select {
    width: 100%;
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: calc(var(--font-size-base) * 0.9);
    box-sizing: border-box;
    background-color: var(--card-background);
    color: var(--text-color);
}

.project-details-card::-webkit-scrollbar {
    width: 8px;
    background-color: transparent;
}

.project-details-card::-webkit-scrollbar-thumb {
    background-color: transparent;
    border-radius: 4px;
}

.project-details-card::-webkit-scrollbar-track {
    background-color: transparent;
}

.project-details-card:hover::-webkit-scrollbar-thumb {
    background-color: rgba(139, 0, 0, 0.5);
}

.project-details-card:hover::-webkit-scrollbar-track {
    background-color: rgba(139, 0, 0, 0.1);
}

body.dark-mode .project-details-card::-webkit-scrollbar-thumb {
    background-color: transparent;
}

body.dark-mode .project-details-card:hover::-webkit-scrollbar-thumb {
    background-color: rgba(184, 0, 0, 0.5);
}

body.dark-mode .project-details-card:hover::-webkit-scrollbar-track {
    background-color: rgba(184, 0, 0, 0.1);
}

.project-details-item.custom-property .detail-value {
    background-color: var(--background-color);
    border-radius: 5px;
    padding: 2px 5px;
    min-height: 1.5em;
}

.project-details-item.custom-property:hover .detail-value {
    background-color: #f0f0f0;
}

.project-details-item.custom-property .delete-custom-prop-btn {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 3px 6px;
    font-size: calc(var(--font-size-base) * 0.7);
    cursor: pointer;
    margin-left: 5px;
    flex-shrink: 0;
    transition: background 0.2s ease;
}

.project-details-item.custom-property .delete-custom-prop-btn:hover {
    background: linear-gradient(135deg, #d32f2f, #b71c1c);
}

.add-custom-property-btn {
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    color: white;
    padding: 12px 15px; /* Increased padding for better touch target */
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    font-weight: 400; /* Thinner font */
    transition: all 0.3s ease;
    width: 100%;
    margin: 15px 0 5px 0;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    position: relative;
    z-index: 10; /* Ensure it's above other elements */
    min-height: 44px; /* Minimum touch target size */
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    box-sizing: border-box; /* Include padding in width calculation */
}

.add-custom-property-btn:hover,
.add-custom-property-btn:active {
    background: linear-gradient(135deg, #FFB366, #FFC999);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

#datePickerModal .modal-content {
    max-width: 300px;
    padding: 20px;
}

.date-picker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    margin-top: 30px;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: bold;
    color: var(--primary-color);
}

.date-picker-header button {
    background: none;
    border: none;
    font-size: calc(var(--font-size-base) * 1.3);
    cursor: pointer;
    color: var(--secondary-color);
    padding: 0 5px;
}

.date-picker-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    text-align: center;
    font-size: calc(var(--font-size-base) * 0.9);
}

.date-picker-day {
    padding: 8px 0;
    border-radius: 4px;
    cursor: pointer;
    background-color: #f0f0f0;
    transition: background-color 0.2s;
}

.date-picker-day.header {
    background-color: var(--primary-color);
    color: white;
    font-weight: bold;
}

.date-picker-day:not(.header):hover {
    background-color: #e0e0e0;
}

.date-picker-day.selected {
    background-color: var(--secondary-color);
    color: white;
}

.date-picker-day.empty {
    background: none;
    cursor: default;
}

.date-picker-day.current-month {
    color: var(--text-color);
}

.date-picker-day.other-month {
    color: var(--light-text-color);
    opacity: 0.7;
}

body.dark-mode .date-picker-day {
    background-color: #3a3a5e;
    color: var(--dark-text-color);
}

body.dark-mode .date-picker-day:not(.header):hover {
    background-color: #4a4a7a;
}

body.dark-mode .date-picker-day.selected {
    background-color: var(--secondary-color);
}

body.dark-mode .date-picker-header button {
    color: var(--dark-primary-color);
}

.instructions-modal-content {
    padding: 30px;
    text-align: right;
}

.instructions-modal-content h3 {
    text-align: center;
}

.instructions-modal-content p {
    margin-bottom: 1em;
}

.instructions-modal-content ul {
    list-style-type: disc;
    margin-right: 20px;
    margin-bottom: 1em;
}

.instructions-modal-content li {
    margin-bottom: 0.5em;
}

.timeline-modal-content {
    padding: 30px;
    text-align: right;
    max-height: 90vh;
}

.timeline-modal-content h3 {
    text-align: center;
    margin-bottom: 20px;
}

.timeline-container {
    position: relative;
    padding: 20px 0;
    margin: 0 auto;
    width: 100%;
    height: 500px;
    overflow-x: hidden;
    overflow-y: auto;
    border-bottom: 3px solid var(--primary-color);
    padding-bottom: 20px;
    padding-top: 20px;
    direction: rtl;
    white-space: normal;
}

.timeline-event {
    position: relative;
    margin-bottom: 30px;
    padding-bottom: 20px;
    text-align: right;
    opacity: 0;
    transform: translateX(50px);
    animation: slideInEvent 0.5s forwards;
    display: block;
    vertical-align: top;
    padding-left: 40px;
}

@keyframes slideInEvent {
    from {
        opacity: 0;
        transform: translateX(50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.timeline-event::before {
    content: '';
    position: absolute;
    bottom: -10px;
    right: 0;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: var(--primary-color);
    border: 3px solid var(--card-background);
    z-index: 1;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
}

body.dark-mode .timeline-event::before {
    background-color: var(--dark-primary-color);
    border-color: var(--dark-card-background);
}

.timeline-event-content {
    background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

body.dark-mode .timeline-event-content {
    background: linear-gradient(135deg, #3a3a5e, #2a2a2a);
}

.timeline-event h4 {
    margin-top: 0;
    margin-bottom: 5px;
    color: var(--secondary-color);
    font-size: calc(var(--font-size-base) * 1);
    transition: color var(--animation-speed);
}

.timeline-event p {
    margin: 0;
    font-size: calc(var(--font-size-base) * 0.9);
    color: var(--text-color);
    transition: color var(--animation-speed);
}

.timeline-event .event-value {
    font-weight: bold;
    color: var(--primary-color);
    transition: color var(--animation-speed);
}

.timeline-event .event-timestamp {
    font-size: calc(var(--font-size-base) * 0.8);
    color: var(--light-text-color);
    margin-top: 5px;
    display: block;
    transition: color var(--animation-speed);
}

.download-pdf-btn {
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 400; /* Thinner font */
    margin-top: 20px;
    transition: all 0.3s ease;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

.download-pdf-btn:hover,
.download-pdf-btn:active {
    background: linear-gradient(135deg, #FFB366, #FFC999);
    transform: translateY(-2px);
}

.finance-yearly-modal-content {
    padding: 30px;
    text-align: right;
}

.finance-yearly-modal-content h3 {
    text-align: center;
}

.year-selector {
    margin-bottom: 20px;
    text-align: center;
}

.year-selector select {
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background-color: var(--card-background);
    color: var(--text-color);
    font-size: calc(var(--font-size-base) * 0.9);
}

body.dark-mode .year-selector select {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.year-selector button {
    padding: 8px 15px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    margin-left: 10px;
}

.year-selector button:hover {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
}

.finance-yearly-report-summary {
    margin-bottom: 20px;
    font-size: calc(var(--font-size-base) * 1);
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 15px;
    transition: border-color var(--animation-speed);
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 10px;
}

body.dark-mode .finance-yearly-report-summary {
    border-color: var(--dark-border-color);
}

.finance-yearly-report-summary div {
    padding: 10px 12px;
    font-weight: 700;
    border-radius: 14px;
    border: 1px solid rgba(26, 77, 46, 0.14);
    background: linear-gradient(145deg, rgba(255,255,255,0.96), rgba(246,250,247,0.92));
    box-shadow: 0 8px 18px rgba(20, 51, 35, 0.12);
}

.finance-yearly-report-summary .total-income {
    color: #4CAF50;
}

.finance-yearly-report-summary .total-expense {
    color: #F44336;
}

.finance-yearly-report-summary .total-balance {
    color: var(--secondary-color);
}

body.dark-mode .finance-yearly-report-summary .total-income {
    color: #8BC34A;
}

body.dark-mode .finance-yearly-report-summary .total-expense {
    color: #EF5350;
}

body.dark-mode .finance-yearly-report-summary .total-balance {
    color: var(--dark-primary-color);
}

body.dark-mode .finance-yearly-report-summary div {
    background: linear-gradient(145deg, rgba(35,43,47,0.96), rgba(28,35,39,0.95));
    border-color: rgba(255,255,255,0.14);
}

.finance-yearly-project-section {
    margin-bottom: 20px;
    background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 15px;
    transition: all var(--animation-speed);
}

body.dark-mode .finance-yearly-project-section {
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
    border-color: #444;
}

.finance-yearly-project-section h4 {
    color: var(--primary-color);
    margin-top: 0;
    margin-bottom: 10px;
    font-size: calc(var(--font-size-base) * 1.1);
    transition: color var(--animation-speed);
}

.finance-yearly-project-section p {
    margin: 5px 0;
    font-size: calc(var(--font-size-base) * 0.9);
}

.finance-yearly-project-section .project-balance {
    font-weight: 700;
}

.finance-yearly-project-section .project-balance.positive {
    color: #4CAF50;
}

.finance-yearly-project-section .project-balance.negative {
    color: #F44336;
}

body.dark-mode .finance-yearly-project-section .project-balance.positive {
    color: #8BC34A;
}

body.dark-mode .finance-yearly-project-section .project-balance.negative {
    color: #EF5350;
}

.reminders-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
}

.yearly-receipts-list {
    margin-top: 8px;
    text-align: right;
    overflow-wrap: anywhere;
}
.yearly-receipts-list ul {
    margin: 6px 0 0;
    padding-right: 18px;
}
.yearly-receipts-list li {
    margin-bottom: 4px;
}

.yearly-receipts-list a {
    word-break: break-word;
}

.finance-yearly-modal-content,
.global-finance-modal-content {
    overflow-x: hidden;
}

.media-preview-content {
    max-width: 96vw;
    width: min(1100px, 96vw);
    height: min(92vh, 920px);
}

.media-preview-body {
    min-height: 300px;
    max-height: none;
    height: 100%;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.media-preview-body.pdf-mode {
    align-items: stretch;
    justify-content: stretch;
}

.media-preview-body img,
.media-preview-body iframe {
    max-width: 100%;
    max-height: 100%;
    border: none;
}

.media-preview-body.pdf-mode iframe {
    width: 100%;
    height: 100%;
    min-height: 70vh;
}

.media-preview-actions {
    display: flex;
    justify-content: flex-end;
    margin: 8px 0;
}

.reminders-modal-content {
    background: linear-gradient(135deg, var(--card-background), #f9f9f9);
    margin: auto;
    padding: 30px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    width: 80%;
    max-width: 600px;
    animation: slideInModal 0.4s ease-out;
    position: relative;
    display: flex;
    flex-direction: column;
}

body.dark-mode .reminders-modal-content {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
}

.reminders-list {
    list-style: none;
    padding: 0;
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.reminders-list li {
    background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: calc(var(--font-size-base) * 1);
    transition: all var(--animation-speed);
}

body.dark-mode .reminders-list li {
    background: linear-gradient(135deg, #3a3a5e, #2a2a2a);
    border-color: var(--dark-border-color);
    color: var(--dark-text-color);
}

.reminder-details {
    flex-grow: 1;
}

.reminder-details .text {
    font-weight: 700;
    color: var(--primary-color);
}

.reminder-details .datetime {
    font-size: calc(var(--font-size-base) * 0.8);
    color: var(--light-text-color);
    margin-top: 5px;
}

.reminder-actions button {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    margin-right: 8px;
    font-size: calc(var(--font-size-base) * 0.8);
    transition: color 0.2s ease;
}

.reminder-actions button:hover {
    color: var(--secondary-color);
    text-decoration: underline;
}

.reminder-actions button.delete {
    color: #f44336;
}

.reminder-actions button.delete:hover {
    color: #d32f2f;
}

.add-reminder-form {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.add-reminder-form input, .add-reminder-form textarea {
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    background-color: var(--card-background);
    color: var(--text-color);
    transition: all var(--animation-speed);
}

body.dark-mode .add-reminder-form input, body.dark-mode .add-reminder-form textarea {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.add-reminder-form button {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    transition: all 0.3s ease;
}

.add-reminder-form button:hover {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
}

/* Image upload section styles */
.image-upload-section {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 15px;
    background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

body.dark-mode .image-upload-section {
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
    border-color: var(--dark-border-color);
}

.image-upload-section label {
    font-weight: 700;
    color: var(--text-color);
    font-size: calc(var(--font-size-base) * 0.9);
    display: flex;
    align-items: center;
    gap: 8px;
}

body.dark-mode .image-upload-section label {
    color: var(--dark-text-color);
}

.image-upload-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}


.finance-attachments-list {
    list-style: none;
    padding: 0;
    margin: 8px 0 0;
}
.finance-attachments-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    font-size: 0.85em;
    padding: 6px 0;
    border-bottom: 1px dashed var(--border-color);
}
.finance-attachment-actions {
    display: flex;
    gap: 6px;
}
.finance-attachment-actions button {
    border: none;
    border-radius: 6px;
    cursor: pointer;
    padding: 4px 6px;
    font-size: 0.8em;
}
.metric-thumb-btn {
    margin-top: 6px;
    background: #e8f3ff;
    color: #0b63ce;
    border: 1px solid #cfe4ff;
    border-radius: 8px;
    padding: 6px 10px;
    cursor: pointer;
}
.metric-thumb-preview {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    object-fit: cover;
    margin-inline-start: 8px;
    cursor: pointer;
    border: 1px solid #ddd;
}
.image-upload-btn, .camera-btn {
    flex: 1;
    min-width: 120px;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.image-upload-btn {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.image-upload-btn:hover {
    background: linear-gradient(135deg, #1976D2, #1565C0);
    transform: translateY(-2px);
}

.camera-btn {
    background: linear-gradient(135deg, #4CAF50, #388E3C);
    color: white;
}

.camera-btn:hover {
    background: linear-gradient(135deg, #388E3C, #2E7D32);
    transform: translateY(-2px);
}

.image-preview {
    position: relative;
    margin-top: 10px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid var(--border-color);
    max-width: 300px;
}

body.dark-mode .image-preview {
    border-color: var(--dark-border-color);
}

.image-preview img {
    width: 100%;
    height: auto;
    display: block;
}

.remove-image-btn {
    position: absolute;
    top: 8px;
    left: 8px;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: rgba(244, 67, 54, 0.9);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.remove-image-btn:hover {
    background: rgba(211, 47, 47, 1);
    transform: scale(1.1);
}

.inbox-item-image, .reminder-item-image {
    width: 100%;
    max-width: 250px;
    margin-top: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.inbox-item-image:hover, .reminder-item-image:hover {
    transform: scale(1.05);
}

/* Sound selection styles */
.sound-selection {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.sound-selection label {
    font-weight: 700;
    color: var(--text-color);
    font-size: calc(var(--font-size-base) * 0.9);
}

.sound-selection select {
    flex: 1;
    min-width: 150px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    background-color: var(--card-background);
    color: var(--text-color);
}

body.dark-mode .sound-selection select {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.preview-sound-btn {
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.preview-sound-btn:hover {
    background: linear-gradient(135deg, #FFB366, #FFC999);
    transform: scale(1.1);
}

/* Email-like Inbox styles */
.inbox-item {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 10px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

body.dark-mode .inbox-item {
    background: var(--dark-card-background);
    border-color: var(--dark-border-color);
}

.inbox-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.inbox-message-header {
    display: flex;
    align-items: center;
    padding: 15px;
    cursor: pointer;
    gap: 15px;
    transition: background 0.3s ease;
}

.inbox-message-header:hover {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}

body.dark-mode .inbox-message-header:hover {
    background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
}

.inbox-icon {
    width: 45px;
    height: 45px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    flex-shrink: 0;
}

.inbox-preview {
    flex: 1;
    min-width: 0;
}

.inbox-subject {
    font-weight: 700;
    color: var(--text-color);
    font-size: calc(var(--font-size-base) * 1);
    margin-bottom: 5px;
}

body.dark-mode .inbox-subject {
    color: var(--dark-text-color);
}

.inbox-snippet {
    color: var(--light-text-color);
    font-size: calc(var(--font-size-base) * 0.85);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

body.dark-mode .inbox-snippet {
    color: var(--dark-light-text-color);
}

.inbox-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
    flex-shrink: 0;
}

.inbox-date {
    font-size: calc(var(--font-size-base) * 0.85);
    color: var(--light-text-color);
    font-weight: 600;
}

.inbox-time {
    font-size: calc(var(--font-size-base) * 0.75);
    color: var(--light-text-color);
}

.inbox-toggle-icon {
    font-size: 16px;
    color: var(--primary-color);
    margin-top: 5px;
    transition: transform 0.3s ease;
}

.inbox-message-body {
    border-top: 1px solid #e0e0e0;
    padding: 20px;
    background: linear-gradient(135deg, #fafafa, #f5f5f5);
    animation: slideDown 0.3s ease-out;
}

body.dark-mode .inbox-message-body {
    border-color: var(--dark-border-color);
    background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 500px;
    }
}

.inbox-message-content {
    margin-bottom: 15px;
}

.inbox-message-content p {
    margin: 0 0 15px 0;
    font-size: calc(var(--font-size-base) * 1);
    color: var(--text-color);
    line-height: 1.6;
}

body.dark-mode .inbox-message-content p {
    color: var(--dark-text-color);
}

.inbox-message-image {
    margin-top: 15px;
}

.inbox-message-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.inbox-delete-btn {
    background: linear-gradient(135deg, #f44336, #d32f2f);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 15px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.inbox-delete-btn:hover {
    background: linear-gradient(135deg, #d32f2f, #b71c1c);
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .inbox-message-header {
        padding: 12px;
        gap: 10px;
    }
    
    .inbox-icon {
        width: 35px;
        height: 35px;
        font-size: 16px;
    }
    
    .inbox-subject {
        font-size: calc(var(--font-size-base) * 0.9);
    }
    
    .inbox-snippet {
        font-size: calc(var(--font-size-base) * 0.8);
    }
    
    .inbox-meta {
        font-size: calc(var(--font-size-base) * 0.75);
    }
}

/* Reminder popup notification styles */
.reminder-popup-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    animation: slideDownPopup 0.5s ease-out;
}

@keyframes slideDownPopup {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-100%);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.reminder-popup-content {
    display: flex;
    align-items: center;
    gap: 15px;
    background: linear-gradient(135deg, #4CAF50, #66BB6A);
    color: white;
    padding: 15px 25px;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
    min-width: 300px;
    max-width: 500px;
}

.reminder-popup-icon {
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    animation: bellRing 0.5s ease infinite;
}

@keyframes bellRing {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(15deg); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-15deg); }
}

.reminder-popup-text {
    flex: 1;
}

.reminder-popup-text h4 {
    margin: 0 0 5px 0;
    font-size: calc(var(--font-size-base) * 1.2);
    color: white;
}

.reminder-popup-text p {
    margin: 0;
    font-size: calc(var(--font-size-base) * 1);
    opacity: 0.95;
}

.reminder-popup-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: white;
    font-size: 18px;
    transition: all 0.3s ease;
}

.reminder-popup-close:hover {
    background: rgba(255, 255, 255, 0.4);
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .reminder-popup-notification {
        top: 10px;
        left: 10px;
        right: 10px;
        transform: none;
    }
    
    @keyframes slideDownPopup {
        from {
            opacity: 0;
            transform: translateY(-100%);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .reminder-popup-content {
        min-width: auto;
        max-width: none;
        padding: 12px 15px;
    }
    
    .reminder-popup-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
    }
    
    .sound-selection {
        flex-direction: column;
        align-items: stretch;
    }
    
    .preview-sound-btn {
        align-self: flex-start;
    }
}

.auth-section {
    width: 100%;
    text-align: center;
}

.auth-section .auth-status {
    font-size: calc(var(--font-size-base) * 0.9);
    margin-bottom: 10px;
    color: var(--primary-color);
}

.auth-section button {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    margin: 5px;
    transition: all 0.3s ease;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

.auth-section button:hover {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
}

.auth-section .logout-btn {
    background: linear-gradient(135deg, #f44336, #d32f2f);
}

.auth-section .logout-btn:hover {
    background: linear-gradient(135deg, #d32f2f, #b71c1c);
}

.auth-section .change-password-btn {
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    font-size: calc(var(--font-size-base) * 0.8);
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

.auth-section .change-password-btn:hover,
.auth-section .change-password-btn:active {
    background: linear-gradient(135deg, #FFB366, #FFC999);
}

.auth-section .switch-back-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    font-size: calc(var(--font-size-base) * 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px;
}

.auth-section .switch-back-btn:hover {
    background: linear-gradient(135deg, #45a049, #3d8b40);
}

.auth-section .switch-back-btn i {
    font-size: 0.9em;
}

.login-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    animation: fadeInModal 0.3s ease-out;
}

.login-modal-content {
    background: linear-gradient(135deg, var(--card-background), #f9f9f9);
    margin: auto;
    padding: 40px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    width: 90%;
    max-width: 400px;
    animation: slideInModal 0.4s ease-out;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: all var(--animation-speed);
}

body.dark-mode .login-modal-content {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
}

.login-modal-content h2 {
    color: var(--primary-color);
    font-family: 'Playfair Display', serif;
    font-size: calc(var(--font-size-base) * 1.5);
    margin-bottom: 20px;
    transition: color var(--animation-speed);
}

.login-modal-content p {
    font-size: calc(var(--font-size-base) * 1);
    color: var(--text-color);
    margin-bottom: 30px;
    line-height: 1.5;
    transition: color var(--animation-speed);
}

/* Show desktop description by default, hide mobile description */
.login-description-mobile {
    display: none;
}

.login-description-desktop {
    display: block;
}

.login-modal-content .google-btn {
    background: linear-gradient(135deg, #4285f4, #34a853);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease, transform 0.2s ease;
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    margin-bottom: 15px;
}

.login-modal-content .google-auth-buttons {
    display: flex;
    flex-direction: column;
    width: 100%;
}

.login-modal-content .google-auth-buttons .google-btn {
    width: 100%;
    justify-content: center;
}

.login-modal-content .google-btn:hover {
    background: linear-gradient(135deg, #3367d6, #2e7d32);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(66, 133, 244, 0.4);
}

.login-modal-content .google-btn img,
.login-modal-content .google-btn i {
    width: 20px;
    height: 20px;
    font-size: 20px;
    line-height: 1;
}

.login-separator {
    display: flex;
    align-items: center;
    text-align: center;
    margin: 10px 0;
}

.login-separator::before,
.login-separator::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--border-color);
}

.login-separator span {
    padding: 0 10px;
    color: var(--text-color);
    font-size: calc(var(--font-size-base) * 0.9);
}

body.dark-mode .login-separator::before,
body.dark-mode .login-separator::after {
    border-color: var(--dark-border-color);
}

body.dark-mode .login-separator span {
    color: var(--dark-text-color);
}

.login-modal-content .email-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    margin-bottom: 20px;
}

.login-modal-content .email-form input {
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    background-color: var(--card-background);
    color: var(--text-color);
    transition: all var(--animation-speed);
}

body.dark-mode .login-modal-content .email-form input {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.login-modal-content .email-form .buttons {
    display: flex;
    gap: 10px;
}

.login-modal-content .email-form .buttons button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    transition: all 0.3s ease;
    /* Ensure touch events work on mobile */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
}

.login-modal-content .email-form .buttons .register-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
}

.login-modal-content .email-form .buttons .register-btn:hover,
.login-modal-content .email-form .buttons .register-btn:active {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
}

.login-modal-content .email-form .buttons .login-btn {
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    color: white;
    font-weight: 400; /* Thinner font */
    /* Ensure touch events work on mobile */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
}

.login-modal-content .email-form .buttons .login-btn:hover,
.login-modal-content .email-form .buttons .login-btn:active {
    background: linear-gradient(135deg, #FFB366, #FFC999);
    transform: translateY(-2px);
}

.login-modal-content .close-login-btn {
    position: absolute;
    top: 10px;
    left: 10px;
    background: none;
    border: none;
    color: #aaa;
    font-size: calc(var(--font-size-base) * 1.5);
    cursor: pointer;
    transition: color 0.3s ease;
}

.login-modal-content .close-login-btn:hover {
    color: var(--primary-color);
}

.login-modal-content .skip-btn {
    background: none;
    border: none;
    color: var(--light-text-color);
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    margin-top: 20px;
    transition: color 0.2s ease;
}

.login-modal-content .skip-btn:hover {
    color: var(--primary-color);
    text-decoration: underline;
}

.login-modal-content .toggle-form-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    margin-top: 15px;
    padding: 0;
    transition: color 0.2s ease;
    text-decoration: underline;
    font-weight: 600;
}

.login-modal-content .toggle-form-btn:hover {
    color: var(--secondary-color);
}

body.dark-mode .login-modal-content .toggle-form-btn {
    color: var(--dark-accent-color);
}

body.dark-mode .login-modal-content .toggle-form-btn:hover {
    color: var(--dark-primary-color);
}

.add-data-cube {
    display: inline-block;
    background: linear-gradient(135deg, var(--accent-color), #FFB366);
    color: white;
    padding: 8px 14px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.82);
    font-weight: 400; /* Thinner font */
    transition: all 0.3s ease, transform 0.2s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    margin: 6px;
    /* Ensure touch events work */
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    min-height: 44px; /* Minimum touch target size */
}

.add-data-cube:hover,
.add-data-cube:active {
    background: linear-gradient(135deg, #FFB366, #FFC999);
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
}

.add-data-cube i {
    margin-right: 6px;
}

/* Mobile overrides after base rules to avoid being reset */
@media (max-width: 768px) {
    .card-fab {
        display: flex;
        align-items: center;
        justify-content: center;
        top: 35px;
        left: 15px;
        right: auto;
        bottom: auto;
        width: 48px;
        height: 48px;
        font-size: 20px;
        z-index: 1110;
    }
    .dashboard-item h3 {
        font-size: calc(var(--font-size-base) * 0.64);
        white-space: normal;
        word-break: break-word;
        overflow-wrap: anywhere;
        line-height: 1.2;
        max-width: 100%;
    }
    .dashboard-item p {
        font-size: calc(var(--font-size-base) * 0.88);
    }
    .input-section {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    .history-list li {
        padding: 10px;
        align-items: stretch;
    }
    .history-entry-actions {
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 6px;
    }
    .history-upload-btn,
    .history-list li .undo-button {
        font-size: calc(var(--font-size-base) * 0.62);
        padding: 5px 8px;
        margin-right: 0;
        min-height: 34px;
    }
    .modal-graph-container {
        height: 260px;
    }
    .modal-graph-label-x {
        font-size: calc(var(--font-size-base) * 0.52);
    }
}

.add-metric-modal-content {
    background: linear-gradient(135deg, var(--card-background), #f9f9f9);
    margin: auto;
    padding: 24px;
    border-radius: var(--border-radius);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    width: min(92%, 360px);
    max-width: 360px;
    animation: slideInModal 0.4s ease-out;
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

body.dark-mode .add-metric-modal-content {
    background: linear-gradient(135deg, var(--dark-card-background), #2a2a2a);
}

.add-metric-modal-content h3 {
    color: var(--primary-color);
    font-family: 'Playfair Display', serif;
    font-size: calc(var(--font-size-base) * 1.5);
    margin-bottom: 20px;
    transition: color var(--animation-speed);
}

.add-metric-modal-content label {
    font-weight: 700;
    color: var(--light-text-color);
    margin-bottom: 10px;
    transition: color var(--animation-speed);
}

.add-metric-modal-content input {
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    background-color: var(--card-background);
    color: var(--text-color);
    transition: all var(--animation-speed);
    width: 100%;
    max-width: 300px;
}

body.dark-mode .add-metric-modal-content input {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.add-metric-modal-content button {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 700;
    margin-top: 20px;
    transition: all 0.3s ease;
}

.add-metric-modal-content button:hover {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
}

/* Desktop media query - MUST be at the end to override base styles */
@media (min-width: 769px) {
    .project-details-card {
        left: 15px;
        visibility: visible !important; /* Force card to be visible on desktop */
    }
    .pull-handle {
        display: none;
    }
    .close-card-btn {
        display: none;
    }
    
    .sidebar-toggle-handle {
        display: none !important; /* Hide on desktop */
    }
    
    /* Stage navigation: Display all 6 categories in one row on desktop */
    .stage-nav-container {
        flex-wrap: nowrap; /* Prevent wrapping - display all in one row */
        overflow-x: visible; /* Show all categories */
    }
    
    .stage-nav-container > div {
        width: auto; /* Let divs size naturally */
        display: flex;
        flex-wrap: nowrap; /* Ensure buttons within divs don't wrap */
        gap: 6px; /* Reduced gap to save space */
    }
    
    .wine-icon-container {
        width: auto; /* Let wine icon size naturally */
        order: 1; /* Keep wine icon in middle */
        flex-shrink: 0; /* Prevent wine icon from shrinking */
        margin: 0 8px; /* Add some spacing around the icon */
    }
    
    .wine-icon-container img {
        width: 60px; /* Slightly smaller wine icon on desktop to save space */
        height: auto;
    }
    
    .stage-nav-button {
        flex: 0 1 auto; /* Allow buttons to size based on content */
        min-width: 80px; /* Reduced from 100px to fit better in one row */
        max-width: 110px; /* Add max-width to prevent buttons from being too wide */
        font-size: calc(var(--font-size-base) * 0.82);
        padding: 8px 10px; /* Slightly reduce padding to fit better */
    }
    
    /* Input section: 4 data cubes per row instead of 2 */
    .input-section {
        grid-template-columns: repeat(auto-fill, minmax(220px, 220px));
        justify-content: center;
        gap: 15px;
    }
    
    .input-group {
        min-width: 0; /* Prevent grid overflow */
    }
    
    /* Dashboard: lower height and horizontal layout (button next to cubes) */
    .dashboard-section {
        flex-direction: row;
        width: 100%;
        left: 0;
        transform: none;
        padding: 8px 15px;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .dashboard-section h2 {
        flex-basis: 100%; /* Full width for title */
        margin-bottom: 5px;
    }
    
    .dashboard-grid {
        flex: 1;
        justify-content: flex-start;
        max-width: 100%;
    }
    
    .add-data-cube {
        margin: 0 10px;
        flex-shrink: 0;
    }
}

/* Access Management Modal Styles */
.access-modal-content {
    max-width: 700px;
    padding: 30px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.access-tab-content {
    overflow-y: auto;
    padding-right: 4px;
}

.access-modal-content h3 {
    color: var(--primary-color);
    font-size: calc(var(--font-size-base) * 1.4);
    margin-bottom: 25px;
    text-align: center;
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 15px;
}

.access-modal-content h3 i {
    margin-left: 10px;
}

/* Access Management Tabs */
.access-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    border-bottom: 2px solid var(--border-color);
}

.access-tab {
    flex: 1;
    padding: 12px 20px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: #666;
    font-size: calc(var(--font-size-base) * 1);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.access-tab:hover {
    background: rgba(31, 59, 115, 0.05);
    color: var(--primary-color);
}

.access-tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
    background: rgba(31, 59, 115, 0.08);
    font-weight: 600;
}

.access-tab i {
    font-size: 1.1em;
}

.access-tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.access-tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.access-section {
    margin-bottom: 25px;
}

.add-user-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

body.dark-mode .add-user-section {
    background: linear-gradient(135deg, #2a2a3e, #1a1a2e);
    border-color: var(--dark-border-color);
}

.access-section h4 {
    color: var(--secondary-color);
    font-size: calc(var(--font-size-base) * 1.1);
    margin-bottom: 15px;
    margin-top: 0;
}

.stage-overview-container::before {
    content: '';
    display: block;
    width: calc(100% - 20px);
    height: 4px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(176, 37, 75, 0.25), rgba(101, 22, 47, 0.75), rgba(176, 37, 75, 0.25));
    margin: 0 auto 14px;
}

.mobile-stage-metric-separator {
    display: none;
    width: calc(100% - 48px);
    height: 4px;
    margin: 10px auto 14px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(176, 37, 75, 0.25), rgba(101, 22, 47, 0.75), rgba(176, 37, 75, 0.25));
}

.access-section h4 i {
    margin-left: 8px;
}

.section-description {
    color: var(--light-text-color);
    font-size: calc(var(--font-size-base) * 0.9);
    margin-bottom: 20px;
    margin-top: -5px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 8px;
    font-size: calc(var(--font-size-base) * 0.95);
}

.form-group label i {
    margin-left: 5px;
    color: var(--primary-color);
}

.form-group input[type="email"],
.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    background-color: var(--card-background);
    color: var(--text-color);
    transition: all 0.3s ease;
}

body.dark-mode .form-group input[type="email"],
body.dark-mode .form-group select {
    background-color: var(--dark-card-background);
    color: var(--dark-text-color);
    border-color: var(--dark-border-color);
}

.form-group input[type="email"]:focus,
.form-group select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
    outline: none;
}

.permissions-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.permission-option {
    display: flex;
    align-items: flex-start;
    background: var(--card-background);
    padding: 15px;
    border-radius: 8px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
    cursor: pointer;
}

body.dark-mode .permission-option {
    background: var(--dark-card-background);
    border-color: var(--dark-border-color);
}

.permission-option:hover {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, #fff, #f8f9fa);
}

body.dark-mode .permission-option:hover {
    background: linear-gradient(135deg, #3a3a4e, #2a2a3e);
}

.permission-option input[type="radio"] {
    margin-top: 2px;
    margin-left: 10px;
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.permission-option label {
    flex: 1;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.permission-option label i {
    font-size: calc(var(--font-size-base) * 1.2);
    margin-left: 8px;
}

.permission-option .perm-title {
    font-weight: 700;
    color: var(--primary-color);
    font-size: calc(var(--font-size-base) * 1);
}

.permission-option .perm-desc {
    font-size: calc(var(--font-size-base) * 0.85);
    color: var(--light-text-color);
}

.checkbox-label {
    display: flex;
    align-items: center;
    padding: 12px;
    background: var(--card-background);
    border-radius: 8px;
    border: 2px solid var(--border-color);
    cursor: pointer;
    transition: all 0.3s ease;
}

body.dark-mode .checkbox-label {
    background: var(--dark-card-background);
    border-color: var(--dark-border-color);
}

.checkbox-label:hover {
    border-color: var(--primary-color);
}

.checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    margin-left: 10px;
    cursor: pointer;
}

.checkbox-label i {
    margin: 0 8px;
    color: var(--primary-color);
}

.btn-primary {
    width: 100%;
    padding: 15px 20px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1.05);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(139, 0, 0, 0.2);
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(139, 0, 0, 0.3);
}

.btn-primary i {
    margin-left: 8px;
}

.section-divider {
    border: none;
    border-top: 2px solid var(--border-color);
    margin: 30px 0;
}

body.dark-mode .section-divider {
    border-color: var(--dark-border-color);
}

.active-users-section {
    background: linear-gradient(135deg, #f0f4ff, #e6f0ff);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #d0e0ff;
}

body.dark-mode .active-users-section {
    background: linear-gradient(135deg, #1a1a2e, #0a0a1e);
    border-color: var(--dark-border-color);
}

.users-list-container {
    max-height: 260px;
    overflow-y: auto;
}

.active-users-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.user-access-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin-bottom: 12px;
    background: white;
    border-radius: 10px;
    border: 1px solid #d0e0ff;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

body.dark-mode .user-access-item {
    background: var(--dark-card-background);
    border-color: var(--dark-border-color);
}

.user-access-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color);
}

.user-info {
    flex: 1;
}

.user-email {
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 8px;
    font-size: calc(var(--font-size-base) * 1);
}

.user-email i {
    margin-left: 8px;
    color: var(--primary-color);
}

.user-permissions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.permission-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: calc(var(--font-size-base) * 0.8);
    font-weight: 600;
}

.permission-badge i {
    margin-left: 5px;
    font-size: calc(var(--font-size-base) * 0.75);
}

.permission-badge.view {
    background: #e3f2fd;
    color: #1976d2;
}

.permission-badge.edit {
    background: #fff3e0;
    color: #f57c00;
}

.permission-badge.project {
    background: #f3e5f5;
    color: #7b1fa2;
}

.permission-badge.finance-yes {
    background: #e8f5e9;
    color: #388e3c;
}

.permission-badge.finance-no {
    background: #ffebee;
    color: #d32f2f;
}

body.dark-mode .permission-badge.view {
    background: #1a237e;
    color: #90caf9;
}

body.dark-mode .permission-badge.edit {
    background: #e65100;
    color: #ffcc80;
}

body.dark-mode .permission-badge.project {
    background: #4a148c;
    color: #ce93d8;
}

body.dark-mode .permission-badge.finance-yes {
    background: #1b5e20;
    color: #a5d6a7;
}

body.dark-mode .permission-badge.finance-no {
    background: #b71c1c;
    color: #ef9a9a;
}

.user-actions {
    display: flex;
    gap: 8px;
}

.user-actions button {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 1);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-edit {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
}

.btn-edit:hover {
    background: linear-gradient(135deg, #1976D2, #1565C0);
    transform: scale(1.1);
}

.btn-delete {
    background: linear-gradient(135deg, #F44336, #D32F2F);
    color: white;
}

.btn-delete:hover {
    background: linear-gradient(135deg, #D32F2F, #B71C1C);
    transform: scale(1.1);
}

/* Connected Accounts Styles */
.connected-accounts-container {
    max-height: 260px;
    overflow-y: auto;
}

.connected-accounts-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.connected-account-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    margin-bottom: 12px;
    background: white;
    border-radius: 10px;
    border: 1px solid #d0e0ff;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}

body.dark-mode .connected-account-item {
    background: var(--dark-card-background);
    border-color: var(--dark-border-color);
}

.connected-account-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: var(--secondary-color);
}

.account-info {
    flex: 1;
}

.account-email {
    font-weight: 700;
    color: var(--text-color);
    margin-bottom: 8px;
    font-size: calc(var(--font-size-base) * 1);
    display: flex;
    align-items: center;
    gap: 8px;
}

.account-email i {
    color: var(--secondary-color);
}

.account-permissions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.account-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.account-actions button {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.9);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
}

.current-account-card {
    display: flex;
    align-items: center;
    padding: 20px;
    background: linear-gradient(135deg, #f0f4ff, #e6f0ff);
    border-radius: 12px;
    border: 2px solid var(--primary-color);
    margin-bottom: 15px;
}

body.dark-mode .current-account-card {
    background: linear-gradient(135deg, #1a1a2e, #0a0a1e);
    border-color: var(--primary-color);
}

#globalFinanceProjectsDetails,
#yearlyFinanceProjectsDetails,
#currentProjectFinanceReportTableBody {
    max-height: 45vh;
    overflow-y: auto;
}

.current-project-finance-report-table {
    display: block;
    overflow: auto;
    max-height: 45vh;
}

.current-project-finance-report-table thead,
.current-project-finance-report-table tbody {
    display: table;
    width: 100%;
    table-layout: fixed;
}

/* Confirmation Modal Styles */
.confirmation-modal-content {
    max-width: 450px;
    width: 90%;
    padding: 25px;
}

.confirmation-modal-content h3 {
    color: var(--primary-color);
    margin-bottom: 15px;
    text-align: center;
}

.confirmation-modal-content p {
    margin: 20px 0;
    font-size: calc(var(--font-size-base) * 1.1);
    text-align: center;
    line-height: 1.6;
}

.confirmation-modal-content .modal-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
}

.confirmation-modal-content .modal-actions button {
    min-width: 100px;
    padding: 12px 20px;
    border: none;
    border-radius: var(--border-radius);
    font-size: calc(var(--font-size-base) * 1);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
}

.btn-danger {
    background: linear-gradient(135deg, #F44336, #D32F2F);
    color: white;
}

.btn-danger:hover {
    background: linear-gradient(135deg, #D32F2F, #B71C1C);
    transform: scale(1.05);
}

.btn-secondary {
    background: linear-gradient(135deg, #9E9E9E, #757575);
    color: white;
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #757575, #616161);
    transform: scale(1.05);
}

.no-users-message {
    text-align: center;
    padding: 40px 20px;
    color: var(--light-text-color);
}

.no-users-message i {
    font-size: calc(var(--font-size-base) * 2.5);
    margin-bottom: 15px;
    color: var(--primary-color);
    display: block;
}

.no-users-message p {
    margin: 0;
    font-size: calc(var(--font-size-base) * 1);
}

@media (max-width: 768px) {
    .access-modal-content {
        padding: 20px 15px;
        max-width: 95%;
    }
    
    .user-access-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .user-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .permission-badge {
        font-size: calc(var(--font-size-base) * 0.75);
        padding: 3px 8px;
    }
}

/* ========== UI Components ========== */

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
}

.loading-spinner {
    text-align: center;
    color: white;
}

.spinner-border {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#loadingText {
    font-size: 18px;
    font-weight: 500;
    margin: 0;
    color: white;
}

/* Notifications */
.app-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
    max-width: 400px;
    font-family: 'Heebo', 'Noto Sans Hebrew', sans-serif;
}

.app-notification.success {
    border-right: 4px solid #4CAF50;
}

.app-notification.success i {
    color: #4CAF50;
}

.app-notification.error {
    border-right: 4px solid #f44336;
}

.app-notification.error i {
    color: #f44336;
}

.app-notification i {
    font-size: 24px;
}

.app-notification span {
    flex: 1;
    font-size: 14px;
    color: #333;
}

.app-notification.fade-out {
    animation: slideOut 0.3s ease-out;
    opacity: 0;
}

@keyframes slideIn {
    from {
        transform: translateX(400px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(400px);
        opacity: 0;
    }
}

/* Enhanced Auth Section */
.auth-section {
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin-bottom: 10px;
}

.auth-status {
    font-size: 14px;
    margin-bottom: 10px;
    color: inherit;
    font-weight: 500;
    padding: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 5px;
    text-align: center;
}

/* Improved Button Styles for Auth */
#loginBtn, #logoutBtn {
    width: 100%;
    padding: 10px;
    border: none;
    border-radius: 5px;
    font-family: 'Heebo', 'Noto Sans Hebrew', sans-serif;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 5px;
}

#loginBtn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

#loginBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

#logoutBtn {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

#logoutBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);
}

/* Connection Status Indicator */
.connection-status {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 12px;
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    margin-top: 5px;
}

.connection-status.local-only {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
}

.connection-status i {
    font-size: 8px;
}

.cloud-sync-indicator {
    position: fixed;
    top: 50%;
    right: 12px;
    width: 12px;
    height: 12px;
    border-radius: 3px;
    background: #4CAF50;
    opacity: 0;
    transform: translateY(-50%) scale(0.85);
    box-shadow: 0 0 6px rgba(76, 175, 80, 0.6);
    transition: opacity 0.2s ease, transform 0.2s ease;
    pointer-events: none;
    z-index: 1200;
}

.cloud-sync-indicator.active {
    opacity: 1;
    transform: translateY(-50%) scale(1);
}

/* Dark mode adjustments */
body.dark-mode .app-notification {
    background: #2d2d2d;
    color: #fff;
}

body.dark-mode .app-notification span {
    color: #fff;
}

body.dark-mode .auth-status {
    background: rgba(255, 255, 255, 0.05);
}

/* Authentication Modal Styles */
.login-modal-content {
    max-width: 450px;
    padding: 40px;
    text-align: center;
}

@media (max-width: 640px) {
    .login-modal-content {
        max-width: min(92vw, 450px);
        padding: 24px 20px;
    }
}

.login-modal-content h2 {
    color: var(--primary-color);
    margin-bottom: 25px;
    font-family: 'Playfair Display', serif;
    font-size: calc(var(--font-size-base) * 1.8);
}

.google-signin-btn {
    width: 100%;
    padding: 15px;
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1.1);
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s ease;
    color: #333;
}

.google-signin-btn:hover {
    background: #f8f8f8;
    border-color: #999;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.google-signin-btn i {
    font-size: calc(var(--font-size-base) * 1.3);
    color: #DB4437;
}

body.dark-mode .google-signin-btn {
    background: #2a2a2a;
    border-color: #444;
    color: #fff;
}

body.dark-mode .google-signin-btn:hover {
    background: #333;
    border-color: #666;
}

.divider-or {
    margin: 25px 0;
    text-align: center;
    position: relative;
}

.divider-or::before,
.divider-or::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #ddd;
}

.divider-or::before {
    right: 0;
}

.divider-or::after {
    left: 0;
}

.divider-or span {
    background: var(--card-background);
    padding: 0 15px;
    color: #999;
    font-size: calc(var(--font-size-base) * 0.9);
}

body.dark-mode .divider-or span {
    background: var(--dark-card-background);
}

body.dark-mode .divider-or::before,
body.dark-mode .divider-or::after {
    background: #444;
}

.login-modal-content form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.login-modal-content .auth-input {
    width: 100%;
    box-sizing: border-box;
    min-height: 50px;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1);
    transition: all 0.3s ease;
    background: var(--card-background);
    color: var(--text-color);
}

.login-modal-content .auth-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.1);
}

body.dark-mode .login-modal-content .auth-input {
    background: #2a2a2a;
    border-color: #444;
    color: #fff;
}

body.dark-mode .login-modal-content .auth-input:focus {
    border-color: var(--dark-primary-color);
    box-shadow: 0 0 0 3px rgba(199, 144, 187, 0.2);
}

.login-modal-content .auth-submit-btn {
    width: 100%;
    min-height: 50px;
    padding: 15px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border: none;
    border-radius: 8px;
    font-size: calc(var(--font-size-base) * 1.1);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-modal-content .auth-submit-btn:hover {
    background: linear-gradient(135deg, var(--secondary-color), #8B0000);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(128, 0, 32, 0.3);
}

.toggle-form-text {
    text-align: center;
    margin-top: 15px;
    font-size: calc(var(--font-size-base) * 0.95);
    color: var(--light-text-color);
}

body.dark-mode .toggle-form-text {
    color: var(--dark-text-color);
}

.toggle-form-btn {
    background: none;
    border: none;
    color: var(--primary-color);
    cursor: pointer;
    font-size: calc(var(--font-size-base) * 0.95);
    text-decoration: underline;
    font-weight: 600;
    padding: 0;
    transition: color 0.2s ease;
}

.toggle-form-btn:hover {
    color: var(--secondary-color);
}

body.dark-mode .toggle-form-btn {
    color: var(--dark-accent-color);
}

body.dark-mode .toggle-form-btn:hover {
    color: var(--dark-primary-color);
}

.auth-error {
    margin-top: 15px;
    padding: 12px;
    background: #fee;
    border: 1px solid #fcc;
    border-radius: 8px;
    color: #c33;
    font-size: calc(var(--font-size-base) * 0.95);
}

body.dark-mode .auth-error {
    background: rgba(220, 53, 69, 0.2);
    border-color: rgba(220, 53, 69, 0.4);
    color: #ff6b6b;
}

.connection-status.disconnected {
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
}

.category-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 1px solid rgba(0,0,0,0.1);
    z-index: 1100;
    display: flex;
}

.category-nav-btn {
    flex: 1;
    background: transparent;
    border: none;
    padding: 10px 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    color: #555;
}

.category-nav-btn.active {
    color: #1a4d2e;
    font-weight: 700;
}

.category-nav-btn i { font-size: 14px; }

.category-panel { display: none; }
.category-panel.active { display: block; }

.secondary-panel {
    display: none;
    padding: 12px;
    margin-bottom: 72px;
}

.secondary-panel.active {
    display: block;
}

.additions-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin-bottom: 12px;
}

.additions-list { list-style: none; padding: 0; margin: 0; }
.additions-list li {
    background: linear-gradient(135deg, #ffffff, #f5f7f9);
    border-radius: 14px;
    padding: 12px;
    margin-bottom: 10px;
    border: 1px solid rgba(26, 77, 46, 0.18);
    box-shadow: 0 6px 16px rgba(0,0,0,0.08);
}

.entry-actions { display:flex; gap:8px; margin-top:8px; }

.secondary-panel {
    background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(247,249,251,0.95));
    border: 1px solid rgba(26, 77, 46, 0.12);
    border-radius: 16px;
    width: min(100%, 1220px);
    margin-inline: auto;
}

.secondary-panel h3 {
    margin-bottom: 10px;
    color: #1a4d2e;
}
.secondary-panel-note {
    margin: 0 0 12px;
    color: #35533f;
    font-size: 0.92rem;
}

#additionsDashboard, #extrasDashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 180px));
    justify-content: center;
    gap: 12px;
    padding-top: 10px;
    margin: 0 auto;
    width: min(100%, 1180px);
}

#additionsDashboard .input-group, #extrasDashboard .input-group {
    margin-bottom: 0;
    padding: 10px;
    border-radius: 12px;
    min-height: 0;
}

#additionsDashboard .input-group label,
#extrasDashboard .input-group label {
    font-size: 0.95rem;
    margin-bottom: 6px;
}

#additionsDashboard .input-group input,
#additionsDashboard .input-group select,
#extrasDashboard .input-group input,
#extrasDashboard .input-group select {
    padding: 7px 8px;
    font-size: 0.95rem;
}

#additionsDashboard .input-group button,
#extrasDashboard .input-group button {
    margin-top: 6px;
    padding: 8px 10px;
    font-size: 0.95rem;
}

.secondary-banner-shell {
    background: linear-gradient(145deg, rgba(255,255,255,0.96), rgba(244,249,246,0.95));
    border: 1px solid rgba(26, 77, 46, 0.18);
    border-radius: 18px;
    box-shadow: 0 10px 24px rgba(20, 51, 35, 0.14);
    padding: 12px;
}

.secondary-history-actions button,
.secondary-input-row .undo-button,
.secondary-input-row .history-upload-btn,
.yearly-report-actions .download-pdf-btn,
.year-selector button {
    border: none;
    border-radius: 12px;
    padding: 10px 14px;
    font-weight: 700;
    background: linear-gradient(135deg, #1a4d2e, #2f7a4b);
    color: #fff;
    box-shadow: 0 6px 16px rgba(26, 77, 46, 0.25);
}

.secondary-input-row .undo-button {
    background: linear-gradient(135deg, #8b1f2d, #c23a4a);
}

.secondary-input-row .history-upload-btn {
    background: linear-gradient(135deg, #1d5a8c, #2d8fd9);
}

.year-selector,
.yearly-report-actions {
    background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(246,250,247,0.94));
    border: 1px solid rgba(26, 77, 46, 0.16);
    border-radius: 16px;
    padding: 12px;
}

#receiptTypeFilter {
    border-radius: 12px;
    border: 1px solid rgba(26, 77, 46, 0.22);
    padding: 10px 12px;
    min-width: 155px;
    font-weight: 700;
    background: #fff;
}

body.dark-mode #receiptTypeFilter {
    background: #243036;
    border-color: rgba(255,255,255,0.18);
    color: #fff;
}

.dashboard-item-form {
    display: grid;
    gap: 8px;
    margin-top: 8px;
}

.dashboard-item-form .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(105px, 1fr));
    gap: 8px;
}

.dashboard-item-form input,
.dashboard-item-form select,
.dashboard-item-form button {
    width: 100%;
}

.secondary-action-btn {
    border: none;
    border-radius: 10px;
    padding: 9px 10px;
    background: #1a4d2e;
    color: #fff;
    font-weight: 700;
}

.addition-summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    margin: 6px 0 10px;
    font-weight: 700;
}

.addition-quick-update {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px;
    margin-top: 8px;
}

.addition-history {
    margin-top: 10px;
    border-top: 1px dashed rgba(26, 77, 46, 0.25);
    padding-top: 10px;
}

.addition-history[hidden] { display: none; }

.history-row {
    background: rgba(26, 77, 46, 0.06);
    border-radius: 10px;
    padding: 8px;
    margin-bottom: 8px;
}

.secondary-input-card {
    background: linear-gradient(135deg, #ffffff, #f7faf8);
    border: 1px solid rgba(26, 77, 46, 0.18);
    border-radius: 16px;
    padding: 14px;
    margin-bottom: 14px;
}

.secondary-input-card h4 {
    margin: 0 0 10px;
    color: #1a4d2e;
}

.secondary-input-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 8px;
    margin-bottom: 8px;
}

.secondary-dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
    gap: 10px;
}

.secondary-dashboard-item {
    background: linear-gradient(135deg, #fff, #f5f8f7);
    border: 1px solid rgba(26, 77, 46, 0.2);
    border-radius: 14px;
    padding: 12px;
    cursor: pointer;
}

.secondary-dashboard-item h4 {
    margin: 0 0 6px;
}

.secondary-history-modal-content {
    max-width: 760px;
}

.secondary-history-rows {
    max-height: 55vh;
    overflow-y: auto;
    margin-top: 10px;
}

.secondary-edit-row {
    border: 1px solid rgba(26, 77, 46, 0.2);
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 8px;
    background: rgba(26, 77, 46, 0.04);
}

.secondary-history-total {
    margin-top: 12px;
    font-weight: 700;
}

.secondary-history-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
}

.project-summary-modal-content {
    max-width: 980px;
}

.project-summary-marquee {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 10px 0 6px;
}

.project-summary-pill {
    white-space: nowrap;
    background: rgba(26, 77, 46, 0.09);
    border: 1px solid rgba(26, 77, 46, 0.25);
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 0.86rem;
}

.project-summary-table-wrap {
    max-height: 58vh;
    overflow: auto;
    margin-top: 10px;
    border: 1px solid rgba(26, 77, 46, 0.18);
    border-radius: 12px;
}

.project-summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.project-summary-table th,
.project-summary-table td {
    border-bottom: 1px solid rgba(26, 77, 46, 0.14);
    padding: 8px 10px;
    text-align: right;
    vertical-align: top;
}

.project-summary-table th {
    position: sticky;
    top: 0;
    background: #f4f7f5;
    z-index: 1;
}

body.dark-mode .project-summary-pill {
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.18);
}

body.dark-mode .project-summary-table-wrap {
    border-color: rgba(255,255,255,0.18);
}

body.dark-mode .project-summary-table th {
    background: #222b2f;
}

body.dark-mode .secondary-panel {
    background: linear-gradient(135deg, #21282b, #2a3337);
    border-color: rgba(255,255,255,0.12);
}


body.dark-mode .secondary-banner-shell,
body.dark-mode .year-selector,
body.dark-mode .yearly-report-actions {
    background: linear-gradient(145deg, rgba(35,43,47,0.96), rgba(28,35,39,0.95));
    border-color: rgba(255,255,255,0.14);
}


body.dark-mode .additions-list li,
body.dark-mode .history-row {
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.16);
}

@media (min-width: 769px) {
    .category-nav {
        top: 0;
        bottom: auto;
        justify-content: center;
        gap: 22px;
        padding: 10px;
    }
    .category-nav-btn {
        max-width: 130px;
        border: 1px solid rgba(0,0,0,0.1);
        border-radius: 999px;
    }
    .secondary-panel { margin-top: 64px; margin-bottom: 0; }
    body { padding-top: 62px; }
    .hamburger-menu-btn { z-index: 1300; }
    .sidebar { z-index: 1250; }
    .project-details-card { z-index: 1200; }
    .category-nav { z-index: 1000; }

    .dashboard-section { bottom: 0; }
}

@media (max-width: 768px) {
    .secondary-input-row input,
    .secondary-input-row select,
    #additionsPanel .input-group input,
    #additionsPanel .input-group select,
    #extrasPanel .input-group input,
    #extrasPanel .input-group select {
        border-radius: 14px;
        border: 1px solid rgba(26, 77, 46, 0.25);
        background: linear-gradient(135deg, #fff, #f6faf7);
        padding: 11px 12px;
    }

    .secondary-input-row button,
    #additionsPanel .input-group button,
    #extrasPanel .input-group button {
        border-radius: 12px;
    }

    #additionsDashboard .input-group,
    #extrasDashboard .input-group {
        width: 100%;
    }

    #additionsDashboard,
    #extrasDashboard {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 8px;
    }

    .dashboard-item {
        flex: 0 0 96px;
        min-width: 96px;
        max-width: 96px;
    }
}


@media (max-width: 768px) {
    .login-modal-content {
        width: 95%;
        padding: 25px;
    }
}

    </style>
</head>
<body class="preload">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border"></div>
            <p id="loadingText">טוען...</p>
        </div>
    </div>
    <div id="cloudSyncIndicator" class="cloud-sync-indicator">
        <span class="sr-only" id="cloudSyncIndicatorText" aria-live="polite" aria-atomic="true"></span>
    </div>
    
    <script>
        // UI Helper Functions
        function showLoading(message = 'טוען...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (overlay) {
                if (text) text.textContent = message;
                overlay.style.display = 'flex';
            }
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `app-notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
    </script>

    <!-- Login/Registration Modal -->
    <div id="authModal" class="modal" style="display: none;">
        <div class="modal-content login-modal-content">
            <span class="close-button" onclick="closeAuthModal()">&times;</span>
            <h2 id="authModalTitle">התחבר למערכת</h2>
            
            <!-- Google Sign-In Button -->
            <button id="googleSignInBtn" class="google-signin-btn">
                <i class="fab fa-google"></i>
                התחבר עם Google
            </button>
            
            <div class="divider-or">
                <span>או</span>
            </div>
            
            <!-- Email/Password Login Form -->
            <form id="loginForm" style="display: block;">
                <input type="email" id="loginEmail" class="auth-input" placeholder="אימייל" required>
                <input type="password" id="loginPassword" class="auth-input" placeholder="סיסמה" required>
                <button type="submit" class="auth-submit-btn">התחבר</button>
                <p class="toggle-form-text">
                    אין לך חשבון? 
                    <button type="button" class="toggle-form-btn" onclick="toggleAuthForm()">הירשם כאן</button>
                </p>
            </form>
            
            <!-- Email/Password Registration Form -->
            <form id="registerForm" style="display: none;">
                <input type="email" id="registerEmail" class="auth-input" placeholder="אימייל" required>
                <input type="password" id="registerPassword" class="auth-input" placeholder="סיסמה (לפחות 6 תווים)" required minlength="6">
                <input type="password" id="registerPasswordConfirm" class="auth-input" placeholder="אימות סיסמה" required minlength="6">
                <button type="submit" class="auth-submit-btn">הירשם</button>
                <p class="toggle-form-text">
                    כבר יש לך חשבון? 
                    <button type="button" class="toggle-form-btn" onclick="toggleAuthForm()">התחבר כאן</button>
                </p>
            </form>
            
            <div id="authError" class="auth-error" style="display: none;"></div>
        </div>
    </div>

    <div class="hamburger-menu-btn" id="hamburgerBtn">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle-handle" onclick="toggleSidebar()">
            <i class="fas fa-angle-double-left" id="sidebarToggleIcon"></i>
        </div>
        <ul>
            <li><a href="#" onclick="closeSidebar(); showMainContent();">ראשי</a></li>
            <li><button onclick="openProjectManagementModal();">ניהול פרויקטים</button></li>
            <li><button onclick="openFinanceModal();">ניהול כספים</button></li>
            <li><button onclick="openGlobalFinanceReportModal();">דוח כספי כולל</button></li>
            <li><button onclick="openFinanceYearlyModal();">דוח כספי לפי שנה</button></li>
            <li><button onclick="openInboxModal();">תיבת דואר <span id="inboxBadge" class="inbox-badge" style="display:none;">0</span></button></li>
            <li><button onclick="openRemindersModal();">תזכורות</button></li>
            <li><button onclick="openAccessModal('connect');">התחבר לחשבון אחר</button></li>
            <li><button onclick="openAccessModal('permissions');">הרשאות</button></li>
            <li class="divider"></li>
            <li><button onclick="openInstructionsModal()">הוראות</button></li>
            <li><button onclick="openTimelineModal()">ציר זמן</button></li>
            <li><button onclick="openProjectSummaryModal()">נתונים כלליים</button></li>
        </ul>
        <div class="sidebar-footer">
            <div class="auth-section">
                <div class="auth-status" id="authStatus">לא מחובר</div>
                <div class="connection-status disconnected" id="connectionStatus">
                    <i class="fas fa-circle"></i>
                    <span>ממתין להתחברות</span>
                </div>
                <button id="loginBtn">התחבר / הירשם</button>
                <button id="logoutBtn" class="logout-btn" style="display:none;">התנתק</button>
                <button id="switchBackBtn" class="switch-back-btn" style="display:none;" onclick="switchBackToOwner(); closeSidebar(); showMainContent();">
                    <i class="fas fa-user"></i>
                    חזור לחשבון שלי
                </button>
            </div>
            <div class="divider"></div>
            <div class="zoom-controls">
                <button onclick="zoomIn()">+</button>
                <button onclick="zoomOut()">-</button>
            </div>
            <div class="theme-switch">
                מצב כהה:
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div id="sharedAccessNotice" class="shared-access-notice" style="display:none;"></div>
    <!-- Reminder Popup Notification -->
    <div id="reminderPopupNotification" class="reminder-popup-notification" style="display:none;">
        <div class="reminder-popup-content">
            <div class="reminder-popup-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="reminder-popup-text">
                <h4>תזכורת!</h4>
                <p id="reminderPopupText"></p>
            </div>
            <button class="reminder-popup-close" onclick="closeReminderPopup()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <button class="card-fab" id="cardFab" aria-label="פתח כרטיס פרויקט">
        <img class="card-fab-icon" src="image_00b206.png" alt="" aria-hidden="true">
        <span class="sr-only">פתח כרטיס פרויקט</span>
    </button>
    <div class="top-section-wrapper">
        <div class="container">
            <div class="project-header">
                <h2 id="currentProjectName">פרויקט ראשי</h2>
                <input type="text" id="editProjectNameInput" style="display:none;">
            </div>
            <div class="stage-nav-container" id="stageNavContainer"></div>
        </div>
    </div>
    <div class="container">
        <div class="project-details-card" id="projectDetailsCard" style="visibility:hidden;">
            <div class="pull-handle" onclick="toggleCard()">
                <i class="fas fa-angle-double-right" id="pullHandleIcon"></i>
            </div>
            <div class="close-card-btn" onclick="closeCard()">&times;</div>
            <h4>פרטי פרויקט</h4>
            <div class="project-details-item" data-metric-id="wineName" data-section="wineDetails">
                <span class="detail-label">שם היין:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="vintageYear" data-section="wineDetails">
                <span class="detail-label">שנה:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="grapeVariety" data-section="wineDetails">
                <span class="detail-label">זן הענבים:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="vineyardSource" data-section="wineDetails">
                <span class="detail-label">מקור הענבים:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="generalNotes" data-section="wineDetails">
                <span class="detail-label">הערות נוספות:</span>
                <span class="detail-value editable">--</span>
            </div>
            <div class="project-details-item" data-metric-id="harvestDate" data-section="wineDetails">
                <span class="detail-label">תאריך בציר:</span>
                <span class="detail-value editable">--</span>
            </div>
            <button class="add-custom-property-btn" onclick="addCustomProperty()">+ הוסף שדה מותאם אישית</button>
        </div>
        <div id="currentStageContent">
            <div class="input-section" id="currentStageInputSection"></div>
        </div>
        <div class="stage-overview-container" id="stageOverviewContainer" style="display: none;">
            <h4>נתונים משלבים קודמים</h4>
            <div class="step-cards-grid" id="stepCardsGrid"></div>
        </div>
        <div id="mobileStageMetricSeparator" class="mobile-stage-metric-separator" aria-hidden="true"></div>
    </div>
    <div class="dashboard-section category-panel active" id="fixedDashboardSection">
        <button class="dashboard-collapse-btn" id="dashboardCollapseBtn" onclick="toggleMobileDashboardCollapse()" aria-label="הסתר/הצג דשבורד תחתון">
            <i class="fas fa-chevron-down"></i>
        </button>
        <h2 id="fixedDashboardStageName"></h2>
        <div class="dashboard-grid" id="fixedDashboardGrid"></div>
    <div class="add-data-cube" id="categoryAddCube" onclick="handleCategoryAddAction()">
            <i class="fas fa-plus"></i>
            <span>הוסף מדד</span>
        </div>
    </div>
    <div class="secondary-panel category-panel" id="additionsPanel">
        <div id="additionsDashboard" class="secondary-banner-shell"></div>
    </div>
    <div class="secondary-panel category-panel" id="extrasPanel">
        <div id="extrasDashboard" class="secondary-banner-shell"></div>
    </div>
    <nav class="category-nav" id="categoryNav">
        <button class="category-nav-btn active" data-category="metrics" onclick="switchCategory('metrics')"><i class="fas fa-chart-line"></i><span>מדדים</span></button>
        <button class="category-nav-btn" data-category="additions" onclick="switchCategory('additions')"><i class="fas fa-flask"></i><span>תוספות</span></button>
        <button class="category-nav-btn" data-category="extras" onclick="switchCategory('extras')"><i class="fas fa-list-check"></i><span>נתונים נוספים</span></button>
    </nav>
        <div id="addMetricModal" class="modal">
            <div class="modal-content add-metric-modal-content">
                <span class="close-button" onclick="closeAddMetricModal()">&times;</span>
                <h3><i class="fas fa-chart-line"></i> הוסף מדד חדש לשלב הנוכחי</h3>
                <label for="addMetricName"><i class="fas fa-tag"></i> שם המדד:</label>
                <input type="text" id="addMetricName" placeholder="למשל: בריקס נוסף">
                <button onclick="addNewMetric()"><i class="fas fa-plus"></i> הוסף</button>
            </div>
        </div>
        <div id="newProjectModal" class="modal">
            <div class="modal-content project-modal-content">
                <span class="close-button" onclick="closeNewProjectModal()">&times;</span>
                <h3>פרויקט חדש</h3>
                <label for="newProjectNameInput">שם הפרויקט:</label>
                <input type="text" id="newProjectNameInput" placeholder="למשל: יקב חדש">
                <div class="modal-actions">
                    <button onclick="confirmAddNewProject()">צור</button>
                    <button onclick="closeNewProjectModal()">ביטול</button>
                </div>
            </div>
        </div>
        <div id="customPropertyModal" class="modal">
            <div class="modal-content custom-property-modal-content">
                <span class="close-button" onclick="closeCustomPropertyModal()">&times;</span>
                <h3>שדה מותאם אישית</h3>
                <label for="customPropertyNameInput">שם השדה:</label>
                <input type="text" id="customPropertyNameInput" placeholder="למשל: זן נוסף">
                <div class="modal-actions">
                    <button onclick="confirmAddCustomProperty()">הוסף</button>
                    <button onclick="closeCustomPropertyModal()">ביטול</button>
                </div>
            </div>
        </div>
        <div id="financeEditModal" class="modal">
            <div class="modal-content finance-modal-content">
                <span class="close-button" onclick="closeFinanceEditModal()">&times;</span>
                <h3>עריכת תנועה כספית</h3>
                <label for="financeEditAmount">סכום:</label>
                <input type="number" id="financeEditAmount" step="0.01" min="0">
                <label for="financeEditNotes">הערות:</label>
                <textarea id="financeEditNotes" rows="3" placeholder="הערות (אופציונלי)"></textarea>
                <div class="modal-actions">
                    <button onclick="saveFinanceEdit()">שמור</button>
                    <button onclick="closeFinanceEditModal()">ביטול</button>
                </div>
            </div>
        </div>
    <div id="historyModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeHistoryModal()">&times;</span>
                <h3 id="modalTitle"></h3>
            <div class="graph-controls">
                <button id="deleteMetricBtn" onclick="handleDeleteMetric()" aria-label="מחק מדד מותאם">מחק מדד</button>
                <button onclick="openProjectSelectionForComparison()">השווה לפרויקט אחר</button>
            </div>
            <div class="modal-graph-container">
                <svg class="modal-graph-svg" id="modalGraphSvg"></svg>
            </div>
            <ul id="historyList" class="history-list"></ul>
        </div>
    </div>
    <div id="secondaryHistoryModal" class="modal">
        <div class="modal-content secondary-history-modal-content">
            <span class="close-button" onclick="closeSecondaryHistoryModal()">&times;</span>
            <h3 id="secondaryHistoryTitle"></h3>
            <div id="secondaryHistoryRows" class="secondary-history-rows"></div>
            <div id="secondaryHistoryTotal" class="secondary-history-total"></div>
            <div class="secondary-history-actions">
                <button class="download-pdf-btn" onclick="downloadSecondaryHistory()"><i class="fas fa-download"></i> הורדה</button>
                <button onclick="addEntryFromSecondaryHistory()"><i class="fas fa-plus"></i> הוסף רשומה</button>
            </div>
        </div>
    </div>
    <div id="projectSummaryModal" class="modal">
        <div class="modal-content project-summary-modal-content">
            <span class="close-button" onclick="closeProjectSummaryModal()">&times;</span>
            <h3><i class="fas fa-table"></i> נתונים כלליים לפרויקט</h3>
            <div id="projectSummaryMarquee" class="project-summary-marquee"></div>
            <div class="project-summary-table-wrap">
                <table class="project-summary-table">
                    <thead>
                        <tr><th>קטגוריה</th><th>שם</th><th>עדכון אחרון</th><th>פרטים</th></tr>
                    </thead>
                    <tbody id="projectSummaryTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="projectManagementModal" class="modal">
        <div class="modal-content project-modal-content">
            <span class="close-button" onclick="closeProjectManagementModal()">&times;</span>
            <h3>ניהול פרויקטים</h3>
            <div class="project-filter">
                <label for="projectYearFilter">סינון לפי שנה:</label>
                <select id="projectYearFilter">
                    <option value="all">כל השנים</option>
                </select>
            </div>
            <ul id="projectList" class="project-list"></ul>
            <button class="add-project-btn" onclick="addNewProject()">+ כרטיסייה חדשה</button>
        </div>
    </div>
    <div id="accessModal" class="modal">
        <div class="modal-content access-modal-content">
            <span class="close-button" onclick="closeAccessModal()">&times;</span>
            <h3><i class="fas fa-user-shield"></i> ניהול גישה</h3>
            <div class="access-tabs">
                <button class="access-tab active" data-tab="connect">
                    <i class="fas fa-link"></i>
                    התחבר לחשבון
                </button>
                <button class="access-tab" data-tab="permissions">
                    <i class="fas fa-user-lock"></i>
                    הרשאות
                </button>
            </div>
            <div id="accessConnectTab" class="access-tab-content active">
                <div class="access-section add-user-section">
                    <h4><i class="fas fa-user-plus"></i> חיבור לחשבון אחר</h4>
                    <p class="section-description">הזן את כתובת האימייל של החשבון שאליו ברצונך להתחבר.</p>
                    <div class="form-group">
                        <label for="connectAccountEmail"><i class="fas fa-at"></i> אימייל החשבון המבוקש</label>
                        <input type="email" id="connectAccountEmail" placeholder="example@wine.com">
                    </div>
                    <div class="form-group">
                        <label for="connectUserEmail"><i class="fas fa-envelope"></i> האימייל שלך</label>
                        <input type="email" id="connectUserEmail" disabled>
                    </div>
                    <button class="btn-primary" id="connectAccountBtn"><i class="fas fa-plug"></i> בדוק והתחבר</button>
                </div>
                <hr class="section-divider">
                <div class="access-section">
                    <button type="button" class="btn-secondary" onclick="switchBackToOwner()"><i class="fas fa-rotate-left"></i> חזור לחשבון שלי</button>
                </div>
                <div class="access-section">
                    <h4><i class="fas fa-user-friends"></i> חשבונות מחוברים</h4>
                    <div class="connected-accounts-container">
                        <ul id="connectedAccountsList" class="connected-accounts-list"></ul>
                    </div>
                </div>
            </div>
            <div id="accessPermissionsTab" class="access-tab-content">
                <div class="access-section add-user-section">
                    <h4><i class="fas fa-user-check"></i> הענקת הרשאות</h4>
                    <p class="section-description">אפשרו למשתמשים אחרים גישה מוגבלת לפרויקטים שלכם.</p>
                    <div class="form-group">
                        <label for="permissionUserEmail"><i class="fas fa-at"></i> אימייל המשתמש</label>
                        <input type="email" id="permissionUserEmail" placeholder="example@wine.com">
                    </div>
                    <div class="form-group">
                        <label for="permissionProject"><i class="fas fa-folder-open"></i> פרויקט מורשה</label>
                        <select id="permissionProject">
                            <option value="all">כל הפרויקטים</option>
                        </select>
                    </div>
                    <div class="permissions-container">
                        <div class="permission-option">
                            <input type="radio" name="permissionLevel" id="permissionView" value="view" checked>
                            <label for="permissionView">
                                <span class="perm-title"><i class="fas fa-eye"></i> צפייה בלבד</span>
                                <span class="perm-desc">גישה לקריאה ללא אפשרות עריכה.</span>
                            </label>
                        </div>
                        <div class="permission-option">
                            <input type="radio" name="permissionLevel" id="permissionEdit" value="edit">
                            <label for="permissionEdit">
                                <span class="perm-title"><i class="fas fa-pen"></i> עריכה</span>
                                <span class="perm-desc">גישה לעריכת נתונים בפרויקט המורשה.</span>
                            </label>
                        </div>
                    </div>
                    <label class="checkbox-label">
                        <input type="checkbox" id="permissionFinance">
                        <span><i class="fas fa-shekel-sign"></i> גישה לניהול כספים</span>
                    </label>
                    <button class="btn-primary" id="grantAccessBtn"><i class="fas fa-save"></i> שמור הרשאה</button>
                </div>
                <hr class="section-divider">
                <div class="access-section active-users-section">
                    <h4><i class="fas fa-users"></i> משתמשים מורשים</h4>
                    <div class="users-list-container">
                        <ul id="permissionsList" class="active-users-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="financeModal" class="modal">
        <div class="modal-content finance-modal-content">
            <span class="close-button" onclick="closeFinanceModal()">&times;</span>
            <h3>ניהול כספים</h3>
            <div class="finance-input-group">
                <label for="financeAmount">סכום:</label>
                <input type="number" id="financeAmount" placeholder="הכנס סכום">
                <label for="financeNotes">הערות:</label>
                <textarea id="financeNotes" placeholder="הכנס הערות (אופציונלי)" rows="3"></textarea>
                <div class="image-upload-section" style="margin:10px 0;">
                    <label for="financeAttachmentUpload"><i class="fas fa-paperclip"></i> קבלות/חשבוניות (תמונה או PDF)</label>
                    <div class="image-upload-buttons">
                        <button type="button" onclick="openFinanceAttachmentPicker()" class="image-upload-btn">
                            <i class="fas fa-upload"></i> העלה קובץ
                        </button>
                        <button type="button" onclick="openFinanceCameraCapture()" class="camera-btn">
                            <i class="fas fa-camera"></i> צלם קבלה
                        </button>
                    </div>
                    <input type="file" id="financeAttachmentUpload" accept=".jpg,.jpeg,.png,.webp,.heic,.heif,.pdf,application/pdf" style="display:none;" onchange="handleFinanceAttachmentSelection()">
                    <div id="financeAttachmentPreview" style="font-size:12px; color:var(--light-text-color); margin-top:6px; display:none;"></div>
                </div>
                <div class="image-upload-section" style="margin:10px 0;">
                    <label for="generalImageUpload"><i class="fas fa-images"></i> תמונות כלליות</label>
                    <div class="image-upload-buttons">
                        <button type="button" onclick="openGeneralImagePicker()" class="image-upload-btn">
                            <i class="fas fa-image"></i> העלה תמונה כללית
                        </button>
                    </div>
                    <input type="file" id="generalImageUpload" accept="image/*" style="display:none;" onchange="uploadGeneralProjectImage()">
                    <ul id="generalImagesList" class="finance-attachments-list"></ul>
                </div>
                <div class="finance-input-buttons">
                    <button class="add-income-btn" onclick="addFinanceEntry('income')">הוסף הכנסה</button>
                    <button class="add-expense-btn" onclick="addFinanceEntry('expense')">הוסף הוצאה</button>
                </div>
            </div>
            <ul id="financeList" class="finance-list"></ul>
            <div class="finance-balance-total">
                יתרה נוכחית: <span id="currentBalance">0</span>
            </div>
        </div>
    </div>
    <div id="globalFinanceReportModal" class="modal">
        <div class="modal-content global-finance-modal-content">
            <span class="close-button" onclick="closeGlobalFinanceReportModal()">&times;</span>
            <h3>דוח כספי כולל (כל הפרויקטים)</h3>
            <div class="global-finance-report-summary">
                <div class="total-income">סה"כ הכנסות: <span id="globalTotalIncome">0</span></div>
                <div class="total-expense">סה"כ הוצאות: <span id="globalTotalExpense">0</span></div>
                <div class="total-balance">יתרה כוללת: <span id="globalTotalBalance">0</span></div>
            </div>
            <div class="yearly-report-actions" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-bottom:12px;">
                <button class="download-pdf-btn" onclick="openFinanceMediaListModal('global')">קבלות/תמונות</button>
            </div>
            <div id="globalFinanceProjectsDetails"></div>
            <button class="download-pdf-btn" onclick="downloadGlobalFinancePDF()">הורד כ-PDF</button>
        </div>
    </div>
    <div id="financeYearlyModal" class="modal">
        <div class="modal-content finance-yearly-modal-content">
            <span class="close-button" onclick="closeFinanceYearlyModal()">&times;</span>
            <h3>דוח כספי לפי שנה</h3>
            <div class="year-selector secondary-banner-shell">
                <label for="yearSelect">בחר שנה:</label>
                <select id="yearSelect"></select>
                <label for="monthSelect">בחר חודש:</label>
                <select id="monthSelect">
                    <option value="all" selected>כל השנה</option>
                    <option value="1">ינואר</option>
                    <option value="2">פברואר</option>
                    <option value="3">מרץ</option>
                    <option value="4">אפריל</option>
                    <option value="5">מאי</option>
                    <option value="6">יוני</option>
                    <option value="7">יולי</option>
                    <option value="8">אוגוסט</option>
                    <option value="9">ספטמבר</option>
                    <option value="10">אוקטובר</option>
                    <option value="11">נובמבר</option>
                    <option value="12">דצמבר</option>
                </select>
                <button onclick="generateYearlyReport()">צור דוח</button>
            </div>
            <div id="yearlyReportContent" style="display:none;">
                <div class="finance-yearly-report-summary">
                    <div class="total-income">סה"כ הכנסות: <span id="yearlyTotalIncome">0</span></div>
                    <div class="total-expense">סה"כ הוצאות: <span id="yearlyTotalExpense">0</span></div>
                    <div class="total-balance">יתרה נוכחית: <span id="yearlyTotalBalance">0</span></div>
                </div>
                <div id="yearlyFinanceProjectsDetails"></div>
                <div class="yearly-report-actions secondary-banner-shell" style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
                    <select id="receiptTypeFilter" class="project-filter-select">
                        <option value="all">קבלות: הכל</option>
                        <option value="expense">קבלות: הוצאות</option>
                        <option value="income">קבלות: הכנסות</option>
                    </select>
                    <button class="download-pdf-btn" onclick="downloadYearlyFinancePDF()">הורד כ-PDF</button>
                    <button class="download-pdf-btn" onclick="downloadYearlyReceiptsZip()">הורד את כל הקבצים</button>
                    <button class="download-pdf-btn" onclick="openFinanceMediaListModal('yearly')">קבלות/תמונות</button>
                    <button class="download-pdf-btn" onclick="shareYearlyReceipts('email')">שלח במייל</button>
                    <button class="download-pdf-btn" onclick="shareYearlyReceipts('whatsapp')">שלח ב-WhatsApp</button>
                </div>
            </div>
        </div>
    </div>
    <div id="financeMediaListModal" class="modal">
        <div class="modal-content finance-yearly-modal-content">
            <span class="close-button" onclick="closeFinanceMediaListModal()">&times;</span>
            <h3 id="financeMediaListTitle">קבצים מצורפים</h3>
            <ul id="financeMediaList" class="history-list"></ul>
        </div>
    </div>
    <div id="mediaPreviewModal" class="modal">
        <div class="modal-content media-preview-content">
            <span class="close-button" onclick="closeMediaPreviewModal()">&times;</span>
            <h3 id="mediaPreviewTitle">תצוגת קובץ</h3>
            <div id="mediaPreviewBody" class="media-preview-body"></div>
        </div>
    </div>
    <div id="inboxModal" class="reminders-modal">
        <div class="reminders-modal-content">
            <span class="close-button" onclick="closeInboxModal()">&times;</span>
            <h3>תיבת דואר</h3>
            <ul id="inboxList" class="reminders-list"></ul>
        </div>
    </div>
    <div id="remindersModal" class="reminders-modal">
        <div class="reminders-modal-content">
            <span class="close-button" onclick="closeRemindersModal()">&times;</span>
            <h3>תזכורות</h3>
            <div class="add-reminder-form">
                <input type="text" id="reminderText" placeholder="טקסט התזכורת">
                <input type="datetime-local" id="reminderDateTime">
                <label><input type="checkbox" id="reminderPopup"> הצג כהודעה קופצת בדפדפן</label>
                <div class="sound-selection">
                    <label for="reminderSound">צליל תזכורת:</label>
                    <select id="reminderSound">
                        <option value="none">ללא צליל</option>
                        <option value="alarm1" selected>שעון מעורר 1</option>
                        <option value="alarm2">שעון מעורר 2</option>
                        <option value="bell">פעמון</option>
                        <option value="chime">צלצול עדין</option>
                    </select>
                    <button type="button" onclick="previewReminderSound()" class="preview-sound-btn">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                <div class="image-upload-section">
                    <label for="reminderImageUpload">
                        <i class="fas fa-image"></i> העלה תמונה (אופציונלי):
                    </label>
                    <div class="image-upload-buttons">
                        <input type="file" id="reminderImageUpload" accept="image/*" style="display:none;" onchange="handleReminderImageSelect(event)">
                        <button type="button" onclick="triggerFilePickerById('reminderImageUpload')" class="image-upload-btn">
                            <i class="fas fa-folder-open"></i> בחר קובץ
                        </button>
                        <button type="button" onclick="openCameraForReminder()" class="camera-btn">
                            <i class="fas fa-camera"></i> צלם
                        </button>
                    </div>
                    <div id="reminderImagePreview" class="image-preview" style="display:none;">
                        <img id="reminderPreviewImg" src="" alt="תצוגה מקדימה">
                        <button type="button" onclick="removeReminderImage()" class="remove-image-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <button id="addReminderBtn" onclick="addReminder()">הוסף תזכורת</button>
            </div>
            <ul id="remindersList" class="reminders-list"></ul>
        </div>
    </div>
    <div id="instructionsModal" class="modal">
        <div class="modal-content instructions-modal-content">
            <span class="close-button" onclick="closeInstructionsModal()">&times;</span>
            <h3>הוראות שימוש באתר</h3>
            <p>ברוכים הבאים למערכת ניטור וניהול יין! כאן תוכלו לעקוב אחר תהליך ייצור היין שלכם שלב אחר שלב, לנהל פרויקטים שונים, לעקוב אחר הוצאות והכנסות, ולצפות בדוחות מפורטים.</p>
            <h4>תכונות עיקריות:</h4>
            <ul>
                <li>**ניהול פרויקטים:** צרו פרויקטים שונים (לדוגמה, "קברנה 2024", "מרלו 2023") ונהלו את הנתונים עבור כל אחד בנפרד.</li>
                <li>**שלבי ייצור:** כל פרויקט מחולק לשלבי ייצור מוגדרים מראש, שלכל אחד מהם יש מדדים רלוונטיים.</li>
                <li>**הזנת מדדים:** הזינו בקלות נתונים בשדות המתאימים ולחצו "עדכן".</li>
                <li>**צפייה בהיסטוריה:** לחצו על כל שורת מדד או פריט בלוח המחוונים כדי לראות את ההיסטוריה המלאה שלו עם גרף.</li>
                <li>**עריכת שם פרויקט:** לחצו על שם הפרויקט (ליד "מערכת ניטור נתונים") כדי לערוך אותו.</li>
                <li>**כרטיסיית פרטי פרויקט:** בצד שמאל למעלה, לחצו על כל פרט (שם יין, תאריך בציר וכו') כדי לערוך אותו. ניתן גם להוסיף שדות מותאמים אישית.</li>
            </ul>
            <h4>כיצד להשתמש:</h4>
            <ul>
                <li>**תפריט המבורגר (מימין למעלה):** לחצו על האייקון (שלוש קווים) כדי לפתוח את תפריט הניווט.</li>
                <li>**מעבר בין שלבים:** השתמשו בכפתורי השלבים (לדוגמה, "בציר") כדי לעבור בין שלבי הייצור של הפרויקט הנוכחי.</li>
                <li>**ציר זמן:** צפו בכל המדידות של הפרויקט הנוכחי על גבי ציר זמן כרונולוגי אחד.</li>
                <li>**ניהול כספים:** עקבו אחר הכנסות והוצאות לכל פרויקט, וצפו ביתרה הנוכחית. ניתן לסנן לפי סוג תנועה ותאריך.</li>
                <li>**דוח כספי כולל:** קבלו סיכום פיננסי משולב מכל הפרויקטים שלכם.</li>
                <li>**תזכורות:** הוסיפו תזכורות עם טקסט ותאריך/שעה, ותקבלו הודעה בדפדפן כשהזמן מגיע.</li>
                <li>**תיבת דואר:** צפו בתזכורות שהתקבלו.</li>
                <li>**מצב כהה:** עברו למצב תצוגה כהה לנוחות מירבית.</li>
            </ul>
        </div>
    </div>
    <div id="timelineModal" class="modal">
        <div class="modal-content timeline-modal-content">
            <span class="close-button" onclick="closeTimelineModal()">&times;</span>
            <h3>ציר זמן - כל המדידות</h3>
            <div class="timeline-container" id="timelineContainer"></div>
            <button class="download-pdf-btn" onclick="downloadTimelinePDF()">הורד כ-PDF</button>
        </div>
    </div>
    <div id="datePickerModal" class="modal">
        <div class="modal-content date-picker-modal-content">
            <span class="close-button" onclick="closeDatePickerModal()">&times;</span>
            <div class="date-picker-header">
                <button id="prevMonthBtn"> &#8249; </button>
                <span id="currentMonthYear"></span>
                <button id="nextMonthBtn"> &#8250; </button>
            </div>
            <div class="date-picker-grid" id="datePickerGrid">
                <div class="date-picker-day header">א</div>
                <div class="date-picker-day header">ב</div>
                <div class="date-picker-day header">ג</div>
                <div class="date-picker-day header">ד</div>
                <div class="date-picker-day header">ה</div>
                <div class="date-picker-day header">ו</div>
                <div class="date-picker-day header">ש</div>
            </div>
        </div>
    </div>
        <div id="projectSelectionModal" class="modal">
            <div class="modal-content project-modal-content">
                <span class="close-button" onclick="closeProjectSelectionModal()">&times;</span>
                <h3>בחר פרויקט להשוואה</h3>
                <ul id="comparisonProjectList" class="project-list"></ul>
            </div>
        </div>
        <div id="confirmationModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmationTitle" aria-describedby="confirmationMessage" tabindex="-1">
            <div class="modal-content confirmation-modal-content">
                <span class="close-button" onclick="document.getElementById('confirmNoBtn').click()">&times;</span>
                <h3 id="confirmationTitle">אישור</h3>
                <p id="confirmationMessage">האם אתה בטוח?</p>
                <div class="modal-actions">
                    <button id="confirmYesBtn" class="btn-danger">כן</button>
                    <button id="confirmNoBtn" class="btn-secondary">לא</button>
                </div>
            </div>
        </div>
    <script>
        const stagesConfig = {
            'wineDetails': {
                name: 'פרטי יין',
                longName: 'פרטי יין',
                metrics: {
                    'wineName': { name: 'שם היין', type: 'text', placeholder: 'קברנה יקב הידון 2024' },
                    'vintageYear': { name: 'שנה', type: 'number', step: 1, precision: 0, placeholder: '2024' },
                    'grapeVariety': { name: 'זן הענבים', type: 'select', options: ['קברנה סוביניון', 'מרלו', 'שיראז', 'שרדונה', 'סוביניון בלאן', 'פינו נואר', 'גרנאש', 'זינפנדל','ריזלינג', 'גוורצטרמינר', 'שן בלאן', 'ויונייה', 'ברברה', 'סנג\'ובזה', 'נביולו', 'טמפרניו', 'אחר'], placeholder: 'בחר זן' },
                    'vineyardSource': { name: 'מקור הענבים', type: 'text', placeholder: 'כרם גליל עליון' },
                    'harvestDate': { name: 'תאריך בציר', type: 'date', placeholder: 'בחר תאריך' },
                    'generalNotes': { name: 'הערות נוספות', type: 'text', placeholder: 'יין בעל פוטנציאל יישון' }
                },
                customMetrics: {}
            },
            'stage1': {
                name: 'בציר',
                longName: 'בציר',
                emoji: '🟢',
                metrics: {
                    'brix': { name: 'בריקס', type: 'number', step: 0.1, precision: 1, placeholder: '22.5' },
                    'ph': { name: 'pH', type: 'number', step: 0.01, precision: 2, placeholder: '3.5' },
                    'grapeTemp': { name: 'טמפרטורת ענבים', type: 'number', step: 0.1, precision: 1, placeholder: '25.0' },
                    'ta': { name: 'חומצה כוללת', type: 'number', step: 0.01, precision: 2, placeholder: '6.8' },
                },
                metricOrder: ['brix', 'ph', 'grapeTemp', 'ta'],
                summaryMetrics: ['brix', 'ph', 'ta'],
                customMetrics: {}
            },
            'stage2': {
                name: 'ריסוק',
                longName: 'ריסוק והכנה לתסיסה',
                emoji: '🍇',
                metrics: {
                    'so2Added': { name: 'SO₂', type: 'number', step: 0.1, precision: 1, placeholder: '50' },
                    'enzymesAdded': { name: 'אנזימים', type: 'number', step: 0.1, precision: 1, placeholder: '0.8' },
                    'mixTemp': { name: 'טמפרטורת תערובת', type: 'number', step: 0.1, precision: 1, placeholder: '18.0' },
                    'skinLiquidRatio': { name: 'יחס קליפות/נוזלים', type: 'text', placeholder: '1:3' },
                    'brixStart': { name: 'בריקס התחלה', type: 'number', step: 0.1, precision: 1, placeholder: '23.0' },
                    'fermentationSync': { name: 'מצב סנכרון', type: 'text', placeholder: 'אושר' }
                },
                summaryMetrics: ['so2Added', 'mixTemp', 'brixStart'],
                customMetrics: {}
            },
            'stage3': {
                name: 'תסיסה אלכוהולית',
                longName: 'תסיסה אלכוהולית',
                emoji: '🍷',
                metrics: {
                    'brixDaily': { name: 'בריקס יומי', type: 'number', step: 0.1, precision: 1, placeholder: '15.0' },
                    'phFerment': { name: 'pH', type: 'number', step: 0.01, precision: 2, placeholder: '3.65' },
                    'fermentTemp': { name: 'טמפרטורת תסיסה', type: 'number', step: 0.1, precision: 1, placeholder: '26.5' },
                    'yeastAdded': { name: 'שמרים', type: 'text', placeholder: 'EC-1118' },
                    'yeastFoodAdded': { name: 'מזון שמרים', type: 'text', placeholder: '2 גרם/ליטר' },
                    'density': { name: 'צפיפות (SG)', type: 'number', step: 0.001, precision: 3, placeholder: '1.050' },
                    'fermentRate': { name: 'קצב תסיסה', type: 'text', placeholder: 'יציב / מהיר' },
                    'fermentStartDate': { name: 'תאריך התחלה', type: 'date', placeholder: '20/08/2024' },
                    'fermentEndDate': { name: 'תאריך סיום', type: 'date', placeholder: '30/08/2024' }
                },
                summaryMetrics: ['brixDaily', 'phFerment', 'fermentTemp', 'density'],
                customMetrics: {}
            },
            'stage4': {
                name: 'תסיסה מלולקטית',
                longName: 'תסיסה מלולקטית',
                emoji: '🔁',
                metrics: {
                    'phMLF': { name: 'pH', type: 'number', step: 0.01, precision: 2, placeholder: '3.80' },
                    'malicAcid': { name: 'חומצה מלית', type: 'text', placeholder: 'ירידה קלה' },
                    'roomTempMLF': { name: 'טמפרטורת חדר', type: 'number', step: 0.1, precision: 1, placeholder: '20.0' },
                    'mlfStatus': { name: 'מצב תסיסה', type: 'text', placeholder: 'באמצע' },
                    'bacteriaAdded': { name: 'חיידקים', type: 'text', placeholder: 'Oenococcus oeni' },
                    'tasteNotesMLF': { name: 'טעמים (רישום ידני)', type: 'text', placeholder: 'חמאתיות עדינה' }
                },
                summaryMetrics: ['phMLF', 'roomTempMLF', 'mlfStatus'],
                customMetrics: {}
            },
            'stage5': {
                name: 'יישון',
                longName: 'יישון',
                emoji: '🛢',
                metrics: {
                    'containerType': { name: 'סוג מיכל', type: 'text', placeholder: 'חבית עץ אלון צרפתי' },
                    'agingTime': { name: 'זמן יישון (ימים)', type: 'number', step: 1, precision: 0, placeholder: '180' },
                    'agingRoomTemp': { name: 'טמפרטורת חדר יישון', type: 'number', step: 0.1, precision: 1, placeholder: '15.0' },
                    'so2Control': { name: 'פקדי חמצון (SO₂)', type: 'text', placeholder: 'בדיקה חודשית' },
                    'tasteTextureNotes': { name: 'טעמים ומרקם', type: 'text', placeholder: 'עיגול טעמים, טאנינים רכים' },
                    'rackingDate': { name: 'תאריך שקיעה', type: 'date', placeholder: '01/03/2025' },
                    'rackingFrequency': { name: 'תדירות שקיעות', type: 'text', placeholder: 'כל חודשיים' }
                },
                summaryMetrics: ['containerType', 'agingTime', 'agingRoomTemp'],
                customMetrics: {}
            },
            'stage6': {
                name: 'הכנה לבקבוק',
                longName: 'הכנה לבקבוק',
                emoji: '🧪',
                metrics: {
                    'phFinal': { name: 'pH סופי', type: 'number', step: 0.01, precision: 2, placeholder: '3.75' },
                    'clarity': { name: 'צלילות', type: 'text', placeholder: 'צלול לגמרי' },
                    'bottlingDate': { name: 'תאריך בקבוק', type: 'date', placeholder: '15/05/2025' },
                    'bottleCount': { name: 'כמות בקבוקים', type: 'number', step: 1, precision: 0, placeholder: '750' },
                    'so2AddedBottle': { name: 'תוספת SO₂', type: 'number', step: 0.1, precision: 1, placeholder: '30' },
                    'alcoholLevel': { name: 'רמת אלכוהול (%)', type: 'number', step: 0.1, precision: 1, placeholder: '14.2' },
                    'batchNumber': { name: 'מספר אצווה / תווית', type: 'text', placeholder: 'יין אדום 2024A' }
                },
                summaryMetrics: ['phFinal', 'bottleCount', 'alcoholLevel'],
                customMetrics: {}
            },
        };
        // Expose stagesConfig globally for the stage-nav-fix module
        window.stagesConfig = stagesConfig;
        
        // Local-only mode - no Firebase/cloud syncing
        let projects = loadProjects();
        let currentProjectId = localStorage.getItem('currentProjectId') || Object.keys(projects)[0];
        let currentStageId = localStorage.getItem('currentStageId') || 'stage1';
        if (!currentProjectId || !projects[currentProjectId]) {
            currentProjectId = 'default_project';
            if (!projects[currentProjectId]) {
                projects[currentProjectId] = createNewProjectData('פרויקט ראשי');
            }
            localStorage.setItem('currentProjectId', currentProjectId);
        }
        if (!stagesConfig[currentStageId] || currentStageId === 'wineDetails') {
            currentStageId = 'stage1';
            localStorage.setItem('currentStageId', currentStageId);
        }
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const projectYearFilter = document.getElementById('projectYearFilter');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const currentProjectNameDisplay = document.getElementById('currentProjectName');
        const editProjectNameInput = document.getElementById('editProjectNameInput');
        const projectDetailsCard = document.getElementById('projectDetailsCard');
        const cardFab = document.getElementById('cardFab');
        const stageNavContainer = document.getElementById('stageNavContainer');
        const stageOverviewContainer = document.getElementById('stageOverviewContainer');
        const stepCardsGrid = document.getElementById('stepCardsGrid');
        const currentStageContent = document.getElementById('currentStageContent');
        const mobileStageMetricSeparator = document.getElementById('mobileStageMetricSeparator');
        const currentStageInputSection = document.getElementById('currentStageInputSection');
        const fixedDashboardSection = document.getElementById('fixedDashboardSection');
        const dashboardCollapseBtn = document.getElementById('dashboardCollapseBtn');
        const fixedDashboardStageName = document.getElementById('fixedDashboardStageName');
        const fixedDashboardGrid = document.getElementById('fixedDashboardGrid');
        const categoryAddCube = document.getElementById('categoryAddCube');
        const additionsPanel = document.getElementById('additionsPanel');
        const extrasPanel = document.getElementById('extrasPanel');
        const additionTypeInput = document.getElementById('additionType');
        const additionAmountInput = document.getElementById('additionAmount');
        const additionUnitInput = document.getElementById('additionUnit');
        const additionTimeInput = document.getElementById('additionTime');
        const additionsDashboard = document.getElementById('additionsDashboard');
        const additionStoryUploadInput = document.getElementById('additionStoryUpload');
        const extraTypeInput = document.getElementById('extraType');
        const extraNotesInput = document.getElementById('extraNotes');
        const extraTimeInput = document.getElementById('extraTime');
        const extrasDashboard = document.getElementById('extrasDashboard');
        const extraStoryUploadInput = document.getElementById('extraStoryUpload');
        const secondaryHistoryModal = document.getElementById('secondaryHistoryModal');
        const secondaryHistoryTitle = document.getElementById('secondaryHistoryTitle');
        const secondaryHistoryRows = document.getElementById('secondaryHistoryRows');
        const secondaryHistoryTotal = document.getElementById('secondaryHistoryTotal');
        const projectSummaryModal = document.getElementById('projectSummaryModal');
        const projectSummaryMarquee = document.getElementById('projectSummaryMarquee');
        const projectSummaryTableBody = document.getElementById('projectSummaryTableBody');
        const historyModal = document.getElementById('historyModal');
        const modalTitle = document.getElementById('modalTitle');
        const historyList = document.getElementById('historyList');
        const modalGraphSvg = document.getElementById('modalGraphSvg');
        const projectManagementModal = document.getElementById('projectManagementModal');
        const projectList = document.getElementById('projectList');
        const financeModal = document.getElementById('financeModal');
        const financeAmountInput = document.getElementById('financeAmount');
        const financeNotesInput = document.getElementById('financeNotes');
        const financeAttachmentInput = document.getElementById('financeAttachmentUpload');
        const financeAttachmentPreview = document.getElementById('financeAttachmentPreview');
        const generalImageUploadInput = document.getElementById('generalImageUpload');
        const generalImagesList = document.getElementById('generalImagesList');
        const financeList = document.getElementById('financeList');
        const currentBalanceDisplay = document.getElementById('currentBalance');
        const financeEditModal = document.getElementById('financeEditModal');
        const financeEditAmountInput = document.getElementById('financeEditAmount');
        const financeEditNotesInput = document.getElementById('financeEditNotes');
        const globalFinanceReportModal = document.getElementById('globalFinanceReportModal');
        const globalTotalIncomeDisplay = document.getElementById('globalTotalIncome');
        const globalTotalExpenseDisplay = document.getElementById('globalTotalExpense');
        const globalTotalBalanceDisplay = document.getElementById('globalTotalBalance');
        const globalFinanceProjectsDetails = document.getElementById('globalFinanceProjectsDetails');
        const financeYearlyModal = document.getElementById('financeYearlyModal');
        const yearlyReportContent = document.getElementById('yearlyReportContent');
        const yearlyTotalIncomeDisplay = document.getElementById('yearlyTotalIncome');
        const yearlyTotalExpenseDisplay = document.getElementById('yearlyTotalExpense');
        const yearlyTotalBalanceDisplay = document.getElementById('yearlyTotalBalance');
        const yearlyFinanceProjectsDetails = document.getElementById('yearlyFinanceProjectsDetails');
        const inboxModal = document.getElementById('inboxModal');
        const inboxList = document.getElementById('inboxList');
        const remindersModal = document.getElementById('remindersModal');
        const reminderTextInput = document.getElementById('reminderText');
        const reminderDateTimeInput = document.getElementById('reminderDateTime');
        const reminderPopupInput = document.getElementById('reminderPopup');
        const remindersList = document.getElementById('remindersList');
        const instructionsModal = document.getElementById('instructionsModal');
        const timelineModal = document.getElementById('timelineModal');
        const timelineContainer = document.getElementById('timelineContainer');
        const datePickerModal = document.getElementById('datePickerModal');
        const datePickerGrid = document.getElementById('datePickerGrid');
        const currentMonthYearDisplay = document.getElementById('currentMonthYear');
        let datePickerCurrentMonth = new Date().getMonth();
        let datePickerCurrentYear = new Date().getFullYear();
        let datePickerCallback = null;
        const projectSelectionModal = document.getElementById('projectSelectionModal');
        const comparisonProjectList = document.getElementById('comparisonProjectList');
        const newProjectModal = document.getElementById('newProjectModal');
        const newProjectNameInput = document.getElementById('newProjectNameInput');
        const customPropertyModal = document.getElementById('customPropertyModal');
        const customPropertyNameInput = document.getElementById('customPropertyNameInput');
        const deleteMetricBtn = document.getElementById('deleteMetricBtn');
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const switchBackBtn = document.getElementById('switchBackBtn');
        const authStatus = document.getElementById('authStatus');
        const connectionStatus = document.getElementById('connectionStatus');
        const cloudSyncIndicator = document.getElementById('cloudSyncIndicator');
        const cloudSyncIndicatorText = document.getElementById('cloudSyncIndicatorText');
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const emailLoginBtn = document.getElementById('emailLoginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const skipLoginBtn = document.getElementById('skipLoginBtn');
        const closeLoginBtn = document.getElementById('closeLoginBtn');
        const emailAuthForm = document.getElementById('emailAuthForm');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const accessModal = document.getElementById('accessModal');
        const accessTabs = document.querySelectorAll('.access-tab');
        const connectAccountEmailInput = document.getElementById('connectAccountEmail');
        const connectUserEmailInput = document.getElementById('connectUserEmail');
        const connectAccountBtn = document.getElementById('connectAccountBtn');
        const permissionUserEmailInput = document.getElementById('permissionUserEmail');
        const permissionProjectSelect = document.getElementById('permissionProject');
        const permissionFinanceCheckbox = document.getElementById('permissionFinance');
        const grantAccessBtn = document.getElementById('grantAccessBtn');
        const permissionsList = document.getElementById('permissionsList');
        const connectedAccountsList = document.getElementById('connectedAccountsList');
        const sharedAccessNotice = document.getElementById('sharedAccessNotice');
        
        const ALLOWED_ATTACHMENT_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/heic', 'image/heif', 'application/pdf'];
        let pendingFinanceAttachmentFile = null;
        let pendingFinanceAttachmentPreviewUrl = '';
// Image upload variables
        let selectedReminderImage = null;
        let selectedReminderImageFile = null;
        let selectedReminderImageUploadedUrl = null;
        let currentMetricTypeForModal = { sectionId: '', metricId: '' };
        let currentEditableDetailElement = null;
        let graphComparisonMode = null;
        let comparisonProjectId = null;
        let inbox = [];
        let reminders = [];

        function setProjectsData(nextProjects) {
            if (nextProjects && typeof nextProjects === 'object') {
                projects = nextProjects;
            } else {
                projects = {};
            }

            if (!projects[currentProjectId]) {
                const firstProjectId = Object.keys(projects)[0];
                currentProjectId = firstProjectId || 'default_project';
                if (!projects[currentProjectId]) {
                    projects[currentProjectId] = createNewProjectData('פרויקט ראשי');
                }
                localStorage.setItem('currentProjectId', currentProjectId);
            }

            window.projects = projects;
        }

        function setRemindersData(nextReminders) {
            reminders = Array.isArray(nextReminders) ? nextReminders : [];
            window.reminders = reminders;
        }

        function setInboxData(nextInbox) {
            inbox = Array.isArray(nextInbox) ? nextInbox : [];
            window.inbox = inbox;
        }

        function setStagesConfigData(nextConfig) {
            if (!nextConfig || typeof nextConfig !== 'object') return;
            Object.keys(stagesConfig).forEach((key) => {
                delete stagesConfig[key];
            });
            Object.assign(stagesConfig, nextConfig);
            window.stagesConfig = stagesConfig;
        }

        function syncRuntimeDataFromStorage() {
            setProjectsData(projects);
            setRemindersData(reminders);
            setInboxData(inbox);
            window.stagesConfig = stagesConfig;
        }

        window.syncRuntimeDataFromStorage = syncRuntimeDataFromStorage;
        window.setProjectsData = setProjectsData;
        window.setRemindersData = setRemindersData;
        window.setInboxData = setInboxData;
        window.setStagesConfigData = setStagesConfigData;
        syncRuntimeDataFromStorage();
        // Card transition duration - set via JS at line 4984: projectDetailsCard.style.transition = 'left 0.3s ease'
        // Used to time the delayed visibility hide after slide-out animation completes
        const CARD_TRANSITION_DURATION = 300; // milliseconds
        let cardHideTimeout = null; // Track timeout to prevent race conditions
        let cloudSyncIndicatorTimeout = null;
        // משתני הזזה לכרטיסיה
        let isDragging = false;
        let startX = 0;
        let currentX = 0;
        let cardOpen = false; // מצב הכרטיסיה: פתוח או סגור
        let editingFinanceEntryId = null;
        let sharedAccessContext = { active: false, ownerUid: null, ownerEmail: null, allowEdit: false, allowFinance: false, allowedProjectId: null };
        if (newProjectNameInput) {
            newProjectNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    confirmAddNewProject();
                }
            });
        }
        if (customPropertyNameInput) {
            customPropertyNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    confirmAddCustomProperty();
                }
            });
        }
        if (financeEditAmountInput) {
            financeEditAmountInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveFinanceEdit();
                }
            });
        }
        if (financeEditNotesInput) {
            financeEditNotesInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    saveFinanceEdit();
                }
            });
        }
        // Auth-related event listeners removed (local-only mode)
        // No login/logout/switch buttons or modal in local-only mode
        
        if (accessTabs && accessTabs.length) {
            accessTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    setActiveAccessTab(tab.dataset.tab);
                });
            });
        }
        if (connectAccountBtn) {
            connectAccountBtn.addEventListener('click', connectToAccount);
        }
        if (grantAccessBtn) {
            grantAccessBtn.addEventListener('click', grantAccessToUser);
        }
        function isProjectAllowed(projectId) {
            if (!sharedAccessContext.active) return true;
            if (!sharedAccessContext.allowedProjectId) return true;
            return sharedAccessContext.allowedProjectId === projectId;
        }
        function ensureProjectAccess(projectId) {
            if (!isProjectAllowed(projectId)) {
                alert('אין לך הרשאה לפרויקט זה לפי ההזמנה.');
                return false;
            }
            return true;
        }
        function ensureEditPermission(projectId = currentProjectId) {
            if (!ensureProjectAccess(projectId)) return false;
            if (sharedAccessContext.active && !sharedAccessContext.allowEdit) {
                alert('גישה זו היא לצפייה בלבד.');
                return false;
            }
            return true;
        }
        function ensureFinancePermission(projectId = currentProjectId) {
            if (!ensureProjectAccess(projectId)) return false;
            if (sharedAccessContext.active && !sharedAccessContext.allowFinance) {
                alert('אין לך הרשאת כספים בהזמנה זו.');
                return false;
            }
            return true;
        }
        function normalizeEmail(email) {
            return (email || '').trim().toLowerCase();
        }
        function getPermissionDocId(email) {
            return encodeURIComponent(normalizeEmail(email));
        }
        function isWebView() {
            const userAgent = navigator.userAgent || '';
            const isIOSWebView = /(iPhone|iPad|iPod)/.test(userAgent) && !/Safari/.test(userAgent);
            return /wv/.test(userAgent) || /WebView/.test(userAgent) || isIOSWebView;
        }
        function updateSharedAccessNotice() {
            if (!sharedAccessNotice) return;
            if (!sharedAccessContext.active) {
                sharedAccessNotice.style.display = 'none';
                sharedAccessNotice.classList.remove('view-only');
                sharedAccessNotice.textContent = '';
                document.body.classList.remove('view-only');
                return;
            }
            const scopeText = sharedAccessContext.allowedProjectId ? 'לפרויקט מסוים' : 'לכל הפרויקטים';
            const modeText = sharedAccessContext.allowEdit ? 'עריכה' : 'צפייה בלבד';
            const financeText = sharedAccessContext.allowFinance ? 'עם גישה לכספים' : 'ללא גישה לכספים';
            sharedAccessNotice.style.display = 'block';
            sharedAccessNotice.classList.toggle('view-only', !sharedAccessContext.allowEdit);
            sharedAccessNotice.textContent = `מחובר לחשבון של ${sharedAccessContext.ownerEmail} • ${scopeText} • ${modeText} • ${financeText}`;
            document.body.classList.toggle('view-only', !sharedAccessContext.allowEdit);
        }
        function updateAuthUi() {
            // Default signed-out state until Firebase auth state is resolved
            if (authStatus) {
                authStatus.textContent = 'לא מחובר';
            }
            if (connectionStatus) {
                const statusText = connectionStatus.querySelector('span');
                connectionStatus.className = 'connection-status disconnected';
                if (statusText) statusText.textContent = 'ממתין להתחברות';
            }
            if (loginBtn) loginBtn.style.display = 'block';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (switchBackBtn) switchBackBtn.style.display = 'none';
            updateSharedAccessNotice();
        }
        function flashCloudSyncIndicator() {
            // No cloud sync in local-only mode
            return;
        }
        function mergeStoredStagesConfig() {
            // Firebase-only mode: stagesConfig is loaded from Firestore snapshots.
        }
        
        // Local-only storage - no cloud functions needed
        // Data is saved directly to localStorage by the application code
        
        // Debounced save functions for reminders and inbox (local storage only)
        function queueRemindersSave() {
            // Firebase hooks trigger sync; no localStorage persistence in Firebase-only mode.
        }
        function queueInboxSave() {
            // Firebase hooks trigger sync; no localStorage persistence in Firebase-only mode.
        }
        function applySharedAccess(permissionData, ownerUid, ownerEmail) {
            sharedAccessContext = {
                active: true,
                ownerUid,
                ownerEmail,
                allowEdit: !!permissionData.allowEdit,
                allowFinance: !!permissionData.allowFinance,
                allowedProjectId: permissionData.projectScope && permissionData.projectScope !== 'all' ? permissionData.projectScope : null
            };
            if (typeof window.setActiveDataAccountUid === 'function') {
                window.setActiveDataAccountUid(ownerUid || null);
            }
            localStorage.setItem('sharedAccessOwnerUid', ownerUid || '');
            localStorage.setItem('sharedAccessOwnerEmail', ownerEmail || '');
            localStorage.setItem('sharedAccessPermissions', JSON.stringify(permissionData || {}));
            if (switchBackBtn) switchBackBtn.style.display = 'block';
            updateSharedAccessNotice();
        }
        function clearSharedAccess() {
            sharedAccessContext = { active: false, ownerUid: null, ownerEmail: null, allowEdit: false, allowFinance: false, allowedProjectId: null };
            if (typeof window.setActiveDataAccountUid === 'function') {
                window.setActiveDataAccountUid(null);
            }
            localStorage.removeItem('sharedAccessOwnerUid');
            localStorage.removeItem('sharedAccessOwnerEmail');
            localStorage.removeItem('sharedAccessPermissions');
            if (switchBackBtn) switchBackBtn.style.display = 'none';
            updateSharedAccessNotice();
        }

        function restoreSharedAccessFromStorage() {
            const ownerUid = localStorage.getItem('sharedAccessOwnerUid');
            const ownerEmail = localStorage.getItem('sharedAccessOwnerEmail');
            const permissionsRaw = localStorage.getItem('sharedAccessPermissions');
            if (!ownerUid || !permissionsRaw) {
                clearSharedAccess();
                return false;
            }
            try {
                const permissionData = JSON.parse(permissionsRaw) || {};
                applySharedAccess(permissionData, ownerUid, ownerEmail || permissionData.ownerEmail || '');
                return true;
            } catch (error) {
                console.warn('Failed to restore shared access context:', error);
                clearSharedAccess();
                return false;
            }
        }
        
        // Local-only mode - no authentication
        // No Firebase initialization or auth functions needed
        
        function setActiveAccessTab(tabName) {
            accessTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            const connectTab = document.getElementById('accessConnectTab');
            const permissionsTab = document.getElementById('accessPermissionsTab');
            if (connectTab) connectTab.classList.toggle('active', tabName === 'connect');
            if (permissionsTab) permissionsTab.classList.toggle('active', tabName === 'permissions');
        }
        function openAccessModal(tabName = 'connect') {
            const user = window.firebaseAccess?.getCurrentUser?.();
            if (!user) {
                showNotification('יש להתחבר לפני ניהול הרשאות.', 'error');
                return;
            }
            if (!accessModal) return;
            closeSidebar();
            setActiveAccessTab(tabName);
            if (connectUserEmailInput) connectUserEmailInput.value = user.email || '';
            populatePermissionProjectOptions();
            refreshAccessLists();
            accessModal.style.display = 'flex';
        }
        function closeAccessModal() {
            if (!accessModal) return;
            accessModal.style.display = 'none';
            showMainContent();
        }
        function populatePermissionProjectOptions() {
            if (!permissionProjectSelect) return;
            const existingValue = permissionProjectSelect.value;
            permissionProjectSelect.innerHTML = '<option value="all">כל הפרויקטים</option>';
            Object.keys(projects).forEach(projectId => {
                const option = document.createElement('option');
                option.value = projectId;
                option.textContent = projects[projectId].name || projectId;
                permissionProjectSelect.appendChild(option);
            });
            if (existingValue) {
                permissionProjectSelect.value = existingValue;
            }
        }
        // Access/permission management - not supported in local-only mode
        async function refreshPermissionsList() {
            if (!permissionsList) return;
            const api = window.firebaseAccess;
            if (!api?.listOwnerPermissions) {
                permissionsList.innerHTML = '<li class="no-users-message" role="status" aria-live="polite"><i class="fas fa-info-circle"></i> שירות ההרשאות לא זמין.</li>';
                return;
            }
            const items = await api.listOwnerPermissions();
            if (!items.length) {
                permissionsList.innerHTML = '<li class="no-users-message" role="status" aria-live="polite"><i class="fas fa-info-circle"></i> עדיין לא הוגדרו הרשאות.</li>';
                return;
            }
            permissionsList.innerHTML = items.map(item => {
                const scope = item.projectScope === 'all' ? 'כל הפרויקטים' : (projects[item.projectScope]?.name || item.projectScope);
                const collaboratorUid = item.collaboratorUid || item.id;
                const safeEmail = item.collaboratorEmail || '';
                return `<li class="user-access-item" role="button" tabindex="0" data-collaborator-uid="${collaboratorUid}" data-collaborator-email="${safeEmail}"><div><strong>${safeEmail}</strong><div class="user-permissions"><span class="permission-badge ${item.allowEdit ? 'edit':'view'}">${item.allowEdit ? 'עריכה' : 'צפייה'}</span><span class="permission-badge project">${scope}</span><span class="permission-badge ${item.allowFinance ? 'finance-yes':'finance-no'}">${item.allowFinance ? 'כספים: כן':'כספים: לא'}</span></div></div><i class="fas fa-user-minus" title="בטל הרשאה"></i></li>`;
            }).join('');

            permissionsList.querySelectorAll('.user-access-item').forEach((itemEl) => {
                const handleRevoke = async () => {
                    const collaboratorUid = itemEl.dataset.collaboratorUid;
                    const collaboratorEmail = itemEl.dataset.collaboratorEmail || 'משתמש זה';
                    if (!collaboratorUid) return;
                    const shouldRevoke = window.confirm(`לבטל את ההרשאה עבור ${collaboratorEmail}?`);
                    if (!shouldRevoke) return;
                    await revokeAccessForCollaborator(collaboratorUid, collaboratorEmail);
                };

                itemEl.addEventListener('click', handleRevoke);
                itemEl.addEventListener('touchend', (event) => {
                    event.preventDefault();
                    handleRevoke();
                }, { passive: false });
                itemEl.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        handleRevoke();
                    }
                });
            });
        }

        async function revokeAccessForCollaborator(collaboratorUid, collaboratorEmail) {
            const api = window.firebaseAccess;
            if (!api?.revokeAccessPermission) {
                showNotification('שירות ביטול ההרשאות לא זמין כרגע.', 'error');
                return;
            }
            try {
                await api.revokeAccessPermission({ collaboratorUid });
                showNotification(`ההרשאה עבור ${collaboratorEmail} בוטלה.`, 'success');
                await refreshAccessLists();
            } catch (error) {
                const map = {
                    AUTH_REQUIRED: 'יש להתחבר כדי לבטל הרשאות.',
                    COLLABORATOR_REQUIRED: 'לא נבחר משתמש תקין לביטול הרשאה.'
                };
                showNotification(map[error.message] || 'ביטול ההרשאה נכשל.', 'error');
            }
        }
        async function renderConnectedAccountsList() {
            if (!connectedAccountsList) return;
            const api = window.firebaseAccess;
            if (!api?.listSharedWithMe) {
                connectedAccountsList.innerHTML = '<li class="no-users-message" role="status" aria-live="polite"><i class="fas fa-info-circle"></i> שירות החשבונות לא זמין.</li>';
                return;
            }
            const items = await api.listSharedWithMe();
            if (!items.length) {
                connectedAccountsList.innerHTML = '<li class="no-users-message" role="status" aria-live="polite"><i class="fas fa-info-circle"></i> אין חשבונות זמינים לחיבור.</li>';
                return;
            }
            connectedAccountsList.innerHTML = items.map(item => {
                const ownerEmail = item.ownerEmail || '';
                return `<li class="user-access-item"><div><strong>${ownerEmail}</strong><div class="account-permissions"><span class="permission-badge ${item.allowEdit ? 'edit':'view'}">${item.allowEdit ? 'עריכה' : 'צפייה'}</span></div></div><div class="user-actions"><button type="button" class="btn-edit connect-account-btn" data-owner-email="${ownerEmail}"><i class="fas fa-right-to-bracket"></i></button></div></li>`;
            }).join('');
            connectedAccountsList.querySelectorAll('.connect-account-btn').forEach((btn) => {
                btn.addEventListener('click', async () => {
                    const email = btn.dataset.ownerEmail || '';
                    await connectToAccountByEmail(email);
                });
            });
        }
        async function refreshAccessLists() {
            await Promise.all([renderConnectedAccountsList(), refreshPermissionsList()]);
            if (grantAccessBtn) {
                grantAccessBtn.disabled = false;
            }
        }
        async function grantAccessToUser() {
            const api = window.firebaseAccess;
            if (!api?.grantAccessPermission) {
                showNotification('שירות ההרשאות לא זמין כרגע.', 'error');
                return;
            }
            const targetEmail = permissionUserEmailInput?.value?.trim();
            if (!targetEmail) {
                showNotification('יש להזין אימייל משתמש.', 'error');
                return;
            }
            const permissionLevel = document.querySelector('input[name="permissionLevel"]:checked')?.value || 'view';
            const projectScope = permissionProjectSelect?.value || 'all';
            const allowFinance = !!permissionFinanceCheckbox?.checked;
            try {
                const result = await api.grantAccessPermission({ targetEmail, projectScope, permissionLevel, allowFinance });
                if (result?.sharedListSyncWarning) {
                    showNotification('ההרשאה נשמרה, אך רשימת החשבונות של המשתמש השני לא התעדכנה. בדוק כללי Firestore.', 'warning');
                } else {
                    showNotification('ההרשאה נשמרה בהצלחה.', 'success');
                }
                if (permissionUserEmailInput) permissionUserEmailInput.value = '';
                if (permissionFinanceCheckbox) permissionFinanceCheckbox.checked = false;
                await refreshAccessLists();
            } catch (error) {
                const map = {
                    EMAIL_REQUIRED: 'יש להזין אימייל תקין.',
                    TARGET_NOT_FOUND: 'לא נמצא משתמש עם האימייל הזה. המשתמש צריך להירשם/להתחבר לפחות פעם אחת ולפתוח אינדוקס אימייל.',
                    SELF_NOT_ALLOWED: 'לא ניתן להעניק הרשאה לעצמך.',
                    AUTH_REQUIRED: 'יש להתחבר כדי להעניק הרשאות.',
                    'permission-denied': 'אין הרשאה לקרוא אינדוקס אימייל. ודא שהמשתמש מחובר ושכללי Firestore מעודכנים.'
                };
                showNotification(map[error.message] || 'שמירת ההרשאה נכשלה.', 'error');
            }
        }
        async function connectToAccount() {
            const api = window.firebaseAccess;
            if (!api?.findOwnerByEmail || !api?.loadOwnerProjects || !api?.loadAccountDataByUid) {
                showNotification('שירות החיבור לחשבון לא זמין כרגע.', 'error');
                return;
            }
            const targetEmail = connectAccountEmailInput?.value?.trim();
            if (!targetEmail) {
                showNotification('יש להזין אימייל של החשבון המבוקש.', 'error');
                return;
            }
            try {
                const match = await api.findOwnerByEmail(targetEmail);
                if (!match) {
                    showNotification('אין הרשאה לחשבון המבוקש.', 'error');
                    return;
                }
                const ownerProjectsPayload = await api.loadOwnerProjects(match.ownerUid);
                if (!ownerProjectsPayload || !ownerProjectsPayload.projects) {
                    showNotification('לא נמצאו נתונים בחשבון המבוקש.', 'error');
                    return;
                }
                applySharedAccess(match.permission, match.ownerUid, match.permission.ownerEmail || targetEmail);
                await api.loadAccountDataByUid(match.ownerUid);
                populatePermissionProjectOptions();
                renderProjectList(projectYearFilter.value);
                renderStageNavigation();
                loadCurrentStageContent();
                updateProjectDetailsCard();
                closeAccessModal();
                showNotification('התחברת לחשבון בהצלחה.', 'success');
            } catch (error) {
                console.error('Failed to connect to account:', error);
                showNotification('החיבור לחשבון נכשל.', 'error');
            }
        }
        async function connectToAccountByEmail(ownerEmail) {
            if (connectAccountEmailInput) connectAccountEmailInput.value = ownerEmail || '';
            await connectToAccount();
        }

        async function switchBackToOwner() {
            const api = window.firebaseAccess;
            if (!api?.loadAccountDataByUid) {
                showNotification('לא ניתן לחזור לחשבון כרגע.', 'error');
                return;
            }
            clearSharedAccess();
            await api.loadAccountDataByUid(null);
            renderProjectList(projectYearFilter.value);
            renderStageNavigation();
            loadCurrentStageContent();
            updateProjectDetailsCard();
            showNotification('חזרת לחשבון שלך.', 'success');
        }
        window.switchBackToOwner = switchBackToOwner;

        function populateYearSelects() {
            const currentYear = new Date().getFullYear();
            for (let year = 2020; year <= 2100; year++) {
                const option1 = document.createElement('option');
                option1.value = year;
                option1.textContent = year;
                projectYearFilter.appendChild(option1);
                const option2 = document.createElement('option');
                option2.value = year;
                option2.textContent = year;
                yearSelect.appendChild(option2);
            }
            projectYearFilter.value = 'all';
            yearSelect.value = currentYear;
            if (monthSelect) monthSelect.value = 'all';
        }
        function zoomIn() {
            const root = document.documentElement;
            const currentSize = parseInt(getComputedStyle(root).getPropertyValue('--font-size-base'));
            root.style.setProperty('--font-size-base', (currentSize + 2) + 'px');
        }
        function zoomOut() {
            const root = document.documentElement;
            const currentSize = parseInt(getComputedStyle(root).getPropertyValue('--font-size-base'));
            if (currentSize > 10) {
                root.style.setProperty('--font-size-base', (currentSize - 2) + 'px');
            }
        }
        function toggleGraphComparison(mode) {
            graphComparisonMode = mode;
            const metricDisplayName = stagesConfig[currentMetricTypeForModal.sectionId]?.metrics[currentMetricTypeForModal.metricId]?.name || 'מדד';
            openHistoryModal(currentMetricTypeForModal.sectionId, currentMetricTypeForModal.metricId, metricDisplayName);
        }
        function openProjectSelectionForComparison() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            projectSelectionModal.style.display = 'flex';
            renderComparisonProjectList();
        }
        function closeProjectSelectionModal() {
            projectSelectionModal.style.display = 'none';
            closeSecondaryHistoryModal();
            showMainContent();
        }
        function renderComparisonProjectList() {
            comparisonProjectList.innerHTML = '';
            Object.keys(projects).forEach(projectId => {
                if (projectId !== currentProjectId && !projects[projectId].isClosed) {
                    const listItem = document.createElement('li');
                    listItem.textContent = projects[projectId].name;
                    listItem.setAttribute('data-project-id', projectId);
                    listItem.onclick = () => selectComparisonProject(projectId);
                    comparisonProjectList.appendChild(listItem);
                }
            });
        }
        function selectComparisonProject(projectId) {
            comparisonProjectId = projectId;
            closeProjectSelectionModal();
            const metricDisplayName = stagesConfig[currentMetricTypeForModal.sectionId]?.metrics[currentMetricTypeForModal.metricId]?.name || 'מדד';
            openHistoryModal(currentMetricTypeForModal.sectionId, currentMetricTypeForModal.metricId, metricDisplayName);
        }
        
        // Sound definitions using Web Audio API
        const reminderSounds = {
            none: null,
            alarm1: { frequency: 800, pattern: [300, 150, 300, 150, 300, 450, 300, 150] }, // Made longer
            alarm2: { frequency: 600, pattern: [250, 150, 250, 150, 600, 300, 250, 150] }, // Made longer
            bell: { frequency: 1000, pattern: [450, 300, 450, 600, 450, 300] }, // Made longer
            chime: { frequency: 1200, pattern: [150, 75, 150, 75, 150, 300, 150, 75] } // Made longer
        };
        
        let audioContext = null;
        
        function playReminderSound(soundType) {
            if (soundType === 'none' || !reminderSounds[soundType]) return;
            
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const sound = reminderSounds[soundType];
                let currentTime = audioContext.currentTime;
                
                sound.pattern.forEach((duration, index) => {
                    if (index % 2 === 0) { // Play on even indices
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.value = sound.frequency + (index * 50);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(0.3, currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, currentTime + duration / 1000);
                        
                        oscillator.start(currentTime);
                        oscillator.stop(currentTime + duration / 1000);
                    }
                    currentTime += duration / 1000;
                });
            } catch (e) {
                console.error('Error playing sound:', e);
            }
        }
        
        function previewReminderSound() {
            const soundSelect = document.getElementById('reminderSound');
            if (soundSelect) {
                playReminderSound(soundSelect.value);
            }
        }
        
        function showReminderPopup(text) {
            const popup = document.getElementById('reminderPopupNotification');
            const popupText = document.getElementById('reminderPopupText');
            
            if (popup && popupText) {
                popupText.textContent = text;
                popup.style.display = 'block';
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    closeReminderPopup();
                }, 10000);
            }
        }
        
        function closeReminderPopup() {
            const popup = document.getElementById('reminderPopupNotification');
            if (popup) {
                popup.style.display = 'none';
            }
        }
        
        function updateInboxBadge() {
            const badge = document.getElementById('inboxBadge');
            if (badge) {
                const unreadCount = inbox.length;
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'inline-flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        async function checkReminders() {
            const now = new Date();
            let remindersUpdated = false;
            let inboxUpdated = false;
            
            reminders.forEach(reminder => {
                const reminderTime = new Date(reminder.datetime);
                if (reminderTime <= now && !reminder.notified) {
                    reminder.notified = true;
                    remindersUpdated = true;
                    
                    // Play sound if selected
                    if (reminder.sound && reminder.sound !== 'none') {
                        playReminderSound(reminder.sound);
                    }
                    
                    // Show popup notification in app
                    showReminderPopup(reminder.text);
                    
                    // Show browser notification if enabled
                    if (reminder.popup && 'Notification' in window && Notification.permission === 'granted') {
                        new Notification('תזכורת: ' + reminder.text, {
                            icon: 'image_00b206.png',
                            body: new Date(reminder.datetime).toLocaleString('he-IL'),
                            requireInteraction: true
                        });
                    }
                    
                    inbox.push(reminder);
                    inboxUpdated = true;
                    renderInboxList();
                    updateInboxBadge();
                }
            });
            
            if (remindersUpdated) {
                renderRemindersList();
                // Sync reminders to cloud (debounced to avoid excessive writes)
                queueRemindersSave();
            }
            
            if (inboxUpdated) {
                // Sync inbox to cloud (debounced to avoid excessive writes)
                queueInboxSave();
            }
        }
        // Image upload functions for reminders
        async function handleReminderImageSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                try {
                    await processReminderImageSelection(file);
                } catch (error) {
                    console.error('Reminder image selection failed:', error);
                    alert('שגיאה בטעינת התמונה. נסה/י שוב.');
                }
            }
        }

        async function processReminderImageSelection(file) {
            selectedReminderImageFile = file;
            selectedReminderImageUploadedUrl = null;
            selectedReminderImage = await fileToDataUrl(file);
            document.getElementById('reminderPreviewImg').src = selectedReminderImage;
            document.getElementById('reminderImagePreview').style.display = 'block';

            try {
                const uploadedUrl = await uploadReminderImageToFirebase(file);
                if (uploadedUrl) {
                    selectedReminderImageUploadedUrl = uploadedUrl;
                    selectedReminderImage = uploadedUrl;
                    document.getElementById('reminderPreviewImg').src = uploadedUrl;
                }
            } catch (error) {
                console.warn('Reminder image Firebase upload failed, keeping local preview.', error);
            }
        }
        
        async function openCameraForReminder() {
            try {
                const file = await openCameraCaptureModal({ title: 'צלם תמונה' });
                if (!file) return;
                await processReminderImageSelection(file);
            } catch (error) {
                console.warn('Camera stream failed for reminder, fallback to capture input:', error);
                const fallbackFile = await openCameraFilePickerFallback();
                if (fallbackFile) {
                    await processReminderImageSelection(fallbackFile);
                    return;
                }
                alert(error?.message || 'שגיאה בגישה למצלמה.');
            }
        }
        
        function removeReminderImage() {
            selectedReminderImage = null;
            selectedReminderImageFile = null;
            selectedReminderImageUploadedUrl = null;
            document.getElementById('reminderImagePreview').style.display = 'none';
            document.getElementById('reminderImageUpload').value = '';
        }

        async function uploadReminderImageToFirebase(file) {
            const api = window.firebaseAccess;
            const accountUid = getActiveDataAccountUid();
            if (!api?.uploadFileToStorage || !accountUid) return '';
            const safeName = (file.name || `reminder_${Date.now()}.jpg`).replace(/\s+/g, '_').replace(/[^\w.\-]/g, '');
            const storagePath = `public/reminders/${accountUid}/${currentProjectId}/${Date.now()}_${safeName}`;
            const uploadResult = await api.uploadFileToStorage(storagePath, file, {
                section: 'reminders',
                projectId: currentProjectId
            });
            return uploadResult?.downloadUrl || '';
        }
        
        async function uploadReminderImage(reminderId) {
            if (!selectedReminderImageFile) {
                console.log('No image file selected, skipping upload');
                return null;
            }
            
            console.log('Converting image to base64 for reminder:', reminderId);
            console.log('Image file:', selectedReminderImageFile.name, selectedReminderImageFile.type, selectedReminderImageFile.size);
            
            // Convert image to base64 for local storage (no external upload)
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    console.log('Image converted to base64');
                    resolve(e.target.result);
                };
                reader.onerror = (error) => {
                    console.error('Error reading image file:', error);
                    reject(new Error('שגיאה בקריאת התמונה'));
                };
                reader.readAsDataURL(selectedReminderImageFile);
            });
        }
        
        async function addReminder() {
            const text = reminderTextInput.value.trim();
            const datetime = reminderDateTimeInput.value;
            const popup = reminderPopupInput.checked;
            const soundSelect = document.getElementById('reminderSound');
            const sound = soundSelect ? soundSelect.value : 'alarm1';
            const addBtn = document.getElementById('addReminderBtn');
            
            if (text && datetime) {
                const reminderId = Date.now();
                
                // Disable button and show loading state
                if (addBtn) {
                    addBtn.disabled = true;
                    addBtn.textContent = 'שומר...';
                }
                
                try {
                    // Convert image to base64 if selected
                    let imageUrl = null;
                    if (selectedReminderImageFile) {
                        try {
                            imageUrl = selectedReminderImageUploadedUrl || await uploadReminderImage(reminderId);
                            console.log('Image converted to base64');
                        } catch (uploadError) {
                            console.error('Image conversion error:', uploadError);
                            // Continue without image if conversion fails
                            alert('שגיאה בעיבוד התמונה: ' + uploadError.message + '\nהתזכורת תישמר ללא תמונה.');
                        }
                    }
                    
                    const newReminder = { 
                        id: reminderId, 
                        text, 
                        datetime, 
                        popup, 
                        sound, 
                        notified: false,
                        imageUrl: imageUrl
                    };
                    
                    // Save to IndexedDB (prevents QuotaExceededError)
                    await saveReminderToIndexedDB(newReminder);
                    
                    // Also add to in-memory array
                    reminders.push(newReminder);
                    
                    
                    reminderTextInput.value = '';
                    reminderDateTimeInput.value = '';
                    reminderPopupInput.checked = false;
                    if (soundSelect) soundSelect.value = 'alarm1';
                    removeReminderImage();
                    renderRemindersList();
                    queueRemindersSave();
                    checkReminders();
                } catch (error) {
                    console.error('Error adding reminder:', error);
                    alert('שגיאה בשמירת התזכורת. אנא נסה שוב.');
                } finally {
                    // Re-enable button and restore text
                    if (addBtn) {
                        addBtn.disabled = false;
                        addBtn.textContent = 'הוסף תזכורת';
                    }
                }
            } else {
                alert('אנא הזן טקסט ותאריך/שעה.');
            }
        }
        function renderRemindersList() {
            remindersList.innerHTML = '';
            reminders.forEach(reminder => {
                if (!reminder.notified) {
                    const soundLabel = reminder.sound === 'none' ? 'ללא צליל' :
                                      reminder.sound === 'alarm1' ? '🔔 שעון 1' :
                                      reminder.sound === 'alarm2' ? '🔔 שעון 2' :
                                      reminder.sound === 'bell' ? '🔔 פעמון' :
                                      reminder.sound === 'chime' ? '🔔 צלצול' : '';
                    
                    const imageHtml = reminder.imageUrl ? 
                        `<img src="${reminder.imageUrl}" alt="תמונה" class="reminder-item-image" onclick="window.open('${reminder.imageUrl}', '_blank')">` : '';
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="reminder-details">
                            <div class="text">${reminder.text}</div>
                            <div class="datetime">${new Date(reminder.datetime).toLocaleString('he-IL')} ${soundLabel}</div>
                            ${imageHtml}
                        </div>
                        <div class="reminder-actions">
                            <button onclick="deleteReminder(${reminder.id})">מחק</button>
                        </div>
                    `;
                    remindersList.appendChild(li);
                }
            });
        }
        async function deleteReminder(id) {
            reminders = reminders.filter(r => r.id !== id);
            
            // Delete from IndexedDB
            try {
                await deleteReminderFromIndexedDB(id);
            } catch (error) {
                console.error('Error deleting from IndexedDB:', error);
            }
            
            
            renderRemindersList();
            queueRemindersSave();
        }
        function openInboxModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            inboxModal.style.display = 'flex';
            renderInboxList();
        }
        function closeInboxModal() {
            inboxModal.style.display = 'none';
            showMainContent();
        }
        function renderInboxList() {
            inboxList.innerHTML = '';
            inbox.forEach((reminder, index) => {
                const soundLabel = reminder.sound === 'none' ? '' :
                                  reminder.sound === 'alarm1' ? '🔔' :
                                  reminder.sound === 'alarm2' ? '🔔' :
                                  reminder.sound === 'bell' ? '🔔' :
                                  reminder.sound === 'chime' ? '🔔' : '';
                
                const imageHtml = reminder.imageUrl ? 
                    `<div class="inbox-message-image">
                        <img src="${reminder.imageUrl}" alt="תמונה" class="inbox-item-image" onclick="window.open('${reminder.imageUrl}', '_blank')">
                    </div>` : '';
                
                const dateStr = new Date(reminder.datetime).toLocaleDateString('he-IL');
                const timeStr = new Date(reminder.datetime).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                
                const li = document.createElement('li');
                li.className = 'inbox-item';
                li.innerHTML = `
                    <div class="inbox-message-header" onclick="toggleInboxMessage(${index})">
                        <div class="inbox-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="inbox-preview">
                            <div class="inbox-subject">${soundLabel} תזכורת</div>
                            <div class="inbox-snippet">${reminder.text.substring(0, 50)}${reminder.text.length > 50 ? '...' : ''}</div>
                        </div>
                        <div class="inbox-meta">
                            <div class="inbox-date">${dateStr}</div>
                            <div class="inbox-time">${timeStr}</div>
                            <i class="fas fa-chevron-down inbox-toggle-icon" id="inbox-toggle-${index}"></i>
                        </div>
                    </div>
                    <div class="inbox-message-body" id="inbox-body-${index}" style="display:none;">
                        <div class="inbox-message-content">
                            <p>${reminder.text}</p>
                            ${imageHtml}
                        </div>
                        <div class="inbox-message-actions">
                            <button onclick="deleteInbox(${reminder.id})" class="inbox-delete-btn">
                                <i class="fas fa-trash"></i> מחק
                            </button>
                        </div>
                    </div>
                `;
                inboxList.appendChild(li);
            });
            updateInboxBadge();
        }
        
        function toggleInboxMessage(index) {
            const body = document.getElementById(`inbox-body-${index}`);
            const icon = document.getElementById(`inbox-toggle-${index}`);
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                body.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
        async function deleteInbox(id) {
            inbox = inbox.filter(r => r.id !== id);
            queueInboxSave();
            renderInboxList();
            updateInboxBadge();
        }
        function openRemindersModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            remindersModal.style.display = 'flex';
            renderRemindersList();
            queueRemindersSave();
        }
        function closeRemindersModal() {
            remindersModal.style.display = 'none';
            showMainContent();
        }
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        console.log('Notifications permission granted.');
                    }
                });
            }
        }
        // Initialize application on page load
        window.addEventListener('load', async () => {
            mergeStoredStagesConfig();
            updateAuthUi();
            loadDarkModeState();
            populateYearSelects();
            setDefaultYearFilter();
            renderAllMainContent();
            updateInboxBadge();
            requestNotificationPermission();
            
            // Push messaging removed - service worker registration removed
            
            setInterval(checkReminders, 60000);
            checkReminders();
            
            // Add touch event listeners for card swipe functionality
            if (projectDetailsCard) {
                projectDetailsCard.addEventListener('touchstart', handleTouchStart);
                projectDetailsCard.addEventListener('touchmove', handleTouchMove);
                projectDetailsCard.addEventListener('touchend', handleTouchEnd);
            }
            
            if (cardFab) {
                // Use a flag to prevent double-firing on touch devices
                let touchHandled = false;
                
                cardFab.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    touchHandled = true;
                    toggleCardFromFab();
                    // Reset flag after a short delay
                    setTimeout(() => { touchHandled = false; }, 300);
                });
                
                cardFab.addEventListener('click', (e) => {
                    if (!touchHandled) {
                        toggleCardFromFab();
                    }
                });
            }
            
            // Initialize card position to prevent flickering
            initializeProjectDetailsCard();
            handleDashboardCollapseVisibility();
            
            // Remove preload class to enable animations smoothly after initialization
            setTimeout(() => {
                document.body.classList.remove('preload');
                document.body.classList.add('loaded');
            }, 100);
            
        });
        function setDefaultYearFilter() {
            const currentYear = new Date().getFullYear().toString();
            projectYearFilter.value = 'all';
            filterProjectsByYear();
        }
        function renderAllMainContent() {
            updateProjectDisplay();
            renderStageNavigation();
            switchCategory(activeCategory);
        }
        function loadDarkModeState() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }
        }
        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }
        });
        projectYearFilter.addEventListener('change', filterProjectsByYear);
        hamburgerBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        window.addEventListener('resize', handleCardFabResize);
        window.addEventListener('resize', handleDashboardCollapseVisibility);
        function handleDashboardCollapseVisibility() {
            if (!dashboardCollapseBtn || !fixedDashboardSection) return;
            const isMobile = window.innerWidth <= 768;
            dashboardCollapseBtn.style.display = isMobile ? 'flex' : 'none';
            if (!isMobile) {
                fixedDashboardSection.classList.remove('collapsed-mobile');
            }
        }

        function toggleSidebar() {
            hamburgerBtn.classList.toggle('open');
            sidebar.classList.toggle('open');
            sidebarOverlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none';
            
            // Update toggle icon direction
            const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
            if (sidebarToggleIcon) {
                if (sidebar.classList.contains('open')) {
                    sidebarToggleIcon.className = 'fas fa-angle-double-right';
                } else {
                    sidebarToggleIcon.className = 'fas fa-angle-double-left';
                }
            }
        }
        function closeSidebar() {
            hamburgerBtn.classList.remove('open');
            sidebar.classList.remove('open');
            sidebarOverlay.style.display = 'none';
        }

        function toggleMobileDashboardCollapse() {
            if (!fixedDashboardSection) return;
            fixedDashboardSection.classList.toggle('collapsed-mobile');
        }

        function showMainContent() {
            historyModal.style.display = 'none';
            projectManagementModal.style.display = 'none';
            financeModal.style.display = 'none';
            globalFinanceReportModal.style.display = 'none';
            financeYearlyModal.style.display = 'none';
            inboxModal.style.display = 'none';
            remindersModal.style.display = 'none';
            instructionsModal.style.display = 'none';
            timelineModal.style.display = 'none';
            datePickerModal.style.display = 'none';
            projectSelectionModal.style.display = 'none';
            closeSecondaryHistoryModal();
            document.querySelector('.container').style.display = 'block';
            document.querySelector('.top-section-wrapper').style.display = 'block';
            currentStageContent.style.display = 'block';
            stageNavContainer.style.display = 'flex';
            projectDetailsCard.style.display = 'block';
            fixedDashboardSection.style.display = 'flex';
            // Always show stage overview container
            stageOverviewContainer.style.display = 'block';
            switchCategory(activeCategory);
        }

        const savedCategory = localStorage.getItem('activeCategory');
        let activeCategory = ['metrics', 'additions', 'extras'].includes(savedCategory) ? savedCategory : 'metrics';
        let secondaryHistoryState = { mode: null, key: null };

        function switchCategory(category) {
            activeCategory = category;
            localStorage.setItem('activeCategory', activeCategory);
            const navButtons = document.querySelectorAll('.category-nav-btn');
            navButtons.forEach((btn) => btn.classList.toggle('active', btn.dataset.category === category));

            const isMetrics = category === 'metrics';
            additionsPanel.classList.toggle('active', category === 'additions');
            extrasPanel.classList.toggle('active', category === 'extras');

            fixedDashboardSection.style.display = 'flex';
            currentStageContent.style.display = isMetrics ? 'block' : 'none';
            stageOverviewContainer.style.display = isMetrics ? 'block' : 'none';
            stageNavContainer.style.display = isMetrics ? 'flex' : 'none';
            if (mobileStageMetricSeparator) {
                const showSeparator = isMetrics && window.innerWidth <= 768;
                mobileStageMetricSeparator.style.display = showSeparator ? 'block' : 'none';
            }
            projectDetailsCard.style.display = 'block';
            document.querySelector('.top-section-wrapper').style.display = 'block';
            if (currentStageContent.parentElement) currentStageContent.parentElement.style.display = 'block';
            if (isMetrics) {
                closeSecondaryHistoryModal();
            }
            fixedDashboardSection.classList.remove('collapsed-mobile');
            if (dashboardCollapseBtn) {
                dashboardCollapseBtn.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
            }

            renderActiveCategoryDashboard();
            if (category === 'additions') renderAdditionsPanel();
            if (category === 'extras') renderExtrasPanel();
        }


        function ensureSecondaryCollections(project) {
            if (!project) return;
            if (!project.additions || typeof project.additions !== 'object') project.additions = {};
            if (!Array.isArray(project.extras)) project.extras = [];
            if (!Array.isArray(project.extraTypes)) project.extraTypes = [];
        }

        function handleCategoryAddAction() {
            openAddMetricModal();
        }

        function formatLocalDateTimeForInput(date = new Date()) {
            const pad = (n) => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function parseDisplayTimestampToInputValue(ts) {
            const parsed = parseHebrewLocaleTimestamp(ts);
            if (!parsed || Number.isNaN(parsed.getTime())) return formatLocalDateTimeForInput(new Date());
            return formatLocalDateTimeForInput(parsed);
        }

        async function addAdditionEntry(nameOverride = null, controls = {}) {
            ensureSecondaryCollections(projects[currentProjectId]);
            const name = (nameOverride || additionTypeInput?.value || '').trim();
            const amountSource = controls.amountInput?.value ?? additionAmountInput?.value;
            const amount = parseFloat(amountSource);
            const unit = controls.unitInput?.value || additionUnitInput?.value || 'גרם';
            const rawTime = controls.timeInput?.value ?? additionTimeInput?.value;
            const when = rawTime ? new Date(rawTime) : new Date();
            if (!name) {
                alert('יש להזין שם תוספת.');
                return;
            }
            if (Number.isNaN(amount)) {
                alert('יש להזין כמות תקינה.');
                return;
            }
            if (!projects[currentProjectId].additions[name]) projects[currentProjectId].additions[name] = [];
            const newEntry = {
                id: Date.now(),
                amount,
                unit,
                timestamp: when.toLocaleString('he-IL')
            };
            const file = controls.fileInput?.files?.[0] || additionStoryUploadInput?.files?.[0];
            if (file) {
                const uploaded = await uploadSecondaryStoryImage(file, `addition_${newEntry.id}`);
                if (uploaded) {
                    newEntry.imageUrl = uploaded.downloadUrl;
                    newEntry.imagePath = uploaded.storagePath;
                }
            }
            projects[currentProjectId].additions[name].push(newEntry);
            saveAllProjects();
            if (controls.amountInput) controls.amountInput.value = '';
            if (controls.timeInput) controls.timeInput.value = '';
            if (controls.fileInput) controls.fileInput.value = '';
            if (!controls.amountInput && additionAmountInput) additionAmountInput.value = '';
            if (!controls.timeInput && additionTimeInput) additionTimeInput.value = '';
            if (!controls.fileInput && additionStoryUploadInput) additionStoryUploadInput.value = '';
            renderAdditionsPanel();
            if (activeCategory === 'additions') renderActiveCategoryDashboard();
        }

        function renderAdditionsPanel() {
            if (!additionsDashboard) return;
            ensureSecondaryCollections(projects[currentProjectId]);
            additionsDashboard.innerHTML = '';
            const additions = projects[currentProjectId]?.additions || {};
            const names = Object.keys(additions).filter((name) => String(name || '').trim());
            if (!names.length) {
                additionsDashboard.innerHTML = '<p style="text-align:center;color:var(--light-text-color)">עדיין לא נוספו תוספות.</p>';
                return;
            }
            names.forEach((name) => {
                const entries = additions[name] || [];
                const lastUnit = entries[entries.length - 1]?.unit || 'גרם';
                const card = document.createElement('div');
                card.className = 'input-group';
                const label = document.createElement('label');
                label.textContent = name;
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.step = 'any';
                amountInput.placeholder = 'הכנס כמות';
                amountInput.inputMode = 'decimal';
                amountInput.setAttribute('aria-label', `כמות עבור ${name}`);
                const unitSelect = document.createElement('select');
                unitSelect.setAttribute('aria-label', `יחידת מידה עבור ${name}`);
                ['גרם', 'קילוגרם', 'ליטר', 'מיליגרם'].forEach((u) => {
                    const opt = document.createElement('option');
                    opt.value = u;
                    opt.textContent = u;
                    if (u === lastUnit) opt.selected = true;
                    unitSelect.appendChild(opt);
                });
                const updateBtn = document.createElement('button');
                updateBtn.type = 'button';
                updateBtn.setAttribute('aria-label', `עדכן ${name}`);
                updateBtn.textContent = 'עדכן';
                updateBtn.addEventListener('click', () => addAdditionEntry(name, { amountInput, unitInput: unitSelect }));
                card.appendChild(label);
                card.appendChild(amountInput);
                card.appendChild(unitSelect);
                card.appendChild(updateBtn);
                additionsDashboard.appendChild(card);
            });
        }


        async function uploadSecondaryStoryImage(file, entryId) {
            try {
                const api = window.firebaseAccess;
                if (!api?.uploadFileToStorage || !api?.buildFinanceAttachmentPath) return null;
                const path = api.buildFinanceAttachmentPath(currentProjectId, entryId, file.name);
                return await api.uploadFileToStorage(path, file, { section: 'secondary', projectId: currentProjectId, entryId: String(entryId) });
            } catch (error) {
                console.error('Secondary image upload failed:', error);
                alert('העלאת תמונה נכשלה. הרשומה תישמר ללא תמונה.');
                return null;
            }
        }

        function appendAdditionAmount(name, amount) {
            const entries = projects[currentProjectId]?.additions?.[name];
            if (!entries || Number.isNaN(amount)) return;
            const unit = entries[entries.length - 1]?.unit || 'גרם';
            entries.push({ id: Date.now(), amount, unit, timestamp: new Date().toLocaleString('he-IL') });
            saveAllProjects();
            renderAdditionsPanel();
            if (activeCategory === 'additions') renderActiveCategoryDashboard();
            renderSecondaryHistoryRows();
        }

        function removeAdditionGroup(name) {
            if (!projects[currentProjectId]?.additions?.[name]) return;
            delete projects[currentProjectId].additions[name];
            saveAllProjects();
            closeSecondaryHistoryModal();
            renderAdditionsPanel();
            if (activeCategory === 'additions') renderActiveCategoryDashboard();
        }

        function removeAdditionEntry(name, index) {
            const arr = projects[currentProjectId]?.additions?.[name];
            if (!arr) return;
            arr.splice(index, 1);
            if (!arr.length) delete projects[currentProjectId].additions[name];
            saveAllProjects();
            if (!projects[currentProjectId]?.additions?.[name]) {
                closeSecondaryHistoryModal();
            } else {
                renderSecondaryHistoryRows();
            }
            renderAdditionsPanel();
            if (activeCategory === 'additions') renderActiveCategoryDashboard();
        }

        async function addExtraEntry(typeOverride = null, controls = {}) {
            ensureSecondaryCollections(projects[currentProjectId]);
            const type = (typeOverride || extraTypeInput?.value || '').trim();
            const notes = (controls.notesInput?.value ?? extraNotesInput?.value ?? '').trim();
            const rawTime = controls.timeInput?.value ?? extraTimeInput?.value;
            const when = rawTime ? new Date(rawTime) : new Date();
            if (!type) {
                alert('יש להזין שם נתון.');
                return;
            }
            const newEntry = { id: Date.now(), type, notes, timestamp: when.toLocaleString('he-IL') };
            const file = controls.fileInput?.files?.[0] || extraStoryUploadInput?.files?.[0];
            if (file) {
                const uploaded = await uploadSecondaryStoryImage(file, `extra_${newEntry.id}`);
                if (uploaded) {
                    newEntry.imageUrl = uploaded.downloadUrl;
                    newEntry.imagePath = uploaded.storagePath;
                }
            }
            projects[currentProjectId].extras.push(newEntry);
            saveAllProjects();
            if (controls.notesInput) controls.notesInput.value = '';
            if (controls.timeInput) controls.timeInput.value = '';
            if (controls.fileInput) controls.fileInput.value = '';
            if (!controls.notesInput && extraNotesInput) extraNotesInput.value = '';
            if (!controls.timeInput && extraTimeInput) extraTimeInput.value = '';
            if (!controls.fileInput && extraStoryUploadInput) extraStoryUploadInput.value = '';
            renderExtrasPanel();
            if (activeCategory === 'extras') renderActiveCategoryDashboard();
        }

        function renderExtrasPanel() {
            if (!extrasDashboard) return;
            ensureSecondaryCollections(projects[currentProjectId]);
            extrasDashboard.innerHTML = '';
            const entries = projects[currentProjectId]?.extras || [];
            const typeSet = new Set(projects[currentProjectId]?.extraTypes || []);
            entries.forEach((entry) => {
                if (entry?.type) typeSet.add(entry.type);
            });
            const types = Array.from(typeSet).map((type) => String(type || '').trim()).filter(Boolean);
            if (!types.length) {
                extrasDashboard.innerHTML = '<p style="text-align:center;color:var(--light-text-color)">אין עדיין נתונים נוספים.</p>';
                return;
            }
            types.forEach((type) => {
                const card = document.createElement('div');
                card.className = 'input-group';
                const label = document.createElement('label');
                label.textContent = type;
                const notesInput = document.createElement('input');
                notesInput.type = 'text';
                notesInput.placeholder = 'הערות';
                notesInput.setAttribute('aria-label', `הערות עבור ${type}`);
                const updateBtn = document.createElement('button');
                updateBtn.type = 'button';
                updateBtn.setAttribute('aria-label', `עדכן ${type}`);
                updateBtn.textContent = 'עדכן';
                updateBtn.addEventListener('click', () => addExtraEntry(type, { notesInput }));
                card.appendChild(label);
                card.appendChild(notesInput);
                card.appendChild(updateBtn);
                extrasDashboard.appendChild(card);
            });
        }

        function removeExtraEntry(index) {
            const entries = projects[currentProjectId]?.extras;
            if (!entries) return;
            entries.splice(index, 1);
            saveAllProjects();
            renderExtrasPanel();
            if (activeCategory === 'extras') renderActiveCategoryDashboard();
            renderSecondaryHistoryRows();
        }

        function openSecondaryHistoryModal(mode, key) {
            secondaryHistoryState = { mode, key };
            secondaryHistoryTitle.textContent = mode === 'addition' ? `היסטוריית תוספת: ${key}` : `היסטוריית נתון: ${key}`;
            renderSecondaryHistoryRows();
            secondaryHistoryModal.style.display = 'flex';
        }

        function closeSecondaryHistoryModal() {
            secondaryHistoryModal.style.display = 'none';
            secondaryHistoryRows.innerHTML = '';
            secondaryHistoryTotal.textContent = '';
            secondaryHistoryState = { mode: null, key: null };
        }

        async function updateSecondaryEntryImage(mode, key, index, input) {
            const file = input?.files?.[0];
            if (!file) return;
            const entry = mode === 'addition'
                ? projects[currentProjectId]?.additions?.[key]?.[index]
                : (projects[currentProjectId]?.extras || []).filter((item) => item.type === key)[index];
            if (!entry) return;
            const uploaded = await uploadSecondaryStoryImage(file, `${mode}_${entry.id || Date.now()}`);
            if (uploaded) {
                entry.imageUrl = uploaded.downloadUrl;
                entry.imagePath = uploaded.storagePath;
                saveAllProjects();
                renderSecondaryHistoryRows();
                if (mode === 'addition') renderAdditionsPanel(); else renderExtrasPanel();
                renderActiveCategoryDashboard();
            }
        }

        function renderSecondaryHistoryRows() {
            const { mode, key } = secondaryHistoryState;
            if (!mode || !key || !secondaryHistoryRows) return;
            secondaryHistoryRows.innerHTML = '';
            if (mode === 'addition') {
                const safeKey = encodeURIComponent(key);
                const entries = projects[currentProjectId]?.additions?.[key] || [];
                let total = 0;
                entries.forEach((entry, index) => {
                    total += Number(entry.amount) || 0;
                    const row = document.createElement('div');
                    row.className = 'secondary-edit-row';
                    row.innerHTML = `
                        <div class="secondary-input-row">
                            <input type="number" step="any" value="${entry.amount ?? ''}" onchange="editAdditionInline(decodeURIComponent('${safeKey}'), ${index}, 'amount', this.value)">
                            <select onchange="editAdditionInline(decodeURIComponent('${safeKey}'), ${index}, 'unit', this.value)">
                                <option value="גרם" ${entry.unit === 'גרם' ? 'selected' : ''}>גרם</option>
                                <option value="קילוגרם" ${entry.unit === 'קילוגרם' ? 'selected' : ''}>קילוגרם</option>
                                <option value="ליטר" ${entry.unit === 'ליטר' ? 'selected' : ''}>ליטר</option>
                                <option value="מיליגרם" ${entry.unit === 'מיליגרם' ? 'selected' : ''}>מיליגרם</option>
                            </select>
                            <input type="datetime-local" value="${parseDisplayTimestampToInputValue(entry.timestamp)}" onchange="editAdditionInline(decodeURIComponent('${safeKey}'), ${index}, 'timestamp', this.value)">
                            <input type="file" accept="image/*" onchange="updateSecondaryEntryImage('addition', decodeURIComponent('${safeKey}'), ${index}, this)">
                        </div>
                        <div class="secondary-input-row">
                            <button class="undo-button" onclick="removeAdditionEntry(decodeURIComponent('${safeKey}'), ${index})">מחק שורה</button>
                            ${entry.imageUrl ? `<button class="history-upload-btn" onclick="openMediaPreview('${entry.imageUrl}', 'תמונת תוספת')">פתח תמונה</button>` : ''}
                        </div>
                    `;
                    secondaryHistoryRows.appendChild(row);
                });
                const unit = entries[entries.length - 1]?.unit || '';
                secondaryHistoryTotal.textContent = `תוצאה מצטברת: ${total} ${unit}`;
            } else {
                const safeKey = encodeURIComponent(key);
                const entries = (projects[currentProjectId]?.extras || []).filter((item) => item.type === key);
                entries.forEach((entry) => {
                    const realIndex = (projects[currentProjectId]?.extras || []).findIndex((item) => item.id === entry.id);
                    const row = document.createElement('div');
                    row.className = 'secondary-edit-row';
                    row.innerHTML = `
                        <div class="secondary-input-row">
                            <input type="datetime-local" value="${parseDisplayTimestampToInputValue(entry.timestamp)}" onchange="editExtraInline(${realIndex}, 'timestamp', this.value)">
                            <input type="text" value="${(entry.notes || '').replace(/"/g, '&quot;')}" placeholder="הערות" onchange="editExtraInline(${realIndex}, 'notes', this.value)">
                            <input type="file" accept="image/*" onchange="updateSecondaryEntryImage('extra', decodeURIComponent('${safeKey}'), ${entries.indexOf(entry)}, this)">
                        </div>
                        <div class="secondary-input-row">
                            <button class="undo-button" onclick="removeExtraEntry(${realIndex})">מחק שורה</button>
                            ${entry.imageUrl ? `<button class="history-upload-btn" onclick="openMediaPreview('${entry.imageUrl}', 'תמונת נתון נוסף')">פתח תמונה</button>` : ''}
                        </div>
                    `;
                    secondaryHistoryRows.appendChild(row);
                });
                secondaryHistoryTotal.textContent = `סה"כ רשומות: ${entries.length}`;
            }
        }

        function editAdditionInline(name, index, field, value) {
            const entry = projects[currentProjectId]?.additions?.[name]?.[index];
            if (!entry) return;
            if (field === 'amount') {
                const parsed = parseFloat(value);
                if (Number.isNaN(parsed)) return;
                entry.amount = parsed;
            } else if (field === 'timestamp') {
                entry.timestamp = value ? new Date(value).toLocaleString('he-IL') : entry.timestamp;
            } else if (field === 'unit') {
                entry.unit = value || entry.unit;
            }
            saveAllProjects();
            renderAdditionsPanel();
            if (activeCategory === 'additions') renderActiveCategoryDashboard();
            renderSecondaryHistoryRows();
        }

        function editExtraInline(index, field, value) {
            const entry = projects[currentProjectId]?.extras?.[index];
            if (!entry) return;
            if (field === 'timestamp') entry.timestamp = value ? new Date(value).toLocaleString('he-IL') : entry.timestamp;
            if (field === 'notes') entry.notes = value;
            saveAllProjects();
            renderExtrasPanel();
            if (activeCategory === 'extras') renderActiveCategoryDashboard();
            renderSecondaryHistoryRows();
        }

        function downloadSecondaryHistory() {
            const { mode, key } = secondaryHistoryState;
            if (!mode || !key) return;
            const rows = mode === 'addition'
                ? (projects[currentProjectId]?.additions?.[key] || []).map((entry) => ({
                    timestamp: entry.timestamp || '',
                    value: `${entry.amount ?? ''} ${entry.unit || ''}`,
                    notes: ''
                }))
                : (projects[currentProjectId]?.extras || []).filter((item) => item.type === key).map((entry) => ({
                    timestamp: entry.timestamp || '',
                    value: entry.type || '',
                    notes: entry.notes || ''
                }));
            const header = 'timestamp,value,notes';
            const csv = [header, ...rows.map((row) => [row.timestamp, row.value, row.notes].map((v) => `"${String(v).replace(/"/g, '""')}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${mode}_${key}_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
        }

        async function addEntryFromSecondaryHistory() {
            const { mode, key } = secondaryHistoryState;
            if (!mode || !key) return;
            if (mode === 'addition') {
                const amountRaw = prompt(`כמות חדשה עבור ${key}:`, '');
                if (amountRaw === null) return;
                const amount = parseFloat(amountRaw);
                if (Number.isNaN(amount)) {
                    alert('יש להזין כמות תקינה.');
                    return;
                }
                appendAdditionAmount(key, amount);
            } else {
                const notes = prompt(`הערות עבור ${key}:`, '');
                if (notes === null) return;
                await addExtraEntry(key, { notesInput: { value: notes } });
            }
            renderSecondaryHistoryRows();
        }

        function openProjectSummaryModal() {
            if (!projectSummaryModal) return;
            const project = projects[currentProjectId];
            const rows = [];
            const pills = [];
            Object.entries(project?.stages || {}).forEach(([stageId, metrics]) => {
                Object.entries(metrics || {}).forEach(([metricId, entries]) => {
                    const last = (entries || [])[entries.length - 1];
                    if (!last) return;
                    const metricName = stagesConfig?.[stageId]?.metrics?.[metricId]?.name || stagesConfig?.[stageId]?.customMetrics?.[metricId]?.name || metricId;
                    pills.push(`${metricName}: ${last.value}`);
                    rows.push({ category: 'מדדים', name: metricName, timestamp: last.timestamp || '', details: String(last.value ?? '') });
                });
            });
            Object.entries(project?.additions || {}).forEach(([name, entries]) => {
                const last = (entries || [])[entries.length - 1];
                if (!last) return;
                pills.push(`${name}: ${last.amount} ${last.unit || ''}`);
                rows.push({ category: 'תוספות', name, timestamp: last.timestamp || '', details: `${last.amount ?? ''} ${last.unit || ''}`.trim() });
            });
            const extraGroups = {};
            (project?.extras || []).forEach((entry) => {
                if (!entry?.type) return;
                if (!extraGroups[entry.type] || (new Date(entry.timestamp) > new Date(extraGroups[entry.type].timestamp))) extraGroups[entry.type] = entry;
            });
            Object.entries(extraGroups).forEach(([type, entry]) => {
                pills.push(`${type}: ${(entry.notes || '').slice(0, 24)}`);
                rows.push({ category: 'נתונים נוספים', name: type, timestamp: entry.timestamp || '', details: entry.notes || '' });
            });
            projectSummaryMarquee.innerHTML = pills.length ? pills.map((txt) => `<span class="project-summary-pill">${txt}</span>`).join('') : '<span class="project-summary-pill">אין עדכונים עדיין</span>';
            const sortedRows = rows.sort((a, b) => {
                const aTs = parseHebrewLocaleTimestamp(a.timestamp)?.getTime() || 0;
                const bTs = parseHebrewLocaleTimestamp(b.timestamp)?.getTime() || 0;
                return bTs - aTs;
            });
            projectSummaryTableBody.innerHTML = sortedRows.length
                ? sortedRows.map((r) => `<tr><td>${r.category}</td><td>${r.name}</td><td>${r.timestamp}</td><td>${r.details}</td></tr>`).join('')
                : '<tr><td colspan="4">אין נתונים להצגה.</td></tr>';
            projectSummaryModal.style.display = 'flex';
        }

        function closeProjectSummaryModal() {
            if (projectSummaryModal) projectSummaryModal.style.display = 'none';
        }

        function createNewProjectData(name) {
            const newProject = {
                name: name,
                isClosed: false,
                wineDetails: {
                    customProperties: []
                },
                stages: {},
                finance: [],
                generalImages: [],
                additions: {},
                extras: [],
                extraTypes: []
            };
            for(const metricId in stagesConfig.wineDetails.metrics) {
                newProject.wineDetails[metricId] = [];
            }
            for (const stageId in stagesConfig) {
                if (stageId === 'wineDetails') continue;
                newProject.stages[stageId] = {};
                for (const metricId in stagesConfig[stageId].metrics) {
                    newProject.stages[stageId][metricId] = [];
                }
            }
            return newProject;
        }
        function loadProjects() {
            // Firebase-only mode: do not load project data from localStorage.
            let loaded = {};
            if (Object.keys(loaded).length === 0) {
                loaded['default_project'] = createNewProjectData('פרויקט ראשי');
            }
            for (const projectId in loaded) {
                const project = loaded[projectId];
                if (project.isClosed === undefined) project.isClosed = false;
                if (!project.wineDetails) {
                    project.wineDetails = {};
                    const oldStage7 = project.stages && project.stages['stage7'];
                    if (oldStage7) {
                        if (oldStage7.wineName && oldStage7.wineName.length > 0) project.wineDetails.wineName = oldStage7.wineName;
                        if (oldStage7.vintageYear && oldStage7.vintageYear.length > 0) project.wineDetails.vintageYear = oldStage7.vintageYear;
                        if (oldStage7.generalNotes && oldStage7.generalNotes.length > 0) project.wineDetails.generalNotes = oldStage7.generalNotes;
                    }
                    const oldStage1 = project.stages && project.stages['stage1'];
                     if (oldStage1) {
                        if (oldStage1.harvestDate && oldStage1.harvestDate.length > 0) project.wineDetails.harvestDate = oldStage1.harvestDate;
                        if (oldStage1.grapeVariety && oldStage1.grapeVariety.length > 0) project.wineDetails.grapeVariety = oldStage1.grapeVariety;
                        if (oldStage1.vineyardSource && oldStage1.vineyardSource.length > 0) project.wineDetails.vineyardSource = oldStage1.vineyardSource;
                    }
                }
                for(const metricId in stagesConfig.wineDetails.metrics) {
                    if (!project.wineDetails[metricId]) {
                        project.wineDetails[metricId] = [];
                    }
                }
                if (!project.wineDetails.customProperties) {
                    project.wineDetails.customProperties = [];
                }
                if (!project.finance) {
                    project.finance = project.expenses || [];
                    if (project.expenses) delete project.expenses;
                }
                if (!project.generalImages) {
                    project.generalImages = [];
                }
                if (!project.additions) {
                    project.additions = {};
                }
                if (!project.extras) {
                    project.extras = [];
                }
                if (!project.extraTypes) {
                    project.extraTypes = [...new Set((project.extras || []).map((item) => item?.type).filter(Boolean))];
                }
                if (!project.stages) {
                    project.stages = {};
                }
                for (const stageId in stagesConfig) {
                    if (stageId === 'wineDetails') continue;
                    if (!project.stages[stageId]) {
                        project.stages[stageId] = {};
                    }
                    for (const metricId in stagesConfig[stageId].metrics) {
                        if (!project.stages[stageId][metricId]) {
                            project.stages[stageId][metricId] = [];
                        }
                    }
                }
                if (project.stages && project.stages['stage7'] && !stagesConfig['stage7']) {
                    delete project.stages['stage7'];
                }
            }
            return loaded;
        }
        
        function saveAllProjects() {
            // Firebase hooks trigger sync; no localStorage persistence in Firebase-only mode.
        }
        
        /**
         * Persist projects to localStorage (alias for saveAllProjects)
         */
        function persistProjects() {
            saveAllProjects();
        }
        
        /**
         * Save a project detail value and persist immediately
         * @param {string} metricId - The metric ID (e.g., 'wineName', 'vintageYear')
         * @param {string} value - The value to save
         */
        function saveProjectDetailValue(metricId, value) {
            if (!currentProjectId || !projects[currentProjectId]) return;
            if (!projects[currentProjectId].wineDetails) {
                projects[currentProjectId].wineDetails = {};
            }
            
            // Initialize array if doesn't exist
            if (!projects[currentProjectId].wineDetails[metricId]) {
                projects[currentProjectId].wineDetails[metricId] = [];
            }
            
            // Add new entry with timestamp
            const timestamp = new Date().toLocaleString('he-IL');
            projects[currentProjectId].wineDetails[metricId].push({ value, timestamp });
            
            // Persist immediately
            persistProjects();
        }
        
        /**
         * Save a stage metric value and persist immediately
         * @param {string} sectionId - The stage/section ID (e.g., 'stage1', 'stage2')
         * @param {string} metricId - The metric ID (e.g., 'brix', 'ph')
         * @param {string} value - The value to save
         */
        function saveStageMetricValue(sectionId, metricId, value) {
            if (!currentProjectId || !projects[currentProjectId]) return;
            if (!projects[currentProjectId].stages) {
                projects[currentProjectId].stages = {};
            }
            if (!projects[currentProjectId].stages[sectionId]) {
                projects[currentProjectId].stages[sectionId] = {};
            }
            
            // Initialize array if doesn't exist
            if (!projects[currentProjectId].stages[sectionId][metricId]) {
                projects[currentProjectId].stages[sectionId][metricId] = [];
            }
            
            // Add new entry with timestamp
            const timestamp = new Date().toLocaleString('he-IL');
            projects[currentProjectId].stages[sectionId][metricId].push({ value, timestamp });
            
            // Persist immediately
            persistProjects();
        }
        
        function updateProjectDisplay() {
            currentProjectNameDisplay.textContent = projects[currentProjectId].name;
            editProjectNameInput.value = projects[currentProjectId].name;
            loadCurrentStageContent();
            updateProjectDetailsCard();
        }
        function openProjectManagementModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            projectManagementModal.style.display = 'flex';
            filterProjectsByYear();
        }
        function closeProjectManagementModal() {
            projectManagementModal.style.display = 'none';
            showMainContent();
        }
        function filterProjectsByYear() {
            const selectedYear = projectYearFilter.value;
            renderProjectList(selectedYear);
        }
        function renderProjectList(yearFilter = 'all') {
            projectList.innerHTML = '';
            let projectsToDisplay = Object.keys(projects).map(id => ({ id, ...projects[id] }));
            if (sharedAccessContext.active && sharedAccessContext.allowedProjectId) {
                projectsToDisplay = projectsToDisplay.filter(p => p.id === sharedAccessContext.allowedProjectId);
            }
            if (yearFilter !== 'all') {
                projectsToDisplay = projectsToDisplay.filter(project => {
                    const vintageYearEntries = project.wineDetails.vintageYear;
                    if (vintageYearEntries && vintageYearEntries.length > 0) {
                        const latestYear = vintageYearEntries[vintageYearEntries.length - 1].value;
                        return latestYear == yearFilter;
                    }
                    return false;
                });
                // then display as before
            } else {
                const yearGroups = {};
                projectsToDisplay.forEach(project => {
                    const vintageYearEntries = project.wineDetails.vintageYear;
                    const year = vintageYearEntries && vintageYearEntries.length > 0 ? vintageYearEntries[vintageYearEntries.length - 1].value : 'לא צוין';
                    if (!yearGroups[year]) yearGroups[year] = [];
                    yearGroups[year].push(project);
                });
                const sortedYears = Object.keys(yearGroups).sort((a,b) => {
                    if (a === 'לא צוין') return 1;
                    if (b === 'לא צוין') return -1;
                    return b - a;
                });
                sortedYears.forEach(year => {
                    const yearHeader = document.createElement('h3');
                    yearHeader.textContent = year === 'לא צוין' ? 'שנים לא צוינו' : `שנה ${year}`;
                    yearHeader.style.color = 'var(--primary-color)';
                    yearHeader.style.borderBottom = '2px solid var(--border-color)';
                    yearHeader.style.paddingBottom = '10px';
                    yearHeader.style.marginBottom = '10px';
                    projectList.appendChild(yearHeader);
                    yearGroups[year].sort((a,b) => a.name.localeCompare(b.name)).forEach(project => {
                        const listItem = document.createElement('li');
                        listItem.setAttribute('data-project-id', project.id);
                        if (project.id === currentProjectId) {
                            listItem.classList.add('active-project');
                        }
                        if (project.isClosed) {
                            listItem.classList.add('closed');
                        }
                        const vintageYearEntries = project.wineDetails.vintageYear;
                        const year = vintageYearEntries && vintageYearEntries.length > 0 ? vintageYearEntries[vintageYearEntries.length - 1].value : 'לא צוין';
                        listItem.innerHTML = `
                            <span>${project.name} (${year})</span>
                            <div class="project-actions">
                                <button class="select-project-btn ${project.id === currentProjectId ? 'current-project-btn' : ''}" onclick="switchProject('${project.id}')">${project.id === currentProjectId ? 'נוכחי' : 'בחר'}</button>
                                <button class="close-project" onclick="toggleProjectClosed('${project.id}')">${project.isClosed ? 'פתח' : 'סגור'}</button>
                                ${project.id !== 'default_project' || Object.keys(projects).length > 1 ? `<button class="delete" onclick="deleteProject('${project.id}')">מחק</button>` : ''}
                            </div>
                        `;
                        projectList.appendChild(listItem);
                    });
                });
                return;
            }
            projectsToDisplay.sort((a, b) => a.name.localeCompare(b.name)).forEach(project => {
                const listItem = document.createElement('li');
                listItem.setAttribute('data-project-id', project.id);
                if (project.id === currentProjectId) {
                    listItem.classList.add('active-project');
                }
                if (project.isClosed) {
                    listItem.classList.add('closed');
                }
                const vintageYearEntries = project.wineDetails.vintageYear;
                const year = vintageYearEntries && vintageYearEntries.length > 0 ? vintageYearEntries[vintageYearEntries.length - 1].value : 'לא צוין';
                listItem.innerHTML = `
                    <span>${project.name} (${year})</span>
                    <div class="project-actions">
                        <button class="select-project-btn ${project.id === currentProjectId ? 'current-project-btn' : ''}" onclick="switchProject('${project.id}')">${project.id === currentProjectId ? 'נוכחי' : 'בחר'}</button>
                        <button class="close-project" onclick="toggleProjectClosed('${project.id}')">${project.isClosed ? 'פתח' : 'סגור'}</button>
                        ${project.id !== 'default_project' || Object.keys(projects).length > 1 ? `<button class="delete" onclick="deleteProject('${project.id}')">מחק</button>` : ''}
                    </div>
                `;
                projectList.appendChild(listItem);
            });
        }
        function toggleProjectClosed(projectId) {
            if (!ensureEditPermission(projectId)) {
                return;
            }
            projects[projectId].isClosed = !projects[projectId].isClosed;
            saveAllProjects();
            filterProjectsByYear();
        }
        function addNewProject() {
            if (newProjectModal && newProjectNameInput) {
                newProjectNameInput.value = '';
                newProjectModal.style.display = 'flex';
                setTimeout(() => newProjectNameInput.focus(), 0);
            }
        }
        /**
         * @param {string} [manualName] optional name for backward compatibility when modal is unavailable
         */
        function confirmAddNewProject(manualName) {
            if (!ensureEditPermission()) {
                return;
            }
            // Allow creating projects even without authentication for offline usage
            // Cloud sync disabled
            const nameFromModal = newProjectNameInput ? newProjectNameInput.value.trim() : '';
            const newProjectName = manualName || nameFromModal;
            if (newProjectName) {
                const newProjectId = `project_${Date.now()}`;
                projects[newProjectId] = createNewProjectData(newProjectName.trim());
                saveAllProjects();
                switchProject(newProjectId);
                filterProjectsByYear();
                closeNewProjectModal();
            } else {
                alert('אנא הזן שם לפרויקט.');
            }
        }
        function closeNewProjectModal() {
            if (newProjectModal) {
                newProjectModal.style.display = 'none';
            }
        }
        function switchProject(id) {
            if (!ensureProjectAccess(id)) {
                return;
            }
            if (projects[id].isClosed) {
                alert('לא ניתן לעבוד על פרויקט סגור. פתח אותו קודם.');
                return;
            }
            currentProjectId = id;
            localStorage.setItem('currentProjectId', currentProjectId);
            loadCurrentStageContent();
            updateProjectDisplay();
            closeProjectManagementModal();
        }
        function deleteProject(id) {
            if (!ensureEditPermission(id)) {
                return;
            }
            if (confirm('האם אתה בטוח שברצונך למחוק את הפרויקט "${projects[id].name}"? כל הנתונים יימחקו לצמיתות.')) {
                delete projects[id];
                if (currentProjectId === id) {
                    const remainingProjects = Object.keys(projects).filter(pid => !projects[pid].isClosed);
                    if (remainingProjects.length > 0) {
                        currentProjectId = remainingProjects[0];
                    } else {
                        currentProjectId = Object.keys(projects)[0];
                        if (!currentProjectId) {
                             currentProjectId = 'default_project';
                             projects[currentProjectId] = createNewProjectData('פרויקט ראשי');
                        }
                    }
                }
                saveAllProjects();
                localStorage.setItem('currentProjectId', currentProjectId);
                updateProjectDisplay();
                filterProjectsByYear();
            }
        }
        currentProjectNameDisplay.addEventListener('click', editProjectName);
        function editProjectName() {
            currentProjectNameDisplay.style.display = 'none';
            editProjectNameInput.style.display = 'inline-block';
            editProjectNameInput.focus();
            editProjectNameInput.select();
            if (!editProjectNameInput._eventListenersAdded) {
                editProjectNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        saveProjectName();
                    }
                });
                editProjectNameInput.addEventListener('blur', saveProjectName);
                editProjectNameInput.addEventListener('change', saveProjectName);
                editProjectNameInput._eventListenersAdded = true;
            }
        }
        function saveProjectName() {
            const newName = editProjectNameInput.value.trim();
            if (newName !== '' && newName !== projects[currentProjectId].name) {
                projects[currentProjectId].name = newName;
                saveAllProjects();
                updateProjectDisplay();
            }
            currentProjectNameDisplay.style.display = 'inline-block';
            editProjectNameInput.style.display = 'none';
        }
        function renderStageNavigation() {
            stageNavContainer.innerHTML = '';
            
            // Always ensure we have exactly 6 stages (stage1-stage6) in order
            const expectedStages = ['stage1', 'stage2', 'stage3', 'stage4', 'stage5', 'stage6'];
            const finalStageOrder = expectedStages.filter(stageId => stagesConfig[stageId]);
            
            const leftSideStages = finalStageOrder.slice(0, 3);
            const rightSideStages = finalStageOrder.slice(3, 6);
            const leftDiv = document.createElement('div');
            const rightDiv = document.createElement('div');
            leftSideStages.forEach(stageId => {
                const stage = stagesConfig[stageId];
                if (!stage) return; // Skip if stage config is missing
                const button = document.createElement('button');
                button.className = 'stage-nav-button';
                button.textContent = `${stage.longName}`;
                if (stageId === 'stage3' || stageId === 'stage4') button.classList.add('tight-hebrew');
                button.onclick = () => switchStage(stageId);
                if (stageId === currentStageId) {
                    button.classList.add('active');
                }
                leftDiv.appendChild(button);
            });
            const wineIconContainer = document.createElement('div');
            wineIconContainer.className = 'wine-icon-container';
            const wineIconLink = document.createElement('a');
            wineIconLink.href = "#";
            wineIconLink.onclick = (e) => { e.preventDefault(); };
            const wineIconImg = document.createElement('img');
            wineIconImg.src = "image_00b206.png";
            wineIconImg.alt = "Wine Icon";
            wineIconLink.appendChild(wineIconImg);
            wineIconContainer.appendChild(wineIconLink);
            rightSideStages.forEach(stageId => {
                const stage = stagesConfig[stageId];
                if (!stage) return; // Skip if stage config is missing
                const button = document.createElement('button');
                button.className = 'stage-nav-button';
                button.textContent = `${stage.longName}`;
                if (stageId === 'stage3' || stageId === 'stage4') button.classList.add('tight-hebrew');
                button.onclick = () => switchStage(stageId);
                if (stageId === currentStageId) {
                    button.classList.add('active');
                }
                rightDiv.appendChild(button);
            });
            stageNavContainer.appendChild(leftDiv);
            stageNavContainer.appendChild(wineIconContainer);
            stageNavContainer.appendChild(rightDiv);
        }
        function switchStage(stageId) {
            currentStageId = stageId;
            localStorage.setItem('currentStageId', currentStageId);
            renderStageNavigation();
            loadCurrentStageContent();
        }
        // Expose switchStage globally for the stage-nav-fix module
        window.switchStage = switchStage;
        function loadCurrentStageContent() {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לעבוד עליו.');
                return;
            }
            const stageConfig = stagesConfig[currentStageId];
            if (!stageConfig || currentStageId === 'wineDetails') {
                console.error("Invalid or special stage for main content:", currentStageId);
                currentStageId = Object.keys(stagesConfig).find(id => id !== 'wineDetails');
                if (!currentStageId) {
                    return;
                }
                localStorage.setItem('currentStageId', currentStageId);
                renderStageNavigation();
                loadCurrentStageContent();
                return;
            }
            if (activeCategory === 'metrics') fixedDashboardStageName.textContent = `${stageConfig.longName}`;
            currentStageInputSection.innerHTML = '';
            
            // Render predefined metrics
            const orderedMetricIds = getOrderedStageMetricIds(currentStageId);
            const predefinedMetricIds = orderedMetricIds.filter((metricId) => Boolean(stageConfig.metrics?.[metricId]));
            predefinedMetricIds.forEach((metricId) => {
                const metric = stageConfig.metrics[metricId];
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                let inputElementHTML = '';
                if (metric.type === 'select') {
                    inputElementHTML = `<select id="${metricId}Input">`;
                    inputElementHTML += `<option value="" disabled selected>${metric.placeholder}</option>`;
                    metric.options.forEach(option => {
                        inputElementHTML += `<option value="${option}">${option}</option>`;
                    });
                    inputElementHTML += `<option value="other_input_field">אחר...</option>`;
                    inputElementHTML += `</select>`;
                    inputElementHTML += `<input type="text" id="${metricId}OtherInput" placeholder="הכנס זן אחר" style="display:none; margin-top: 5px;">`;
                } else if (metric.type === 'date') {
                    inputElementHTML = `<input type="text" id="${metricId}Input" placeholder="${metric.placeholder || ''}" readonly>`;
                } else {
                    const inputType = metric.type === 'number' ? 'text' : metric.type;
                    inputElementHTML = `<input type="${inputType}" data-input-kind="${metric.type}" id="${metricId}Input" ${metric.type === 'number' ? `inputmode="decimal"` : ''} placeholder="${metric.placeholder || ''}">`;
                }
                inputGroup.innerHTML = `
                    <label for="${metricId}Input">${metric.name}:</label>
                    ${inputElementHTML}
                    <button onclick="updateMetricValue('${currentStageId}', '${metricId}')">עדכן</button>
                `;
                currentStageInputSection.appendChild(inputGroup);
                if (metric.type === 'select') {
                    const selectElement = document.getElementById(`${metricId}Input`);
                    const otherInput = document.getElementById(`${metricId}OtherInput`);
                    if (selectElement && otherInput) {
                        selectElement.addEventListener('change', () => {
                            if (selectElement.value === 'other_input_field') {
                                otherInput.style.display = 'block';
                                otherInput.focus();
                            } else {
                                otherInput.style.display = 'none';
                                otherInput.value = '';
                            }
                        });
                    }
                }
                if (metric.type === 'date') {
                    const dateInput = document.getElementById(`${metricId}Input`);
                    if (dateInput) {
                        dateInput.addEventListener('click', () => {
                            showDatePicker(dateInput.value, (selectedDate) => {
                                dateInput.value = selectedDate;
                            });
                        });
                    }
                }
            });

            // Render custom metrics with the same styling
            const customMetricIds = orderedMetricIds.filter((metricId) => Boolean(stageConfig.customMetrics?.[metricId]));
            customMetricIds.forEach((metricId) => {
                const metric = stageConfig.customMetrics[metricId];
                const inputGroup = document.createElement('div');
                inputGroup.className = 'input-group';
                let inputElementHTML = '';
                if (metric.type === 'date') {
                    inputElementHTML = `<input type="text" id="${metricId}Input" placeholder="${metric.placeholder || ''}" readonly>`;
                } else {
                    const inputType = metric.type === 'number' ? 'text' : metric.type;
                    inputElementHTML = `<input type="${inputType}" data-input-kind="${metric.type}" id="${metricId}Input" ${metric.type === 'number' ? `inputmode="decimal"` : ''} placeholder="${metric.placeholder || ''}">`;
                }
                inputGroup.innerHTML = `
                    <label for="${metricId}Input">${metric.name}:</label>
                    ${inputElementHTML}
                    <button onclick="updateMetricValue('${currentStageId}', '${metricId}')">עדכן</button>
                `;
                currentStageInputSection.appendChild(inputGroup);
                if (metric.type === 'date') {
                    const dateInput = document.getElementById(`${metricId}Input`);
                    if (dateInput) {
                        dateInput.addEventListener('click', () => {
                            showDatePicker(dateInput.value, (selectedDate) => {
                                dateInput.value = selectedDate;
                            });
                        });
                    }
                }
            });
            renderActiveCategoryDashboard();
            renderPreviousStageOverview();
            
            // Add autosave listeners for current stage inputs
            attachAutosaveListenersToStageInputs();
        }
        
        // WeakSet to track inputs with autosave listeners attached
        const autosaveListenersAttached = new WeakSet();
        
        /**
         * Attach autosave listeners to current stage input fields
         */
        function attachAutosaveListenersToStageInputs() {
            if (!currentStageInputSection) return;
            
            const inputGroups = currentStageInputSection.querySelectorAll('.input-group');
            inputGroups.forEach(group => {
                const input = group.querySelector('input[id$="Input"], select[id$="Input"]');
                if (!input) return;
                
                // Extract metricId from input id (remove "Input" suffix)
                const metricId = input.id.replace('Input', '');
                
                // Skip if already has autosave listener
                if (autosaveListenersAttached.has(input)) return;
                autosaveListenersAttached.add(input);
                
                // Add autosave on blur (when user leaves the field)
                input.addEventListener('blur', () => {
                    const value = input.value.trim();
                    if (value) {
                        // Trigger the existing update function
                        updateMetricValue(currentStageId, metricId);
                    }
                });
                
                // For select elements, also save on change
                if (input.tagName === 'SELECT') {
                    input.addEventListener('change', () => {
                        const value = input.value;
                        if (value && value !== 'other_input_field') {
                            updateMetricValue(currentStageId, metricId);
                        }
                    });
                }
            });
        }
        
        function updateMetricValue(stageId, metricId) {
            let inputElement;
            let value;
            // Check if it's a custom metric or predefined metric
            const metricConfig = stagesConfig[stageId].metrics[metricId] || stagesConfig[stageId].customMetrics[metricId];
            
            if (!metricConfig) {
                console.error('Metric not found:', metricId);
                return;
            }
            
            if (metricConfig.type === 'select') {
                inputElement = document.getElementById(`${metricId}Input`);
                if (inputElement.value === 'other_input_field') {
                    const otherInput = document.getElementById(`${metricId}OtherInput`);
                    value = otherInput.value.trim();
                } else {
                    value = inputElement.value;
                }
            } else {
                inputElement = document.getElementById(`${metricId}Input`);
                value = inputElement.value.trim();
            }
            
            // Accept both numbers and text
            // For number-type inputs, try to parse as number but allow text fallback
            if (metricConfig.type === 'number' && value !== '') {
                const numValue = parseFloat(value);
                // If it's a valid number, use it; otherwise keep as text
                if (!isNaN(numValue)) {
                    value = numValue;
                }
                // Allow text input even for number fields
            }
            
            if (value === '' || value === null || value === undefined) {
                return;
            }
            
            const timestamp = new Date().toLocaleString('he-IL', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            if (!projects[currentProjectId].stages[stageId] || !projects[currentProjectId].stages[stageId][metricId]) {
                if (!projects[currentProjectId].stages[stageId]) {
                    projects[currentProjectId].stages[stageId] = {};
                }
                projects[currentProjectId].stages[stageId][metricId] = [];
            }
            projects[currentProjectId].stages[stageId][metricId].push({ value, timestamp });
            saveAllProjects();
            if (metricConfig.type === 'select') {
                inputElement.value = "";
                const otherInput = document.getElementById(`${metricId}OtherInput`);
                if (otherInput) {
                    otherInput.value = '';
                    otherInput.style.display = 'none';
                }
            } else {
                inputElement.value = '';
            }
            updateDashboardForCurrentStage();
            renderPreviousStageOverview();
        }
        
        async function uploadMetricImageForEntry(stageId, metricId, entryIndex) {
            const entries = projects[currentProjectId]?.stages?.[stageId]?.[metricId];
            if (!entries || entryIndex < 0 || entryIndex >= entries.length) {
                alert('הרשומה לא נמצאה.');
                return;
            }

            const file = await pickImageWithCameraPreference();
            if (!file) return;

            const api = window.firebaseAccess;
            if (!api?.uploadFileToStorage || !api?.buildMetricAttachmentPath) {
                alert('שירות אחסון התמונות לא זמין.');
                return;
            }

            try {
                const targetEntry = entries[entryIndex];
                const metricEntryId = targetEntry.id || Date.now();
                targetEntry.id = metricEntryId;
                const path = api.buildMetricAttachmentPath(currentProjectId, stageId, metricId, metricEntryId, file.name);
                const uploaded = await api.uploadFileToStorage(path, file, {
                    section: 'metric',
                    projectId: currentProjectId,
                    stageId,
                    metricId,
                    metricEntryId: String(metricEntryId)
                });
                targetEntry.imageUrl = uploaded.downloadUrl;
                targetEntry.imagePath = uploaded.storagePath;
                saveAllProjects();
                updateDashboardForCurrentStage();
                const metricDisplayName = stagesConfig[stageId]?.metrics?.[metricId]?.name
                    || stagesConfig[stageId]?.customMetrics?.[metricId]?.name
                    || 'מדד';
                openHistoryModal(stageId, metricId, metricDisplayName);
            } catch (error) {
                console.error('Metric image upload failed:', error);
                alert('העלאת תמונת המדידה ל-Firebase נכשלה. ודא חיבור והרשאות Storage ונסה שוב.');
            }
        }

        function pickImageWithCameraPreference() {
            return new Promise((resolve) => {
                const picker = document.createElement('input');
                picker.type = 'file';
                picker.accept = 'image/*';
                picker.setAttribute('capture', 'environment');
                picker.style.display = 'none';
                document.body.appendChild(picker);

                const cleanup = () => {
                    picker.remove();
                };

                picker.addEventListener('change', () => {
                    const file = picker.files?.[0] || null;
                    cleanup();
                    resolve(file);
                }, { once: true });

                picker.addEventListener('cancel', () => {
                    cleanup();
                    resolve(null);
                }, { once: true });

                picker.click();
                setTimeout(() => {
                    cleanup();
                    resolve(null);
                }, 60000);
            });
        }

        function notifyNativeCameraPermissionRequest() {
            try {
                if (window.Android?.requestCameraPermission) {
                    window.Android.requestCameraPermission();
                }
            } catch (error) {
                console.warn('Android camera permission bridge failed:', error);
            }

            try {
                if (window.ReactNativeWebView?.postMessage) {
                    window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'request_camera_permission' }));
                }
            } catch (error) {
                console.warn('ReactNative camera permission bridge failed:', error);
            }
        }

        async function requestCameraPermissionStream() {
            notifyNativeCameraPermissionRequest();
            if (!navigator.mediaDevices?.getUserMedia) {
                throw new Error('המצלמה לא נתמכת בסביבה זו.');
            }
            try {
                return await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            } catch (error) {
                if (error?.name === 'NotAllowedError' || error?.name === 'PermissionDeniedError') {
                    throw new Error('אין הרשאה למצלמה. נא לאשר הרשאת מצלמה בהגדרות המכשיר.');
                }
                throw error;
            }
        }

        function openCameraFilePickerFallback() {
            return new Promise((resolve) => {
                const picker = document.createElement('input');
                picker.type = 'file';
                picker.accept = 'image/*';
                picker.setAttribute('capture', 'environment');
                picker.style.display = 'none';
                document.body.appendChild(picker);

                const cleanup = () => picker.remove();
                picker.addEventListener('change', () => {
                    const file = picker.files?.[0] || null;
                    cleanup();
                    resolve(file);
                }, { once: true });

                picker.addEventListener('cancel', () => {
                    cleanup();
                    resolve(null);
                }, { once: true });

                picker.click();
                setTimeout(() => {
                    cleanup();
                    resolve(null);
                }, 60000);
            });
        }

        async function openCameraCaptureModal({ title = 'צלם תמונה' } = {}) {
            const stream = await requestCameraPermissionStream();
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.playsInline = true;
                video.style.width = '100%';
                video.style.maxWidth = '420px';
                video.style.borderRadius = '8px';

                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px; padding: 20px;">
                        <h3>${title}</h3>
                        <div id="cameraContainer"></div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button id="cameraCaptureBtn" class="image-upload-btn" style="flex: 1;">
                                <i class="fas fa-camera"></i> צלם
                            </button>
                            <button id="cameraCancelBtn" class="camera-btn" style="flex: 1; background: linear-gradient(135deg, #f44336, #d32f2f);">
                                <i class="fas fa-times"></i> ביטול
                            </button>
                        </div>
                    </div>
                `;

                const closeModal = (file = null) => {
                    stream.getTracks().forEach(track => track.stop());
                    if (modal.parentNode) modal.parentNode.removeChild(modal);
                    resolve(file);
                };

                document.body.appendChild(modal);
                modal.querySelector('#cameraContainer')?.appendChild(video);

                modal.querySelector('#cameraCaptureBtn')?.addEventListener('click', () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 1280;
                    canvas.height = video.videoHeight || 720;
                    const ctx = canvas.getContext('2d');
                    ctx?.drawImage(video, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            closeModal(null);
                            return;
                        }
                        const file = new File([blob], `camera_${Date.now()}.jpg`, { type: 'image/jpeg' });
                        closeModal(file);
                    }, 'image/jpeg', 0.92);
                });

                modal.querySelector('#cameraCancelBtn')?.addEventListener('click', () => closeModal(null));
            });
        }


        function triggerFilePickerById(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            input.value = '';
            input.removeAttribute('capture');
            input.click();
        }

        function openGeneralImagePicker() {
            triggerFilePickerById('generalImageUpload');
        }

        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target?.result || null);
                reader.onerror = () => reject(new Error('FILE_READ_ERROR'));
                reader.readAsDataURL(file);
            });
        }

        function openMetricImagePreview(url) {
            if (!url) return;
            openMediaPreview(url, 'תצוגת תמונה');
        }

        function getOrderedStageMetricIds(stageId) {
            const stageConfig = stagesConfig[stageId] || {};
            const predefinedIds = Object.keys(stageConfig.metrics || {});
            const customIds = Object.keys(stageConfig.customMetrics || {});
            const explicitOrder = Array.isArray(stageConfig.metricOrder) ? stageConfig.metricOrder : [];
            const orderedPredefined = [
                ...explicitOrder.filter(id => predefinedIds.includes(id)),
                ...predefinedIds.filter(id => !explicitOrder.includes(id))
            ];
            return [...orderedPredefined, ...customIds];
        }


        function createDashboardMetricItem(metricId, metricConfig, currentEntries) {
            let displayValue = '--';
            const latestEntry = currentEntries && currentEntries.length > 0 ? currentEntries[currentEntries.length - 1] : null;
            if (latestEntry) {
                const lastValue = latestEntry.value;
                if (typeof lastValue === 'number' && metricConfig.precision != null) {
                    displayValue = lastValue.toFixed(metricConfig.precision || 2);
                } else {
                    displayValue = lastValue;
                }
            }

            const dashboardItem = document.createElement('div');
            dashboardItem.className = 'dashboard-item';
            dashboardItem.setAttribute('onclick', `openHistoryModal('${currentStageId}', '${metricId}', '${metricConfig.name}')`);
            const thumbHtml = latestEntry?.imageUrl
                ? `<img src="${latestEntry.imageUrl}" class="metric-thumb-preview" onclick="event.stopPropagation(); openMetricImagePreview('${latestEntry.imageUrl}')" alt="תמונת מדידה">`
                : '';
            dashboardItem.innerHTML = `
                <h3>${metricConfig.name} ${thumbHtml}</h3>
                <p>${displayValue}</p>
            `;
            return dashboardItem;
        }

        function updateDashboardForCurrentStage() {
            fixedDashboardGrid.innerHTML = '';
            const stageConfig = stagesConfig[currentStageId] || {};
            const metricOrder = getOrderedStageMetricIds(currentStageId);
            metricOrder.forEach((metricId) => {
                const metricConfig = stageConfig.metrics?.[metricId] || stageConfig.customMetrics?.[metricId];
                if (!metricConfig) return;
                const currentEntries = projects[currentProjectId]?.stages?.[currentStageId]?.[metricId] || [];
                fixedDashboardGrid.appendChild(createDashboardMetricItem(metricId, metricConfig, currentEntries));
            });
        }

        function createSecondaryDashboardItem(name, subtitle, meta, onClick) {
            const dashboardItem = document.createElement('div');
            dashboardItem.className = 'dashboard-item';
            dashboardItem.innerHTML = `<h3>${name}</h3><p>${subtitle}</p><p>${meta}</p>`;
            dashboardItem.onclick = onClick;
            return dashboardItem;
        }

        function createAdditionDashboardCard(name, entries) {
            const total = entries.reduce((acc, item) => acc + (Number(item.amount) || 0), 0);
            const unit = entries[entries.length - 1]?.unit || 'גרם';
            const dashboardItem = document.createElement('div');
            dashboardItem.className = 'dashboard-item';
            dashboardItem.innerHTML = `
                <h3>${name}</h3>
                <p>סה"כ מצטבר: ${total} ${unit}</p>
            `;
            dashboardItem.onclick = () => openSecondaryHistoryModal('addition', name);
            return dashboardItem;
        }

        function createExtraDashboardCard(type, entries) {
            const dashboardItem = document.createElement('div');
            dashboardItem.className = 'dashboard-item';
            dashboardItem.innerHTML = `
                <h3>${type}</h3>
            `;
            dashboardItem.onclick = () => openSecondaryHistoryModal('extra', type);
            return dashboardItem;
        }

        function renderAdditionsToMainDashboard() {
            fixedDashboardGrid.innerHTML = '';
            const additions = projects[currentProjectId]?.additions || {};
            const names = Object.keys(additions).filter((name) => String(name || '').trim());
            if (!names.length) {
                fixedDashboardGrid.innerHTML = '<div class="dashboard-item"><h3>תוספות</h3><p>עדיין לא נוספו תוספות.</p></div>';
                return;
            }
            names.forEach((name) => {
                const entries = additions[name] || [];
                fixedDashboardGrid.appendChild(createAdditionDashboardCard(name, entries));
            });
        }

        function renderExtrasToMainDashboard() {
            fixedDashboardGrid.innerHTML = '';
            const entries = projects[currentProjectId]?.extras || [];
            const typeSet = new Set(projects[currentProjectId]?.extraTypes || []);
            entries.forEach((entry) => {
                if (entry?.type) typeSet.add(entry.type);
            });
            const types = Array.from(typeSet).map((type) => String(type || '').trim()).filter(Boolean);
            if (!types.length) {
                fixedDashboardGrid.innerHTML = '<div class="dashboard-item"><h3>נתונים נוספים</h3><p>אין עדיין נתונים נוספים.</p></div>';
                return;
            }
            types.forEach((type) => {
                const typeEntries = entries.filter((entry) => entry.type === type);
                fixedDashboardGrid.appendChild(createExtraDashboardCard(type, typeEntries));
            });
        }

        function renderActiveCategoryDashboard() {
            if (!fixedDashboardStageName) return;
            const addCubeText = categoryAddCube?.querySelector('span');
            fixedDashboardSection?.setAttribute('data-category', activeCategory);
            if (activeCategory === 'metrics') {
                fixedDashboardStageName.textContent = stagesConfig[currentStageId]?.name || '';
                if (addCubeText) addCubeText.textContent = 'הוסף מדד';
                updateDashboardForCurrentStage();
                return;
            }
            if (activeCategory === 'additions') {
                fixedDashboardStageName.textContent = 'דשבורד תוספות';
                if (addCubeText) addCubeText.textContent = 'הוסף תוספת';
                renderAdditionsToMainDashboard();
                return;
            }
            fixedDashboardStageName.textContent = 'דשבורד נתונים נוספים';
            if (addCubeText) addCubeText.textContent = 'הוסף נתון';
            renderExtrasToMainDashboard();
        }
        /**
         * Determine whether a metric is a custom metric (stage or wine details).
         * @param {string} sectionId stage identifier or 'wineDetails'
         * @param {string} metricId metric identifier to check
         * @returns {{isCustomStageMetric: boolean, isCustomWineMetric: boolean}}
         */
        function getCustomMetricFlags(sectionId, metricId) {
            const isCustomStageMetric = sectionId !== 'wineDetails'
                && stagesConfig[sectionId]?.customMetrics
                && Boolean(stagesConfig[sectionId].customMetrics[metricId]);
            const isCustomWineMetric = sectionId === 'wineDetails'
                && Array.isArray(projects[currentProjectId]?.wineDetails?.customProperties)
                && projects[currentProjectId].wineDetails.customProperties.some(prop => prop.id === metricId);
            return { isCustomStageMetric, isCustomWineMetric };
        }
        function openHistoryModal(sectionId, metricId, metricName) {
            currentMetricTypeForModal = { sectionId, metricId };
            modalTitle.textContent = `היסטוריית ${metricName} (${stagesConfig[sectionId].name})`;
            historyList.innerHTML = '';
            modalGraphSvg.innerHTML = '';
            let metricConfig;
            let historyEntries;
            if (sectionId === 'wineDetails') {
                metricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (metricConfig) {
                    historyEntries = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    if (customProp) {
                        historyEntries = customProp.history;
                        metricConfig = { name: customProp.name, type: 'text' };
                        if (historyEntries.every(entry => typeof entry.value === 'number')) {
                            metricConfig.type = 'number';
                            metricConfig.precision = 2;
                        }
                    }
                }
            } else {
                // Check predefined metrics first, then custom metrics
                metricConfig = stagesConfig[sectionId].metrics[metricId] || stagesConfig[sectionId].customMetrics[metricId];
                historyEntries = projects[currentProjectId].stages[sectionId][metricId];
            }
            const { isCustomStageMetric, isCustomWineMetric } = getCustomMetricFlags(sectionId, metricId);
            if (deleteMetricBtn) {
                deleteMetricBtn.style.display = (isCustomStageMetric || isCustomWineMetric) ? 'inline-block' : 'none';
            }
            const precision = metricConfig ? metricConfig.precision : null;
            // Check if we have any numeric values for graphing
            const hasNumericValues = historyEntries && historyEntries.length > 0 && 
                historyEntries.some(e => typeof e.value === 'number' && !isNaN(e.value));
            
            if (metricConfig && hasNumericValues) {
                modalGraphSvg.style.display = 'block';
                historyModal.style.display = 'flex';
                setTimeout(() => {
                    drawModalGraph(historyEntries, precision);
                }, 50);
            } else {
                modalGraphSvg.style.display = 'none';
                historyModal.style.display = 'flex';
            }
            if (historyEntries && historyEntries.length > 0) {
                historyEntries.slice().reverse().forEach((entry, index) => {
                    const originalIndex = historyEntries.length - 1 - index;
                    const listItem = document.createElement('li');
                    let displayValue;
                    if (typeof entry.value === 'number' && metricConfig && metricConfig.precision != null) {
                        displayValue = entry.value.toFixed(precision);
                    } else {
                        displayValue = entry.value;
                    }
                    const imagePreviewHtml = entry.imageUrl
                        ? `<img src="${entry.imageUrl}" class="metric-thumb-preview" onclick="event.stopPropagation(); openMetricImagePreview('${entry.imageUrl}')" alt="תמונת מדידה">`
                        : '';
                    const uploadMetricImageButton = sectionId !== 'wineDetails'
                        ? `<button class="history-upload-btn" onclick="event.stopPropagation(); uploadMetricImageForEntry('${sectionId}', '${metricId}', ${originalIndex})"><i class="fas fa-camera"></i> העלאת תמונה</button>`
                        : '';
                    listItem.innerHTML = `
                        <div class="history-entry-main">
                            <strong>${displayValue}</strong>
                            <span class="timestamp">${entry.timestamp}</span>
                        </div>
                        <div class="history-entry-actions">
                            ${imagePreviewHtml}
                            ${uploadMetricImageButton}
                            <button class="history-upload-btn" onclick="editHistoryEntry('${sectionId}', '${metricId}', ${originalIndex})">ערוך</button>
                            <button class="undo-button" onclick="undoUpdate('${sectionId}', '${metricId}', ${originalIndex})">בטל</button>
                        </div>
                    `;
                    historyList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'אין נתונים היסטוריים זמינים.';
                historyList.appendChild(listItem);
            }
        }
        function drawModalGraph(entries, precision) {
            modalGraphSvg.innerHTML = '';
            
            // Filter only numeric entries for graph
            const numericEntries = entries.filter(e => typeof e.value === 'number' && !isNaN(e.value));
            
            if (numericEntries.length < 1) {
                return;
            }
            const svgWidth = modalGraphSvg.clientWidth;
            const svgHeight = modalGraphSvg.clientHeight;
            const paddingTop = 25;
            const paddingBottom = 40;
            const paddingLeft = 40;
            const paddingRight = 10;
            const graphWidth = svgWidth - paddingLeft - paddingRight;
            const graphHeight = svgHeight - paddingTop - paddingBottom;
            let values = numericEntries.map(e => e.value);
            let minValue = Math.min(...values);
            let maxValue = Math.max(...values);
            let averageValue = values.reduce((sum, val) => sum + val, 0) / values.length;
            if (numericEntries.length === 1 || minValue === maxValue) {
                const buffer = (values[0] * 0.1) || 1;
                minValue = values[0] - buffer;
                maxValue = values[0] + buffer;
                if (minValue === maxValue) {
                     minValue -= 0.5;
                     maxValue += 0.5;
                }
            }
            let comparisonEntries = null;
            if (comparisonProjectId && projects[comparisonProjectId]) {
                let compHistoryEntries;
                if (currentMetricTypeForModal.sectionId === 'wineDetails') {
                    compHistoryEntries = projects[comparisonProjectId].wineDetails[currentMetricTypeForModal.metricId];
                } else {
                    compHistoryEntries = projects[comparisonProjectId].stages[currentMetricTypeForModal.sectionId][currentMetricTypeForModal.metricId];
                }
                if (compHistoryEntries && compHistoryEntries.length > 0) {
                    // Filter numeric values from comparison entries too
                    const compNumericEntries = compHistoryEntries.filter(e => typeof e.value === 'number' && !isNaN(e.value));
                    if (compNumericEntries.length > 0) {
                        comparisonEntries = compNumericEntries;
                        const compValues = compNumericEntries.map(e => e.value);
                        minValue = Math.min(minValue, ...compValues);
                        maxValue = Math.max(maxValue, ...compValues);
                        values = values.concat(compValues);
                        averageValue = values.reduce((sum, val) => sum + val, 0) / values.length;
                    }
                }
            }
            const valueRange = maxValue - minValue;
            const xScale = (index) => paddingLeft + (index / (numericEntries.length - 1 || 1)) * graphWidth;
            const yScale = (value) => graphHeight - ((value - minValue) / valueRange) * graphHeight + paddingTop;
            const numYLabels = 3;
            for (let i = 0; i < numYLabels; i++) {
                const valueAtY = minValue + (i / (numYLabels - 1)) * valueRange;
                const yPos = yScale(valueAtY);
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', paddingLeft);
                line.setAttribute('y1', yPos);
                line.setAttribute('x2', svgWidth - paddingRight);
                line.setAttribute('y2', yPos);
                line.classList.add('modal-graph-grid-line');
                modalGraphSvg.appendChild(line);
                const textY = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textY.setAttribute('x', paddingLeft - 5);
                textY.setAttribute('y', yPos + 3);
                textY.classList.add('modal-graph-label-y');
                textY.textContent = valueAtY.toFixed(precision);
                modalGraphSvg.appendChild(textY);
            }
            let linePath = '';
            let areaPath = `M ${paddingLeft} ${yScale(minValue)}`;
            numericEntries.forEach((entry, i) => {
                const x = xScale(i);
                const y = yScale(entry.value);
                if (i === 0) {
                    linePath += `M ${x} ${y}`;
                } else {
                    linePath += `L ${x} ${y}`;
                }
                areaPath += `L ${x} ${y}`;
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', 5);
                circle.classList.add('modal-graph-point');
                circle.setAttribute('data-value', entry.value.toFixed(precision));
                circle.setAttribute('data-timestamp', entry.timestamp);
                modalGraphSvg.appendChild(circle);
                const datePart = entry.timestamp.split(',')[0];
                const timePart = entry.timestamp.split(',')[1] ? entry.timestamp.split(',')[1].trim() : '';
                const interval = Math.ceil(numericEntries.length / 5);
                if (numericEntries.length <= 2 || i % interval === 0 || i === numericEntries.length - 1) {
                    const textX = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textX.setAttribute('x', x);
                    textX.setAttribute('y', svgHeight - paddingBottom + 10);
                    textX.classList.add('modal-graph-label-x');
                    const tspanDate = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspanDate.setAttribute('x', x);
                    tspanDate.setAttribute('dy', '0em');
                    tspanDate.textContent = datePart;
                    textX.appendChild(tspanDate);
                    if (timePart) {
                        const tspanTime = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                        tspanTime.setAttribute('x', x);
                        tspanTime.setAttribute('dy', '1.2em');
                        tspanTime.textContent = timePart;
                        textX.appendChild(tspanTime);
                    }
                    modalGraphSvg.appendChild(textX);
                }
            });
            areaPath += `L ${xScale(numericEntries.length - 1)} ${yScale(minValue)} L ${paddingLeft} ${yScale(minValue)} Z`;
            const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            area.setAttribute('d', areaPath);
            area.classList.add('modal-graph-area-path');
            modalGraphSvg.appendChild(area);
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', linePath);
            path.classList.add('modal-graph-line-path');
            modalGraphSvg.appendChild(path);
            const pathLength = path.getTotalLength();
            path.style.strokeDasharray = `${pathLength} ${pathLength}`;
            path.style.strokeDashoffset = pathLength;
            setTimeout(() => {
                path.style.strokeDashoffset = 0;
            }, 100);
            if (comparisonEntries) {
                let compLinePath = '';
                let compAreaPath = `M ${paddingLeft} ${yScale(minValue)}`;
                comparisonEntries.forEach((entry, i) => {
                    const x = paddingLeft + (i / (comparisonEntries.length - 1 || 1)) * graphWidth;
                    const y = yScale(entry.value);
                    if (i === 0) {
                        compLinePath += `M ${x} ${y}`;
                    } else {
                        compLinePath += `L ${x} ${y}`;
                    }
                    compAreaPath += `L ${x} ${y}`;
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', 4);
                    circle.setAttribute('fill', '#FF6347');
                    circle.setAttribute('stroke', '#fff');
                    circle.setAttribute('stroke-width', '2');
                    circle.setAttribute('data-value', entry.value.toFixed(precision));
                    circle.setAttribute('data-timestamp', entry.timestamp);
                    modalGraphSvg.appendChild(circle);
                });
                compAreaPath += `L ${paddingLeft + ((comparisonEntries.length - 1) / (comparisonEntries.length - 1 || 1)) * graphWidth} ${yScale(minValue)} L ${paddingLeft} ${yScale(minValue)} Z`;
                const compArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                compArea.setAttribute('d', compAreaPath);
                compArea.setAttribute('fill', 'rgba(255, 99, 71, 0.2)');
                compArea.setAttribute('opacity', '0.8');
                modalGraphSvg.appendChild(compArea);
                const compPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                compPath.setAttribute('d', compLinePath);
                compPath.setAttribute('fill', 'none');
                compPath.setAttribute('stroke', '#FF6347');
                compPath.setAttribute('stroke-width', '3');
                modalGraphSvg.appendChild(compPath);
            }
            const zoom = d3.zoom().scaleExtent([0.5, 5]).on('zoom', (event) => {
                const transform = event.transform;
                modalGraphSvg.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.k})`;
            });
            d3.select(modalGraphSvg).call(zoom);
        }
        function closeHistoryModal() {
            historyModal.style.display = 'none';
            comparisonProjectId = null;
        }
        async function handleDeleteMetric() {
            if (!currentMetricTypeForModal) return;
            const { sectionId, metricId } = currentMetricTypeForModal;
            const { isCustomStageMetric, isCustomWineMetric } = getCustomMetricFlags(sectionId, metricId);
            if (!isCustomStageMetric && !isCustomWineMetric) {
                alert('ניתן למחוק רק מדדים מותאמים אישית.');
                return;
            }
            const confirmed = await showConfirmation(
                'האם אתה בטוח שברצונך למחוק מדד זה? פעולה זו תמחק גם את ההיסטוריה שלו.',
                'מחיקת מדד'
            );
            if (!confirmed) {
                return;
            }
            if (isCustomWineMetric) {
                deleteCustomProperty(metricId, true);
            } else {
                deleteCustomMetric(sectionId, metricId, true);
            }
            closeHistoryModal();
            updateDashboardForCurrentStage();
            renderPreviousStageOverview();
        }

        function editHistoryEntry(sectionId, metricId, indexToEdit) {
            let metricDataArray;
            if (sectionId === 'wineDetails') {
                const predefinedMetricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (predefinedMetricConfig) {
                    metricDataArray = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    metricDataArray = customProp?.history;
                }
            } else {
                metricDataArray = projects[currentProjectId].stages?.[sectionId]?.[metricId];
            }
            const entry = metricDataArray?.[indexToEdit];
            if (!entry) return;

            const nextValueRaw = prompt('ערך חדש', entry.value);
            if (nextValueRaw === null) return;
            const nextTime = prompt('תאריך ושעה', entry.timestamp);
            if (nextTime === null) return;

            const numericCandidate = parseFloat(nextValueRaw);
            entry.value = Number.isNaN(numericCandidate) || nextValueRaw.trim() === '' ? nextValueRaw : numericCandidate;
            entry.timestamp = nextTime;
            saveAllProjects();

            if (sectionId === 'wineDetails') {
                updateProjectDetailsCard();
            } else {
                updateDashboardForCurrentStage();
                renderPreviousStageOverview();
            }
            const metricDisplayName = (sectionId === 'wineDetails' && !stagesConfig.wineDetails.metrics[metricId])
                ? projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId)?.name || metricId
                : (stagesConfig[sectionId]?.metrics?.[metricId]?.name || stagesConfig[sectionId]?.customMetrics?.[metricId]?.name || metricId);
            openHistoryModal(sectionId, metricId, metricDisplayName);
        }

        async function undoUpdate(sectionId, metricId, indexToRemove) {
            const confirmed = await showConfirmation(
                'האם אתה בטוח שברצונך לבטל את העדכון הזה?',
                'ביטול עדכון'
            );
            if (!confirmed) {
                return;
            }
            let metricDataArray;
            if (sectionId === 'wineDetails') {
                const predefinedMetricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (predefinedMetricConfig) {
                    metricDataArray = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    if (customProp) {
                        metricDataArray = customProp.history;
                    } else {
                        console.error("Attempted to undo for non-existent custom property or metric:", metricId);
                        return;
                    }
                }
            } else {
                metricDataArray = projects[currentProjectId].stages[sectionId][metricId];
            }
            if (metricDataArray) {
                metricDataArray.splice(indexToRemove, 1);
                saveAllProjects();
                if (sectionId === 'wineDetails') {
                    updateProjectDetailsCard();
                } else {
                    updateDashboardForCurrentStage();
                    renderPreviousStageOverview();
                }
                if (currentMetricTypeForModal.sectionId === sectionId && currentMetricTypeForModal.metricId === metricId) {
                    const metricDisplayName = (sectionId === 'wineDetails' && !stagesConfig.wineDetails.metrics[metricId])
                                            ? projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId).name
                                            : stagesConfig[sectionId].metrics[metricId].name;
                    openHistoryModal(sectionId, metricId, metricDisplayName);
                }
            } else {
                console.warn(`Attempted to undo for non-existent path: project: ${currentProjectId}, stage/section: ${sectionId}, metric: ${metricId}`);
                alert("שגיאה: לא ניתן לבטל. ייתכן שהנתונים אינם קיימים.");
            }
        }
        function openFinanceModal() {
            if (!ensureFinancePermission()) {
                return;
            }
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לנהל כספים.');
                return;
            }
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            financeModal.style.display = 'flex';
            renderFinanceList();
            renderGeneralImagesList();
        }
        function closeFinanceModal() {
            financeModal.style.display = 'none';
            showMainContent();
        }
        function parseHebrewLocaleTimestamp(ts) {
            if (!ts) return null;
            const parts = ts.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})(?:, (\d{2}):(\d{2}):(\d{2}))?/);
            if (parts) {
                const year = parseInt(parts[3], 10);
                const month = parseInt(parts[2], 10) - 1;
                const day = parseInt(parts[1], 10);
                const hour = parseInt(parts[4] || 0, 10);
                const minute = parseInt(parts[5] || 0, 10);
                const second = parseInt(parts[6] || 0, 10);
                return new Date(year, month, day, hour, minute, second);
            }
            const fallback = new Date(ts);
            return Number.isNaN(fallback.getTime()) ? null : fallback;
        }

        function isSupportedAttachmentType(file) {
            if (!file) return false;
            return ALLOWED_ATTACHMENT_TYPES.includes(file.type);
        }

        function clearPendingFinanceAttachment() {
            pendingFinanceAttachmentFile = null;
            if (pendingFinanceAttachmentPreviewUrl) {
                URL.revokeObjectURL(pendingFinanceAttachmentPreviewUrl);
                pendingFinanceAttachmentPreviewUrl = '';
            }
            if (financeAttachmentInput) financeAttachmentInput.value = '';
            if (financeAttachmentPreview) {
                financeAttachmentPreview.style.display = 'none';
                financeAttachmentPreview.textContent = '';
            }
        }

        function handleFinanceAttachmentSelection() {
            const file = financeAttachmentInput?.files?.[0];
            if (!file) {
                clearPendingFinanceAttachment();
                return;
            }
            if (!isSupportedAttachmentType(file)) {
                alert('סוג קובץ לא נתמך. ניתן להעלות תמונה או PDF בלבד.');
                clearPendingFinanceAttachment();
                return;
            }
            pendingFinanceAttachmentFile = file;
            if (financeAttachmentPreview) {
                financeAttachmentPreview.style.display = 'block';
                financeAttachmentPreview.textContent = `נבחר קובץ: ${file.name}`;
            }
        }

        function openFinanceAttachmentPicker() {
            if (!financeAttachmentInput) return;
            financeAttachmentInput.value = '';
            financeAttachmentInput.setAttribute('accept', '.jpg,.jpeg,.png,.webp,.heic,.heif,.pdf,application/pdf');
            // העלאה רגילה: קבצים בלבד (ללא פתיחה של מצלמה)
            financeAttachmentInput.removeAttribute('capture');
            financeAttachmentInput.click();
        }

        function setPendingFinanceAttachment(file) {
            if (!file) return;
            pendingFinanceAttachmentFile = file;
            if (financeAttachmentPreview) {
                financeAttachmentPreview.style.display = 'block';
                financeAttachmentPreview.textContent = `נבחר קובץ: ${file.name}`;
            }
        }

        async function openFinanceCameraCapture() {
            // צילום קבלה: ניסיון לפתוח את המצלמה ישירות דרך capture
            const capturedFile = await openCameraFilePickerFallback();
            if (capturedFile) {
                setPendingFinanceAttachment(capturedFile);
                return;
            }

            // fallback אחרון: מצלמה מתוך הדפדפן (אם נתמך)
            try {
                const streamedCapture = await openCameraCaptureModal({ title: 'צילום קבלה' });
                if (streamedCapture) {
                    setPendingFinanceAttachment(streamedCapture);
                    return;
                }
            } catch (error) {
                console.warn('Finance camera capture failed:', error);
            }

            alert('לא הצלחנו לפתוח את המצלמה. בדקו הרשאת מצלמה במכשיר ונסו שוב.');
        }

        function openMediaPreview(url, title = 'תצוגת קובץ', downloadFileName = '') {
            if (!url) return;
            const modal = document.getElementById('mediaPreviewModal');
            const titleEl = document.getElementById('mediaPreviewTitle');
            const bodyEl = document.getElementById('mediaPreviewBody');
            if (!modal || !titleEl || !bodyEl) {
                window.open(url, '_blank');
                return;
            }
            titleEl.textContent = title;
            bodyEl.innerHTML = '';
            bodyEl.classList.remove('pdf-mode');
            const actionsWrap = document.createElement('div');
            actionsWrap.className = 'media-preview-actions';
            const downloadBtn = document.createElement('button');
            downloadBtn.type = 'button';
            downloadBtn.className = 'history-upload-btn';
            downloadBtn.innerHTML = '<i class="fas fa-download"></i> הורד';
            downloadBtn.addEventListener('click', async () => {
                try {
                    await triggerSingleAttachmentDownload({ url, name: downloadFileName || title }, 0);
                } catch (error) {
                    console.error('Failed to download preview file:', error);
                    alert('לא ניתן להוריד את הקובץ כרגע.');
                }
            });
            actionsWrap.appendChild(downloadBtn);
            bodyEl.appendChild(actionsWrap);
            const previewNode = document.createElement('div');
            previewNode.style.flex = '1';
            previewNode.style.width = '100%';
            previewNode.style.display = 'flex';
            previewNode.style.alignItems = 'center';
            previewNode.style.justifyContent = 'center';
            const lowerUrl = String(url).toLowerCase();
            if (lowerUrl.includes('.pdf') || lowerUrl.includes('application/pdf')) {
                bodyEl.classList.add('pdf-mode');
                previewNode.innerHTML = `<iframe src="${url}#view=FitH" title="${title}"></iframe>`;
            } else {
                previewNode.innerHTML = `<img src="${url}" alt="${title}">`;
            }
            bodyEl.appendChild(previewNode);
            modal.style.display = 'flex';
        }

        function closeMediaPreviewModal() {
            const modal = document.getElementById('mediaPreviewModal');
            const bodyEl = document.getElementById('mediaPreviewBody');
            if (bodyEl) {
                bodyEl.innerHTML = '';
                bodyEl.classList.remove('pdf-mode');
            }
            if (modal) modal.style.display = 'none';
        }

        function renderGeneralImagesList() {
            if (!generalImagesList) return;
            const images = projects[currentProjectId]?.generalImages || [];
            generalImagesList.innerHTML = '';
            if (!images.length) {
                generalImagesList.innerHTML = '<li>אין תמונות כלליות לפרויקט.</li>';
                return;
            }
            images.forEach((image, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${image.name || `תמונה ${idx + 1}`}</span>
                    <div class="finance-attachment-actions">
                        <button type="button" onclick="openMediaPreview('${image.url}', 'תמונה כללית')">פתח</button>
                        <button type="button" onclick="deleteGeneralProjectImage(${idx})">מחק</button>
                    </div>
                `;
                generalImagesList.appendChild(li);
            });
        }

        async function uploadGeneralProjectImage() {
            const file = generalImageUploadInput?.files?.[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                alert('ניתן להעלות תמונה בלבד באזור התמונות הכלליות.');
                return;
            }
            const timestamp = new Date().toLocaleString('he-IL');
            const createdAt = Date.now();
            let savedItem = null;
            try {
                const api = window.firebaseAccess;
                if (!api?.uploadFileToStorage || !api?.buildFinanceAttachmentPath) {
                    throw new Error('STORAGE_API_MISSING');
                }
                const path = api.buildFinanceAttachmentPath(currentProjectId, `general_${createdAt}`, file.name);
                const result = await api.uploadFileToStorage(path, file, { section: 'general-images', projectId: currentProjectId });
                savedItem = {
                    name: file.name,
                    type: file.type,
                    url: result.downloadUrl,
                    path: result.storagePath,
                    timestamp,
                    createdAt
                };
            } catch (error) {
                console.error('General image upload to cloud failed:', error);
                try {
                    const localUrl = await fileToDataUrl(file);
                    savedItem = {
                        name: file.name,
                        type: file.type,
                        url: localUrl,
                        path: null,
                        storedLocally: true,
                        timestamp,
                        createdAt
                    };
                    alert('שמירת התמונה בענן נכשלה, אך נשמרה מקומית בהצלחה.');
                } catch (localError) {
                    console.error('General image local save failed:', localError);
                    alert('שמירת התמונה נכשלה גם בענן וגם מקומית.');
                    return;
                }
            }
            projects[currentProjectId].generalImages.push(savedItem);
            saveAllProjects();
            renderGeneralImagesList();
            if (generalImageUploadInput) generalImageUploadInput.value = '';
        }

        async function deleteGeneralProjectImage(index) {
            const images = projects[currentProjectId]?.generalImages || [];
            const target = images[index];
            if (!target) return;
            images.splice(index, 1);
            saveAllProjects();
            renderGeneralImagesList();
            if (target.path && window.firebaseAccess?.deleteFileFromStorage) {
                window.firebaseAccess.deleteFileFromStorage(target.path).catch(() => {});
            }
        }

        async function addFinanceEntry(type) {
            if (!ensureFinancePermission()) {
                return;
            }
            const amountRaw = financeAmountInput.value.trim();
            const parsedAmount = amountRaw === '' ? null : parseFloat(amountRaw);
            const notes = financeNotesInput.value.trim();
            if (amountRaw !== '' && (isNaN(parsedAmount) || parsedAmount <= 0)) {
                alert('אנא הזן סכום חוקי (חיובי) עבור התנועה.');
                return;
            }
            if (parsedAmount === null && !pendingFinanceAttachmentFile) {
                alert('הזן סכום או צרף קבלה/חשבונית לפני שמירה.');
                return;
            }
            const entryId = Date.now();
            const timestamp = new Date().toLocaleString('he-IL', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            let attachment = null;
            if (pendingFinanceAttachmentFile) {
                try {
                    const api = window.firebaseAccess;
                    if (!api?.uploadFileToStorage || !api?.buildFinanceAttachmentPath) {
                        throw new Error('STORAGE_API_MISSING');
                    }
                    const storagePath = api.buildFinanceAttachmentPath(currentProjectId, entryId, pendingFinanceAttachmentFile.name);
                    const uploadResult = await api.uploadFileToStorage(storagePath, pendingFinanceAttachmentFile, {
                        section: 'finance',
                        projectId: currentProjectId,
                        entryId: String(entryId)
                    });
                    attachment = {
                        type: pendingFinanceAttachmentFile.type,
                        name: pendingFinanceAttachmentFile.name,
                        url: uploadResult.downloadUrl,
                        path: uploadResult.storagePath
                    };
                } catch (error) {
                    console.error('Finance attachment upload failed:', error);
                    try {
                        const localUrl = await fileToDataUrl(pendingFinanceAttachmentFile);
                        attachment = {
                            type: pendingFinanceAttachmentFile.type,
                            name: pendingFinanceAttachmentFile.name,
                            url: localUrl,
                            path: null,
                            storedLocally: true
                        };
                        alert('שמירת הקבלה בענן נכשלה, אך הקובץ נשמר מקומית בהצלחה.');
                    } catch (localError) {
                        console.error('Local attachment fallback failed:', localError);
                        attachment = null;
                        alert('שמירת הקבלה נכשלה גם בענן וגם מקומית. התנועה תישמר ללא קובץ מצורף.');
                    }
                }
            }
            projects[currentProjectId].finance.push({ id: entryId, type, amount: parsedAmount, notes, timestamp, attachment, createdAt: Date.now() });
            saveAllProjects();
            financeAmountInput.value = '';
            financeNotesInput.value = '';
            clearPendingFinanceAttachment();
            renderFinanceList();
        }
        function renderFinanceList() {
            financeList.innerHTML = '';
            let balance = 0;
            const sortedEntries = projects[currentProjectId].finance.slice().sort((a, b) => {
                const dateA = parseHebrewLocaleTimestamp(a.timestamp) || new Date(0);
                const dateB = parseHebrewLocaleTimestamp(b.timestamp) || new Date(0);
                return dateB.getTime() - dateA.getTime();
            });
            sortedEntries.forEach(entry => {
                const listItem = document.createElement('li');
                listItem.setAttribute('data-finance-id', entry.id);
                const hasAmount = typeof entry.amount === 'number' && !isNaN(entry.amount);
                const displayAmount = hasAmount ? (entry.type === 'expense' ? '-' : '+') + entry.amount.toFixed(2) : 'ללא סכום';
                const amountClass = entry.type;
                const attachmentHtml = entry.attachment
                    ? `<div class="notes"><i class="fas fa-paperclip"></i> ${entry.attachment.name || 'קובץ מצורף'}</div>`
                    : '';
                listItem.innerHTML = `
                    <div class="finance-item-details">
                        <span class="amount ${amountClass}">${displayAmount} ₪</span>
                        <div class="notes">${entry.notes || 'אין הערות'}</div>
                        ${attachmentHtml}
                        <span class="timestamp" style="font-size:0.8em; color:var(--light-text-color);">${entry.timestamp}</span>
                    </div>
                    <div class="finance-item-actions">
                        ${entry.attachment ? `<button type="button" onclick="openMediaPreview('${entry.attachment.url}', 'קבלה/חשבונית')">צפה</button><button type="button" onclick="removeFinanceAttachment(${entry.id})">מחק קובץ</button>` : ''}
                        <button onclick="editFinanceEntry(${entry.id})">ערוך</button>
                        <button class="delete" onclick="deleteFinanceEntry(${entry.id})">מחק</button>
                    </div>
                `;
                financeList.appendChild(listItem);
                if (hasAmount) {
                    if (entry.type === 'income') {
                        balance += entry.amount;
                    } else {
                        balance -= entry.amount;
                    }
                }
            });
            if (financeList.children.length === 0) {
                const listItem = document.createElement('li');
                listItem.textContent = 'אין תנועות כספיות תואמות בפרויקט זה.';
                financeList.appendChild(listItem);
            }
            currentBalanceDisplay.textContent = balance.toFixed(2);
            currentBalanceDisplay.classList.remove('positive', 'negative');
            if (balance > 0) {
                currentBalanceDisplay.classList.add('positive');
            } else if (balance < 0) {
                currentBalanceDisplay.classList.add('negative');
            }
        }
        function editFinanceEntry(id) {
            const entry = projects[currentProjectId].finance.find(e => e.id === id);
            if (!entry) return;
            editingFinanceEntryId = id;
            if (financeEditAmountInput) {
                financeEditAmountInput.value = (typeof entry.amount === 'number' && !isNaN(entry.amount)) ? entry.amount : '';
            }
            if (financeEditNotesInput) {
                financeEditNotesInput.value = entry.notes || '';
            }
            if (financeEditModal) {
                financeEditModal.style.display = 'flex';
                setTimeout(() => financeEditAmountInput?.focus(), 0);
            }
        }
        async function deleteFinanceEntry(id) {
            if (!ensureFinancePermission()) {
                return;
            }
            const confirmed = await showConfirmation(
                'האם אתה בטוח שברצונך למחוק תנועה כספית זו?',
                'מחיקת תנועה'
            );
            if (confirmed) {
                const entry = projects[currentProjectId].finance.find(item => item.id === id);
                const initialLength = projects[currentProjectId].finance.length;
                projects[currentProjectId].finance = projects[currentProjectId].finance.filter(item => item.id !== id);
                if (projects[currentProjectId].finance.length < initialLength) {
                    if (entry?.attachment?.path && window.firebaseAccess?.deleteFileFromStorage) {
                        window.firebaseAccess.deleteFileFromStorage(entry.attachment.path).catch(() => {});
                    }
                    saveAllProjects();
                    renderFinanceList();
                }
            }
        }

        async function removeFinanceAttachment(id) {
            if (!ensureFinancePermission()) {
                return;
            }
            const entry = projects[currentProjectId].finance.find(item => item.id === id);
            if (!entry || !entry.attachment) return;
            const confirmed = await showConfirmation(
                'למחוק את הקובץ המצורף מהתנועה?',
                'מחיקת קובץ'
            );
            if (!confirmed) return;
            const attachmentPath = entry.attachment.path;
            entry.attachment = null;
            saveAllProjects();
            renderFinanceList();
            if (attachmentPath && window.firebaseAccess?.deleteFileFromStorage) {
                window.firebaseAccess.deleteFileFromStorage(attachmentPath).catch(() => {});
            }
        }

        function saveFinanceEdit() {
            if (!ensureFinancePermission()) {
                return;
            }
            if (editingFinanceEntryId === null) {
                closeFinanceEditModal();
                return;
            }
            const entry = projects[currentProjectId].finance.find(e => e.id === editingFinanceEntryId);
            if (!entry) {
                closeFinanceEditModal();
                return;
            }
            const amountRaw = financeEditAmountInput ? financeEditAmountInput.value.trim() : '';
            const newAmount = amountRaw === '' ? null : parseFloat(amountRaw);
            if (amountRaw !== '' && (isNaN(newAmount) || newAmount <= 0)) {
                alert('הסכום שהוזן אינו חוקי.');
                return;
            }
            if (newAmount === null && !entry.attachment) {
                alert('יש להשאיר סכום או קובץ מצורף.');
                return;
            }
            const newNotes = financeEditNotesInput ? financeEditNotesInput.value.trim() : '';
            entry.amount = newAmount;
            entry.notes = newNotes;
            saveAllProjects();
            renderFinanceList();
            closeFinanceEditModal();
        }
        function closeFinanceEditModal() {
            if (financeEditModal) {
                financeEditModal.style.display = 'none';
            }
            editingFinanceEntryId = null;
            if (financeEditAmountInput) financeEditAmountInput.value = '';
            if (financeEditNotesInput) financeEditNotesInput.value = '';
        }
        
        
        
        function openGlobalFinanceReportModal() {
            if (!ensureFinancePermission()) {
                return;
            }
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            globalFinanceReportModal.style.display = 'flex';
            renderGlobalFinanceReport();
        }
        function closeGlobalFinanceReportModal() {
            globalFinanceReportModal.style.display = 'none';
            showMainContent();
        }
        function renderGlobalFinanceReport() {
            let globalTotalIncome = 0;
            let globalTotalExpense = 0;
            let globalBalance = 0;
            globalFinanceProjectsDetails.innerHTML = '';
            const sortedProjectIds = Object.keys(projects).sort((a,b) => projects[a].name.localeCompare(projects[b].name));
            sortedProjectIds.forEach(projectId => {
                const project = projects[projectId];
                let projectIncome = 0;
                let projectExpense = 0;
                let projectBalance = 0;
                project.finance.forEach(entry => {
                    if (typeof entry.amount !== 'number' || isNaN(entry.amount)) return;
                    if (entry.type === 'income') {
                        projectIncome += entry.amount;
                    } else {
                        projectExpense += entry.amount;
                    }
                });
                projectBalance = projectIncome - projectExpense;
                globalTotalIncome += projectIncome;
                globalTotalExpense += projectExpense;
                globalBalance += projectBalance;
                const projectSection = document.createElement('div');
                projectSection.className = 'global-finance-project-section';
                projectSection.innerHTML = `
                    <h4>${project.name}</h4>
                    <p>הכנסות: <span style="color:#4CAF50;">${projectIncome.toFixed(2)}</span> ₪</p>
                    <p>הוצאות: <span style="color:#F44336;">${projectExpense.toFixed(2)}</span> ₪</p>
                    <p>יתרה: <span class="project-balance ${projectBalance >= 0 ? 'positive' : 'negative'}">${projectBalance.toFixed(2)}</span> ₪</p>
                `;
                globalFinanceProjectsDetails.appendChild(projectSection);
            });
            globalTotalIncomeDisplay.textContent = globalTotalIncome.toFixed(2);
            globalTotalExpenseDisplay.textContent = globalTotalExpense.toFixed(2);
            globalTotalBalanceDisplay.textContent = globalBalance.toFixed(2);
            globalTotalBalanceDisplay.classList.remove('positive', 'negative');
            if (globalBalance > 0) {
                globalTotalBalanceDisplay.classList.add('positive');
            } else if (globalBalance < 0) {
                globalTotalBalanceDisplay.classList.add('negative');
            }
        }
        function openFinanceYearlyModal() {
            if (!ensureFinancePermission()) {
                return;
            }
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            financeYearlyModal.style.display = 'flex';
            yearlyReportContent.style.display = 'none';
        }
        function closeFinanceYearlyModal() {
            financeYearlyModal.style.display = 'none';
            showMainContent();
        }
        function getFinanceEntriesForYearAndMonth(project, selectedYear, selectedMonth) {
            const monthNum = selectedMonth === 'all' ? null : parseInt(selectedMonth, 10);
            return (project.finance || []).filter(entry => {
                const dateObj = entry.createdAt ? new Date(entry.createdAt) : parseHebrewLocaleTimestamp(entry.timestamp);
                if (!dateObj || Number.isNaN(dateObj.getTime())) return false;
                const matchesYear = dateObj.getFullYear() === parseInt(selectedYear, 10);
                if (!matchesYear) return false;
                if (!monthNum) return true;
                return (dateObj.getMonth() + 1) === monthNum;
            });
        }

        function generateYearlyReport() {
            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect?.value || 'all';
            if (!selectedYear) {
                alert('אנא בחר שנה.');
                return;
            }
            yearlyReportContent.style.display = 'block';
            let yearlyTotalIncome = 0;
            let yearlyTotalExpense = 0;
            let yearlyBalance = 0;
            yearlyFinanceProjectsDetails.innerHTML = '';
            const filteredProjects = Object.keys(projects).filter(projectId => {
                const project = projects[projectId];
                return getFinanceEntriesForYearAndMonth(project, selectedYear, selectedMonth).length > 0;
            });
            if (filteredProjects.length === 0) {
                yearlyFinanceProjectsDetails.innerHTML = '<p>אין פרויקטים בשנה זו.</p>';
                yearlyTotalIncomeDisplay.textContent = '0';
                yearlyTotalExpenseDisplay.textContent = '0';
                yearlyTotalBalanceDisplay.textContent = '0';
                return;
            }
            filteredProjects.forEach(projectId => {
                const project = projects[projectId];
                const entriesForPeriod = getFinanceEntriesForYearAndMonth(project, selectedYear, selectedMonth);
                let projectIncome = 0;
                let projectExpense = 0;
                entriesForPeriod.forEach(entry => {
                    if (typeof entry.amount !== 'number' || isNaN(entry.amount)) return;
                    if (entry.type === 'income') {
                        projectIncome += entry.amount;
                    } else {
                        projectExpense += entry.amount;
                    }
                });
                const projectBalance = projectIncome - projectExpense;
                yearlyTotalIncome += projectIncome;
                yearlyTotalExpense += projectExpense;
                yearlyBalance += projectBalance;
                const receiptEntries = entriesForPeriod.filter(entry => entry.attachment?.url);
                const attachmentCount = receiptEntries.length;
                const receiptsListHtml = attachmentCount
                    ? `<div class="yearly-receipts-list"><strong>קבלות בתקופה:</strong><ul>${receiptEntries.map((entry) => `<li><button type="button" class="history-upload-btn" onclick="openMediaPreview('${entry.attachment.url}', 'קבלה מהדוח השנתי')">${entry.attachment.name || 'receipt'}</button> • ${entry.timestamp}</li>`).join('')}</ul></div>`
                    : '<p>קבלות בתקופה: <strong>אין</strong></p>';
                const projectSection = document.createElement('div');
                projectSection.className = 'finance-yearly-project-section';
                projectSection.innerHTML = `
                    <h4>${project.name}</h4>
                    <p>הכנסות: <span style="color:#4CAF50;">${projectIncome.toFixed(2)}</span> ₪</p>
                    <p>הוצאות: <span style="color:#F44336;">${projectExpense.toFixed(2)}</span> ₪</p>
                    <p>יתרה: <span class="project-balance ${projectBalance >= 0 ? 'positive' : 'negative'}">${projectBalance.toFixed(2)}</span> ₪</p>
                    <p>קבלות/קבצים בתקופה: <strong>${attachmentCount}</strong></p>
                    ${receiptsListHtml}
                `;
                yearlyFinanceProjectsDetails.appendChild(projectSection);
            });
            yearlyTotalIncomeDisplay.textContent = yearlyTotalIncome.toFixed(2);
            yearlyTotalExpenseDisplay.textContent = yearlyTotalExpense.toFixed(2);
            yearlyTotalBalanceDisplay.textContent = yearlyBalance.toFixed(2);
            yearlyTotalBalanceDisplay.classList.remove('positive', 'negative');
            if (yearlyBalance > 0) {
                yearlyTotalBalanceDisplay.classList.add('positive');
            } else if (yearlyBalance < 0) {
                yearlyTotalBalanceDisplay.classList.add('negative');
            }
        }

        function collectReceiptAttachmentsForReport() {
            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect?.value || 'all';
            const receiptTypeFilter = document.getElementById('receiptTypeFilter')?.value || 'all';
            const attachments = [];
            Object.keys(projects).forEach(projectId => {
                const project = projects[projectId];
                const periodEntries = getFinanceEntriesForYearAndMonth(project, selectedYear, selectedMonth);
                periodEntries.forEach(entry => {
                    if (receiptTypeFilter !== 'all' && entry.type !== receiptTypeFilter) return;
                    if (entry.attachment?.url) {
                        attachments.push({
                            projectName: project.name,
                            timestamp: entry.timestamp,
                            name: entry.attachment.name || 'receipt',
                            type: entry.type || 'expense',
                            url: entry.attachment.url,
                            path: entry.attachment.path || ''
                        });
                    }
                });
                (project.generalImages || []).forEach((item) => {
                    const dateObj = item.createdAt ? new Date(item.createdAt) : parseHebrewLocaleTimestamp(item.timestamp);
                    if (dateObj && dateObj.getFullYear() !== parseInt(selectedYear, 10)) return;
                    if (selectedMonth !== 'all' && dateObj && (dateObj.getMonth() + 1) !== parseInt(selectedMonth, 10)) return;
                    attachments.push({
                        projectName: project.name,
                        timestamp: item.timestamp || '',
                        name: item.name || 'general_image',
                        url: item.url,
                        path: item.path || ''
                    });
                });
            });
            return attachments;
        }

        function extractStoragePathFromFirebaseUrl(url) {
            if (!url || typeof url !== 'string') return '';
            try {
                const parsed = new URL(url);
                if (!parsed.hostname.includes('firebasestorage.googleapis.com')) return '';
                const marker = '/o/';
                const markerIndex = parsed.pathname.indexOf(marker);
                if (markerIndex === -1) return '';
                const encodedPath = parsed.pathname.slice(markerIndex + marker.length);
                return decodeURIComponent(encodedPath || '');
            } catch (error) {
                return '';
            }
        }

        async function fetchAttachmentBlob(url, path = '') {
            if (!url && !path) return null;

            if (url && String(url).startsWith('data:')) {
                const response = await fetch(url);
                return response.blob();
            }

            const resolvedPath = path || extractStoragePathFromFirebaseUrl(url);
            const firebaseAccess = window.firebaseAccess || {};

            if (resolvedPath && typeof firebaseAccess.getStorageBlobByPath === 'function') {
                try {
                    return await firebaseAccess.getStorageBlobByPath(resolvedPath);
                } catch (error) {
                    console.warn('Storage SDK blob fetch failed, falling back to URL fetch.', error);
                }
            }

            if (url) {
                const response = await fetch(url, { mode: 'cors' });
                if (!response.ok) {
                    throw new Error(`HTTP_${response.status}`);
                }
                return response.blob();
            }

            throw new Error('ATTACHMENT_URL_MISSING');
        }

        const HEBREW_MONTH_NAMES = {
            '1': 'ינואר',
            '2': 'פברואר',
            '3': 'מרץ',
            '4': 'אפריל',
            '5': 'מאי',
            '6': 'יוני',
            '7': 'יולי',
            '8': 'אוגוסט',
            '9': 'ספטמבר',
            '10': 'אוקטובר',
            '11': 'נובמבר',
            '12': 'דצמבר'
        };

        function getSelectedPeriodLabel() {
            const selectedYear = yearSelect?.value || new Date().getFullYear();
            const selectedMonth = monthSelect?.value || 'all';
            if (selectedMonth === 'all') {
                return `${selectedYear} כל השנה`;
            }
            return `${selectedYear} חודש ${HEBREW_MONTH_NAMES[selectedMonth] || selectedMonth}`;
        }

        async function buildYearlyReceiptsZipBlob(attachments) {
            if (!window.JSZip) {
                throw new Error('ZIP_LIBRARY_UNAVAILABLE');
            }

            const zip = new JSZip();
            const sortedAttachments = attachments.slice().sort((a, b) => (a.projectName || '').localeCompare(b.projectName || '') || (a.timestamp || '').localeCompare(b.timestamp || '') || (a.name || '').localeCompare(b.name || ''));
            for (let i = 0; i < sortedAttachments.length; i += 1) {
                const file = sortedAttachments[i];
                try {
                    const blob = await fetchAttachmentBlob(file.url, file.path);
                    const safeName = (file.name || `receipt_${i + 1}`).replace(/[^\w.\-]/g, '_');
                    const sequence = String(i + 1).padStart(3, '0');
                    zip.file(`${sequence}_${safeName}`, blob);
                } catch (error) {
                    console.warn('Skipping file during ZIP build:', error);
                }
            }

            if (!Object.keys(zip.files).length) {
                throw new Error('NO_DOWNLOADABLE_FILES');
            }

            zip.file('PERIOD.txt', `קבצים להורדה ${getSelectedPeriodLabel()}`);
            return zip.generateAsync({ type: 'blob' });
        }

        function sanitizeDownloadFileName(name, fallback = 'download') {
            return (name || fallback).replace(/[\/:*?"<>|]+/g, '_');
        }

        async function triggerSingleAttachmentDownload(item, index = 0) {
            if (!item) return;
            const fallbackName = `attachment_${String(index + 1).padStart(3, '0')}`;
            const fileName = sanitizeDownloadFileName(item.name, fallbackName);
            const blob = await fetchAttachmentBlob(item.url, item.path);
            if (!blob) {
                throw new Error('ATTACHMENT_BLOB_MISSING');
            }
            downloadBlob(blob, fileName);
        }

        function downloadBlob(blob, fileName) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = sanitizeDownloadFileName(fileName);
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function buildYearlyZipFileName() {
            const safeMonth = monthSelect?.value || 'all';
            return `receipts_${yearSelect?.value || 'all'}_${safeMonth}.zip`;
        }

        async function resolveAttachmentDownloadUrl(item) {
            if (item?.url) return item.url;
            if (item?.path && typeof window.firebaseAccess?.getStorageDownloadUrlByPath === 'function') {
                return window.firebaseAccess.getStorageDownloadUrlByPath(item.path);
            }
            return '';
        }

        async function downloadAttachmentsDirectly(attachments) {
            let startedDownloads = 0;

            for (let i = 0; i < attachments.length; i += 1) {
                const item = attachments[i];
                try {
                    if (i > 0) {
                        await new Promise((resolve) => setTimeout(resolve, 500));
                    }
                    await triggerSingleAttachmentDownload(item, i);
                    startedDownloads += 1;
                } catch (error) {
                    console.warn('Failed to start direct download for attachment:', item, error);
                }
            }

            if (!startedDownloads) {
                throw new Error('NO_DIRECT_DOWNLOADS_STARTED');
            }

            return startedDownloads;
        }

        async function downloadYearlyReceiptsZip() {
            const attachments = collectReceiptAttachmentsForReport();
            if (!attachments.length) {
                alert('לא נמצאו קבלות לתקופה שנבחרה.');
                return;
            }

            try {
                const startedDownloads = await downloadAttachmentsDirectly(attachments);
                alert(`התחלנו ${startedDownloads} הורדות. אם הדפדפן חסם חלק מהן, יש לאשר הורדות מרובות עבור האתר.`);
            } catch (error) {
                console.warn('Direct download failed, trying ZIP fallback.', error);
                try {
                    const zipBlob = await buildYearlyReceiptsZipBlob(attachments);
                    downloadBlob(zipBlob, buildYearlyZipFileName());
                } catch (zipError) {
                    if (zipError.message === 'ZIP_LIBRARY_UNAVAILABLE') {
                        alert('ספריית ZIP לא זמינה כעת.');
                        return;
                    }
                    alert('לא ניתן היה להוריד את הקבצים כרגע. נסה/י שוב בעוד כמה רגעים.');
                }
            }
        }

        async function uploadYearlyReceiptsZipAndGetLink(zipBlob) {
            const accountUid = getActiveDataAccountUid();
            if (!window.firebaseAccess?.uploadFileToStorage || !accountUid) {
                return '';
            }
            const storagePath = `public/exports/${accountUid}/yearly_${yearSelect?.value || 'all'}_${monthSelect?.value || 'all'}_${Date.now()}.zip`;
            const uploadResult = await window.firebaseAccess.uploadFileToStorage(storagePath, new File([zipBlob], buildYearlyZipFileName(), { type: 'application/zip' }), {
                reportType: 'yearly_finance_receipts',
                period: getSelectedPeriodLabel()
            });
            return uploadResult?.downloadUrl || '';
        }

        function buildEmailReceiptsMessage(attachments, periodLabel, zipDownloadLink = '') {
            const lines = [];
            lines.push(`קבצים להורדה ${periodLabel}`);
            lines.push('');

            if (zipDownloadLink) {
                lines.push('להורדת כל הקבצים יחד לחץ כאן:');
                lines.push(zipDownloadLink);
                lines.push('');
            }

            lines.push('להורדת הקבצים לחץ כאן:');
            attachments.forEach((item, index) => {
                const fileName = item.name || `קובץ ${index + 1}`;
                const projectName = item.projectName || 'ללא פרויקט';
                const timestamp = item.timestamp || '';
                const title = `${index + 1}. ${fileName} (${projectName}${timestamp ? ` | ${timestamp}` : ''})`;
                lines.push(title);
                lines.push(item.url || '');
                lines.push('');
            });

            return lines.join('\n').trim();
        }

        function buildWhatsappReceiptsMessage(attachments, periodLabel, zipDownloadLink = '') {
            const lines = [];
            lines.push(`קבצים להורדה ${periodLabel}`);
            lines.push('');

            if (zipDownloadLink) {
                lines.push('קישור מרוכז להורדה:');
                lines.push(zipDownloadLink);
                lines.push('');
            }

            lines.push('קישורים לכל הקבצים:');
            attachments.forEach((item, index) => {
                const fileName = item.name || `קובץ ${index + 1}`;
                lines.push(`${index + 1}. ${fileName}`);
                lines.push(item.url || '');
            });

            return lines.join('\n').trim();
        }

        function openExternalAppLink(deepLink, fallbackUrl = '') {
            const normalizedDeepLink = typeof deepLink === 'string' ? deepLink.trim() : '';
            const normalizedFallback = typeof fallbackUrl === 'string' ? fallbackUrl.trim() : '';
            const targetUrl = normalizedDeepLink || normalizedFallback;
            if (!targetUrl) return false;

            try {
                window.location.href = targetUrl;
            } catch (error) {
                console.warn('Failed to set location.href for external app link', error);
            }

            let popupOpened = false;
            try {
                const popup = window.open(targetUrl, '_blank');
                popupOpened = !!popup;
            } catch (error) {
                console.warn('Failed to open external app link with window.open', error);
            }

            if (normalizedFallback && normalizedDeepLink && normalizedFallback !== normalizedDeepLink) {
                setTimeout(() => {
                    try {
                        window.location.href = normalizedFallback;
                    } catch (error) {
                        console.warn('Failed to open fallback app link', error);
                    }
                }, 500);
            }

            return popupOpened || !!targetUrl;
        }

        async function shareYearlyReceipts(channel) {
            const attachments = collectReceiptAttachmentsForReport();
            if (!attachments.length) {
                alert('לא נמצאו קבלות לתקופה שנבחרה.');
                return;
            }

            const periodLabel = getSelectedPeriodLabel();
            if (channel === 'email') {
                let zipDownloadLink = '';
                try {
                    const zipBlob = await buildYearlyReceiptsZipBlob(attachments);
                    zipDownloadLink = await uploadYearlyReceiptsZipAndGetLink(zipBlob);
                } catch (error) {
                    console.warn('Could not build/upload ZIP for email share, falling back to individual links.', error);
                }

                const bodyMessage = buildEmailReceiptsMessage(attachments, periodLabel, zipDownloadLink);
                const subject = encodeURIComponent(`קבצים להורדה ${periodLabel}`);
                const body = encodeURIComponent(bodyMessage);
                const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;
                const opened = openExternalAppLink(mailtoUrl);
                if (!opened) {
                    alert('לא הצלחנו לפתוח את אפליקציית המייל כרגע. נסה/י שוב בעוד כמה רגעים.');
                }
                return;
            }

            let downloadLink = '';
            try {
                const zipBlob = await buildYearlyReceiptsZipBlob(attachments);
                downloadLink = await uploadYearlyReceiptsZipAndGetLink(zipBlob);
            } catch (error) {
                console.warn('Could not build/upload ZIP for share', error);
            }

            if (!downloadLink) {
                alert('לא ניתן ליצור קישור הורדה כרגע. נסה/י שוב בעוד כמה רגעים.');
                return;
            }

            const message = buildWhatsappReceiptsMessage(attachments, periodLabel, downloadLink);
            if (channel === 'whatsapp') {
                const encodedMessage = encodeURIComponent(message);
                const opened = openExternalAppLink(`whatsapp://send?text=${encodedMessage}`, `https://wa.me/?text=${encodedMessage}`);
                if (!opened) {
                    alert('לא הצלחנו לפתוח את WhatsApp כרגע. נסה/י שוב בעוד כמה רגעים.');
                }
            }
        }


        let currentFinanceMediaListAttachments = [];

        function openFinanceMediaListModal(mode = 'yearly') {
            const listEl = document.getElementById('financeMediaList');
            const titleEl = document.getElementById('financeMediaListTitle');
            const modalEl = document.getElementById('financeMediaListModal');
            if (!listEl || !titleEl || !modalEl) return;

            const selectedYear = yearSelect.value;
            const selectedMonth = monthSelect?.value || 'all';
            const attachments = mode === 'global'
                ? collectAllFinanceMedia()
                : collectReceiptAttachmentsForReport();
            currentFinanceMediaListAttachments = attachments.slice();

            titleEl.textContent = mode === 'global'
                ? 'קבלות/תמונות/PDF - דוח כספי כולל'
                : `קבלות/תמונות/PDF - ${selectedYear}${selectedMonth !== 'all' ? '/' + selectedMonth : ''}`;

            listEl.innerHTML = '';
            if (!attachments.length) {
                listEl.innerHTML = '<li>לא נמצאו קבצים מצורפים.</li>';
            } else {
                attachments.forEach((item, idx) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div class="history-entry-main">
                            <strong>${idx + 1}. ${item.name || 'קובץ'}</strong>
                            <span class="timestamp">${item.projectName || ''} | ${item.timestamp || ''}</span>
                        </div>
                        <div class="history-entry-actions">
                            <button class="history-upload-btn" onclick="openMediaPreview('${item.url}', 'קובץ מצורף', '${item.name || 'attachment'}')">פתח</button>
                            <button class="history-upload-btn" onclick="downloadSingleFinanceAttachment(${idx})"><i class="fas fa-download"></i> הורד</button>
                        </div>
                    `;
                    listEl.appendChild(li);
                });
            }
            modalEl.style.display = 'flex';
        }

        function closeFinanceMediaListModal() {
            const modalEl = document.getElementById('financeMediaListModal');
            if (modalEl) modalEl.style.display = 'none';
            currentFinanceMediaListAttachments = [];
        }


        async function downloadSingleFinanceAttachment(index) {
            const attachments = currentFinanceMediaListAttachments.length
                ? currentFinanceMediaListAttachments
                : collectReceiptAttachmentsForReport();
            const item = attachments[index];
            if (!item) {
                alert('הקובץ לא נמצא.');
                return;
            }
            try {
                await triggerSingleAttachmentDownload(item, index);
            } catch (error) {
                console.error('Failed to download attachment:', error);
                alert('לא ניתן להוריד את הקובץ כרגע.');
            }
        }

        function collectAllFinanceMedia() {
            const attachments = [];
            Object.keys(projects).forEach(projectId => {
                const project = projects[projectId];
                (project.finance || []).forEach(entry => {
                    if (entry.attachment?.url) {
                        attachments.push({
                            projectName: project.name,
                            timestamp: entry.timestamp,
                            name: entry.attachment.name || 'receipt',
                            url: entry.attachment.url
                        });
                    }
                });
                (project.generalImages || []).forEach(item => {
                    if (item?.url) {
                        attachments.push({
                            projectName: project.name,
                            timestamp: item.timestamp || '',
                            name: item.name || 'general_image',
                            url: item.url
                        });
                    }
                });
            });
            return attachments.sort((a, b) => (a.projectName || '').localeCompare(b.projectName || '') || (a.timestamp || '').localeCompare(b.timestamp || ''));
        }

        function renderPreviousStageOverview() {
            stepCardsGrid.innerHTML = '';
            const stageOrder = ['stage1', 'stage2', 'stage3', 'stage4', 'stage5', 'stage6'].filter(id => stagesConfig[id]);
            const currentStageIndex = stageOrder.indexOf(currentStageId);
            
            // Stage overview is shown only in metrics category
            const shouldShowOverview = activeCategory === 'metrics';
            stageOverviewContainer.style.display = shouldShowOverview ? 'block' : 'none';
            if (!shouldShowOverview) return;
            
            if (currentStageIndex === 0) {
                // For harvest stage (first stage), show empty state message
                const emptyStateDiv = document.createElement('div');
                emptyStateDiv.className = 'stage-overview-empty-state';
                emptyStateDiv.innerHTML = `
                    <p>
                        <i class="fas fa-info-circle"></i>
                        אין עדיין נתונים משלבים קודמים. זהו השלב הראשון.
                    </p>
                `;
                stepCardsGrid.appendChild(emptyStateDiv);
                return;
            }
            
            for (let i = 0; i < currentStageIndex; i++) {
                const prevStageId = stageOrder[i];
                const prevStageConfig = stagesConfig[prevStageId];
                const prevStageData = projects[currentProjectId].stages[prevStageId];
                const card = document.createElement('div');
                card.className = 'step-preview-card';
                card.onclick = () => switchStage(prevStageId);
                card.innerHTML = `<h5>${prevStageConfig.longName}</h5>`;
                if (prevStageConfig.summaryMetrics) {
                    prevStageConfig.summaryMetrics.forEach(metricId => {
                        const metricConfig = prevStageConfig.metrics[metricId];
                        const entries = prevStageData[metricId];
                        let displayValue = '--';
                        if (entries && entries.length > 0) {
                            displayValue = metricConfig.type === 'number' && typeof entries[entries.length - 1].value === 'number'
                                ? entries[entries.length - 1].value.toFixed(metricConfig.precision)
                                : entries[entries.length - 1].value;
                        }
                        card.innerHTML += `<p>${metricConfig.name}: <span class="summary-value">${displayValue}</span></p>`;
                    });
                } else {
                     card.innerHTML += `<p>אין מדדי סיכום לשלב זה.</p>`;
                }
                stepCardsGrid.appendChild(card);
            }
        }
        function updateProjectDetailsCard() {
            const projectData = projects[currentProjectId];
            const wineDetailsData = projectData.wineDetails || {};
            const addCustomPropertyBtn = projectDetailsCard.querySelector('.add-custom-property-btn');
            projectDetailsCard.querySelectorAll('.project-details-item').forEach(item => {
                if (!item.classList.contains('custom-property')) {
                    item.remove();
                } else if (!addCustomPropertyBtn.contains(item)) {
                    item.remove();
                }
            });
            const predefinedMetrics = ['wineName', 'vintageYear', 'grapeVariety', 'vineyardSource', 'generalNotes', 'harvestDate'];
            predefinedMetrics.forEach(metricId => {
                const metricConfig = stagesConfig.wineDetails.metrics[metricId];
                const item = document.createElement('div');
                item.className = 'project-details-item';
                item.setAttribute('data-metric-id', metricId);
                item.setAttribute('data-section', 'wineDetails');
                item.innerHTML = `
                    <span class="detail-label">${metricConfig.name}:</span>
                    <span class="detail-value editable">--</span>
                `;
                projectDetailsCard.insertBefore(item, addCustomPropertyBtn);
                attachEditListenerToDetailItem(item);
            });
            const getLatestWineDetailValue = (metricId, precision = null) => {
                let entries;
                if (stagesConfig.wineDetails.metrics[metricId]) {
                    entries = wineDetailsData[metricId];
                } else {
                    const customProp = wineDetailsData.customProperties.find(prop => prop.id === metricId);
                    entries = customProp ? customProp.history : null;
                }
                if (entries && entries.length > 0) {
                    const value = entries[entries.length - 1].value;
                    return (typeof value === 'number' && precision !== null) ? value.toFixed(precision) : value;
                }
                return '--';
            };
            predefinedMetrics.forEach(metricId => {
                const item = projectDetailsCard.querySelector(`[data-metric-id="${metricId}"]`);
                if (item) {
                    const displaySpan = item.querySelector('.detail-value');
                    const metricConfig = stagesConfig.wineDetails.metrics[metricId];
                    const precision = metricConfig.type === 'number' ? metricConfig.precision : null;
                    displaySpan.textContent = getLatestWineDetailValue(metricId, precision);
                }
            });
            if (projectData.wineDetails.customProperties) {
                projectData.wineDetails.customProperties.forEach(prop => {
                    const customPropertyItem = document.createElement('div');
                    customPropertyItem.className = 'project-details-item custom-property';
                    customPropertyItem.setAttribute('data-metric-id', prop.id);
                    customPropertyItem.setAttribute('data-section', 'wineDetails');
                    customPropertyItem.innerHTML = `
                        <span class="detail-label">${prop.name}:</span>
                        <span class="detail-value editable">${getLatestWineDetailValue(prop.id)}</span>
                        <button class="delete-custom-prop-btn" onclick="deleteCustomProperty('${prop.id}')">מחק</button>
                    `;
                    projectDetailsCard.insertBefore(customPropertyItem, addCustomPropertyBtn);
                    attachEditListenerToDetailItem(customPropertyItem);
                });
            }
        }
        function addCustomProperty() {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לערוך.');
                return;
            }
            if (customPropertyModal && customPropertyNameInput) {
                customPropertyNameInput.value = '';
                customPropertyModal.style.display = 'flex';
                setTimeout(() => customPropertyNameInput.focus(), 0);
            }
        }
        function confirmAddCustomProperty() {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לערוך.');
                return;
            }
            if (!ensureEditPermission()) {
                return;
            }
            const propName = customPropertyNameInput ? customPropertyNameInput.value.trim() : '';
            if (propName) {
                const propId = `customProp_${Date.now()}`;
                const newCustomProperty = {
                    id: propId,
                    name: propName,
                    history: []
                };
                projects[currentProjectId].wineDetails.customProperties.push(newCustomProperty);
                saveAllProjects();
                updateProjectDetailsCard();
                closeCustomPropertyModal();
            } else {
                alert('אנא הזן שם לשדה המותאם אישית.');
            }
        }
        async function deleteCustomProperty(propId, skipConfirm = false) {
            if (projects[currentProjectId].isClosed) {
                alert('הפרויקט סגור. פתח אותו כדי לערוך.');
                return;
            }
            if (!ensureEditPermission()) {
                return;
            }
            if (!skipConfirm) {
                const confirmed = await showConfirmation(
                    'האם אתה בטוח שברצונך למחוק שדה מותאם אישית זה?',
                    'מחיקת שדה'
                );
                if (!confirmed) {
                    return;
                }
            }
            projects[currentProjectId].wineDetails.customProperties = projects[currentProjectId].wineDetails.customProperties.filter(prop => prop.id !== propId);
            saveAllProjects();
            updateProjectDetailsCard();
        }
        function closeCustomPropertyModal() {
            if (customPropertyModal) {
                customPropertyModal.style.display = 'none';
            }
        }
        function attachEditListenerToDetailItem(item) {
            const displaySpan = item.querySelector('.detail-value');
            if (item._displaySpanClickHandler) {
                displaySpan.removeEventListener('click', item._displaySpanClickHandler);
            }
            const newClickHandler = () => {
                if (projects[currentProjectId].isClosed) {
                    alert('הפרויקט סגור. פתח אותו כדי לערוך.');
                    return;
                }
                if (!ensureEditPermission()) {
                    return;
                }
                if (currentEditableDetailElement && currentEditableDetailElement.displaySpan !== displaySpan) {
                    saveEditableDetail();
                }
                if (currentEditableDetailElement && currentEditableDetailElement.displaySpan === displaySpan) {
                    return;
                }
                const metricId = item.dataset.metricId;
                const section = item.dataset.section;
                let metricConfig;
                if (stagesConfig.wineDetails.metrics[metricId]) {
                    metricConfig = stagesConfig.wineDetails.metrics[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    metricConfig = { type: 'text', name: item.querySelector('.detail-label').textContent.replace(':', '') };
                    if (customProp && customProp.history.length > 0 && customProp.history.every(entry => typeof entry.value === 'number')) {
                        metricConfig.type = 'number';
                        metricConfig.step = 'any';
                        metricConfig.precision = 2;
                    }
                }
                currentEditableDetailElement = { item, metricId, section, metricConfig, displaySpan: displaySpan };
                let currentValue = displaySpan.textContent === '--' ? '' : displaySpan.textContent;
                let inputElement;
                if (metricConfig.type === 'date') {
                    showDatePicker(currentValue, (selectedDate) => {
                        updateProjectDetailValue(section, metricId, selectedDate);
                        displaySpan.style.display = 'block';
                        currentEditableDetailElement = null;
                    });
                    displaySpan.style.display = 'none';
                    return;
                } else if (metricConfig.type === 'select') {
                    inputElement = document.createElement('select');
                    inputElement.innerHTML = `<option value="" disabled>--בחר--</option>`;
                    if (metricConfig.options) {
                        metricConfig.options.forEach(option => {
                            const optionElem = document.createElement('option');
                            optionElem.value = option;
                            optionElem.textContent = option;
                            if (option === currentValue) {
                                optionElem.selected = true;
                            }
                            inputElement.appendChild(optionElem);
                        });
                    }
                    const otherOption = document.createElement('option');
                    otherOption.value = 'other_input_field';
                    otherOption.textContent = 'אחר...';
                    inputElement.appendChild(otherOption);
                    const otherInput = document.createElement('input');
                    otherInput.type = 'text';
                    otherInput.placeholder = 'הכנס ערך אחר';
                    otherInput.style.display = 'none';
                    otherInput.style.marginTop = '5px';
                    inputElement.addEventListener('change', () => {
                        if (inputElement.value === 'other_input_field') {
                            otherInput.style.display = 'block';
                            otherInput.focus();
                        } else {
                            otherInput.style.display = 'none';
                            otherInput.value = '';
                        }
                    });
                    if (currentValue && metricConfig.options && !metricConfig.options.includes(currentValue) && currentValue !== '--') {
                        inputElement.value = 'other_input_field';
                        otherInput.value = currentValue;
                        otherInput.style.display = 'block';
                    }
                    item.appendChild(inputElement);
                    item.appendChild(otherInput);
                    inputElement.focus();
                    currentEditableDetailElement.inputElement = inputElement;
                    currentEditableDetailElement.otherInput = otherInput;
                    
                    // For select, we want to save immediately on change
                    inputElement.addEventListener('change', saveEditableDetail);
                    // For the "other" input, use similar delayed save as text inputs
                    let otherSaveScheduled = false;
                    const scheduleOtherSave = () => {
                        if (otherSaveScheduled) return;
                        otherSaveScheduled = true;
                        setTimeout(() => {
                            saveEditableDetail();
                            otherSaveScheduled = false;
                        }, 100);
                    };
                    otherInput.addEventListener('blur', scheduleOtherSave);
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = metricConfig.type === 'number' ? 'text' : metricConfig.type;
                    inputElement.value = currentValue;
                    inputElement.placeholder = metricConfig.placeholder || '';
                    item.appendChild(inputElement);
                    inputElement.focus();
                    inputElement.select();
                    currentEditableDetailElement.inputElement = inputElement;
                    
                    // Use a flag to prevent double-saving
                    let saveScheduled = false;
                    const scheduleSave = () => {
                        if (saveScheduled) return;
                        saveScheduled = true;
                        // Small delay to allow the user to finish typing on mobile
                        setTimeout(() => {
                            saveEditableDetail();
                            saveScheduled = false;
                        }, 100);
                    };
                    
                    inputElement.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            // Save immediately on Enter key
                            saveEditableDetail();
                        }
                    });
                    // Use blur event for saving when user leaves the field
                    // Small delay helps prevent premature saves on mobile keyboards
                    inputElement.addEventListener('blur', scheduleSave);
                }
                displaySpan.style.display = 'none';
            };
            displaySpan.addEventListener('click', newClickHandler);
            item._displaySpanClickHandler = newClickHandler;
        }
        function saveEditableDetail() {
            if (!currentEditableDetailElement) return;
            const { item, metricId, section, metricConfig, displaySpan, inputElement, otherInput } = currentEditableDetailElement;
            let newValue;
            if (metricConfig.type === 'select') {
                if (inputElement.value === 'other_input_field' && otherInput) {
                    newValue = otherInput.value.trim();
                } else {
                    newValue = inputElement.value;
                }
                if (otherInput) {
                    otherInput.remove();
                }
            } else {
                newValue = inputElement.value;
            }
            if (metricConfig.type === 'number') {
                newValue = parseFloat(newValue);
            }
            const oldValue = displaySpan.textContent === '--' ? '' : displaySpan.textContent;
            if (newValue !== oldValue && (metricConfig.type === 'number' ? !isNaN(newValue) : newValue !== "")) {
                updateProjectDetailValue(section, metricId, newValue);
                // Update display value without full card refresh
                const latestValue = getLatestProjectDetailValue(section, metricId);
                displaySpan.textContent = latestValue;
            }
            if (inputElement) {
                inputElement.remove();
            }
            displaySpan.style.display = 'block';
            currentEditableDetailElement = null;
            // Only update dashboard if this is the current stage, but don't refresh the entire card
            if (section === currentStageId) {
                updateDashboardForCurrentStage();
            }
            renderPreviousStageOverview();
        }
        
        function getLatestProjectDetailValue(section, metricId) {
            let entries;
            if (section === 'wineDetails') {
                const predefinedMetricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (predefinedMetricConfig) {
                    entries = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    entries = customProp ? customProp.history : null;
                }
            } else {
                entries = projects[currentProjectId].stages[section][metricId];
            }
            if (entries && entries.length > 0) {
                return entries[entries.length - 1].value;
            }
            return '--';
        }
        function updateProjectDetailValue(section, metricId, newValue) {
            if (!ensureEditPermission()) {
                return;
            }
            let metricDataArray;
            if (section === 'wineDetails') {
                const predefinedMetricConfig = stagesConfig.wineDetails.metrics[metricId];
                if (predefinedMetricConfig) {
                    metricDataArray = projects[currentProjectId].wineDetails[metricId];
                } else {
                    const customProp = projects[currentProjectId].wineDetails.customProperties.find(prop => prop.id === metricId);
                    if (customProp) {
                        metricDataArray = customProp.history;
                    } else {
                        console.error("Attempted to update non-existent custom property or metric:", metricId);
                        return;
                    }
                }
            } else {
                metricDataArray = projects[currentProjectId].stages[section][metricId];
            }
            const timestamp = new Date().toLocaleString('he-IL', {
                year: 'numeric', month: 'numeric', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            if (!metricDataArray) {
                console.error("Metric data array not found, initializing:", section, metricId);
                if (section === 'wineDetails') {
                    if (stagesConfig.wineDetails.metrics[metricId]) {
                        projects[currentProjectId].wineDetails[metricId] = [];
                    } else {
                        return;
                    }
                } else {
                    if (!projects[currentProjectId].stages[section]) projects[currentProjectId].stages[section] = {};
                    projects[currentProjectId].stages[section][metricId] = [];
                }
                metricDataArray = (section === 'wineDetails' ? projects[currentProjectId].wineDetails[metricId] : projects[currentProjectId].stages[section][metricId]);
            }
            if (metricDataArray.length > 0) {
                metricDataArray[metricDataArray.length - 1].value = newValue;
                metricDataArray[metricDataArray.length - 1].timestamp = timestamp;
            } else {
                metricDataArray.push({ value: newValue, timestamp: timestamp });
            }
            saveAllProjects();
            updateProjectDetailsCard();
            if (section === currentStageId) {
                updateDashboardForCurrentStage();
            }
            renderPreviousStageOverview();
        }
        function showDatePicker(initialDate, callback) {
            datePickerCallback = callback;
            datePickerModal.style.display = 'flex';
            let initialMonth, initialYear;
            if (initialDate && initialDate.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const parts = initialDate.split('/');
                initialMonth = parseInt(parts[1], 10) - 1;
                initialYear = parseInt(parts[2], 10);
            } else {
                const today = new Date();
                initialMonth = today.getMonth();
                initialYear = today.getFullYear();
            }
            datePickerCurrentMonth = initialMonth;
            datePickerCurrentYear = initialYear;
            renderCalendar(datePickerCurrentMonth, datePickerCurrentYear);
            document.getElementById('prevMonthBtn').onclick = () => {
                datePickerCurrentMonth--;
                if (datePickerCurrentMonth < 0) {
                    datePickerCurrentMonth = 11;
                    datePickerCurrentYear--;
                }
                renderCalendar(datePickerCurrentMonth, datePickerCurrentYear);
            };
            document.getElementById('nextMonthBtn').onclick = () => {
                datePickerCurrentMonth++;
                if (datePickerCurrentMonth > 11) {
                    datePickerCurrentMonth = 0;
                    datePickerCurrentYear++;
                }
                renderCalendar(datePickerCurrentMonth, datePickerCurrentYear);
            };
        }
        function closeDatePickerModal() {
            datePickerModal.style.display = 'none';
            if (currentEditableDetailElement) {
                currentEditableDetailElement.displaySpan.style.display = 'block';
                if (currentEditableDetailElement.inputElement) {
                    currentEditableDetailElement.inputElement.remove();
                }
                if (currentEditableDetailElement.otherInput) {
                    currentEditableDetailElement.otherInput.remove();
                }
            }
            currentEditableDetailElement = null;
            datePickerCallback = null;
        }
        function renderCalendar(month, year) {
            datePickerGrid.innerHTML = `
                <div class="date-picker-day header">א</div>
                <div class="date-picker-day header">ב</div>
                <div class="date-picker-day header">ג</div>
                <div class="date-picker-day header">ד</div>
                <div class="date-picker-day header">ה</div>
                <div class="date-picker-day header">ו</div>
                <div class="date-picker-day header">ש</div>
            `;
            currentMonthYearDisplay.textContent = new Date(year, month).toLocaleString('he-IL', { month: 'long', year: 'numeric' });
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDayIndex = firstDayOfMonth;
            for (let i = 0; i < startDayIndex; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('date-picker-day', 'empty');
                datePickerGrid.appendChild(dayDiv);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('date-picker-day', 'current-month');
                dayDiv.textContent = day;
                dayDiv.onclick = () => selectDate(day, month, year);
                datePickerGrid.appendChild(dayDiv);
            }
        }
        function selectDate(day, month, year) {
            const selectedDate = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
            if (datePickerCallback) {
                datePickerCallback(selectedDate);
            }
            closeDatePickerModal();
        }
        function openInstructionsModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            instructionsModal.style.display = 'flex';
        }
        function closeInstructionsModal() {
            instructionsModal.style.display = 'none';
            showMainContent();
        }
        function openTimelineModal() {
            closeSidebar();
            document.querySelector('.container').style.display = 'none';
            document.querySelector('.top-section-wrapper').style.display = 'none';
            fixedDashboardSection.style.display = 'none';
            timelineModal.style.display = 'flex';
            renderTimeline();
        }
        function closeTimelineModal() {
            timelineModal.style.display = 'none';
            showMainContent();
        }
        function renderTimeline() {
            timelineContainer.innerHTML = '';
            let allEntries = [];
            const currentProject = projects[currentProjectId];
            for (const metricId in stagesConfig.wineDetails.metrics) {
                const metricConfig = stagesConfig.wineDetails.metrics[metricId];
                const entries = currentProject.wineDetails[metricId];
                if (entries && entries.length > 0) {
                    entries.forEach(entry => {
                        allEntries.push({
                            sectionName: stagesConfig.wineDetails.longName,
                            metricName: metricConfig.name,
                            value: entry.value,
                            timestamp: entry.timestamp,
                            rawTimestamp: new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6')),
                            color: '#8B0000'
                        });
                    });
                }
            }
            if (currentProject.wineDetails.customProperties) {
                currentProject.wineDetails.customProperties.forEach(prop => {
                    if (prop.history && prop.history.length > 0) {
                        prop.history.forEach(entry => {
                            allEntries.push({
                                sectionName: stagesConfig.wineDetails.longName,
                                metricName: prop.name,
                                value: entry.value,
                                timestamp: entry.timestamp,
                                rawTimestamp: new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6')),
                                color: '#A52A2A'
                            });
                        });
                    }
                });
            }
            for (const stageId in currentProject.stages) {
                const stageConfig = stagesConfig[stageId];
                if (!stageConfig || stageId === 'wineDetails') continue;
                const stageColor = stageConfig.emoji === '🟢' ? '#228B22' : stageConfig.emoji === '🍇' ? '#8B4513' : stageConfig.emoji === '🍷' ? '#B22222' : stageConfig.emoji === '🔁' ? '#FF6347' : stageConfig.emoji === '🛢' ? '#696969' : stageConfig.emoji === '🧪' ? '#4169E1' : '#8B0000';
                for (const metricId in stageConfig.metrics) {
                    const metricConfig = stageConfig.metrics[metricId];
                    const entries = currentProject.stages[stageId][metricId];
                    if (entries && entries.length > 0) {
                        entries.forEach(entry => {
                            allEntries.push({
                                sectionName: stageConfig.longName,
                                metricName: metricConfig.name,
                                value: entry.value,
                                timestamp: entry.timestamp,
                                rawTimestamp: new Date(entry.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}):(\d{2}):(\d{2})/, '$3-$2-$1T$4:$5:$6')),
                                color: stageColor
                            });
                        });
                    }
                }
            }
            allEntries.sort((a, b) => a.rawTimestamp - b.rawTimestamp);
            if (allEntries.length === 0) {
                timelineContainer.innerHTML = '<p style="text-align: center; color: var(--light-text-color);">אין נתונים זמינים עבור ציר הזמן בפרויקט זה.</p>';
                return;
            }
            allEntries.forEach((entry, index) => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'timeline-event';
                eventDiv.style.animationDelay = `${index * 0.1}s`;
                eventDiv.innerHTML = `
                    <div class="timeline-event-content" style="border-left: 5px solid ${entry.color};">
                        <h4 style="color: ${entry.color};">${entry.metricName} (${entry.sectionName})</h4>
                        <p>ערך: <span class="event-value">${entry.value}</span></p>
                        <span class="event-timestamp">${entry.timestamp}</span>
                    </div>
                `;
                timelineContainer.appendChild(eventDiv);
            });
        }
        function downloadTimelinePDF() {
            const entries = Array.from(timelineContainer.querySelectorAll('.timeline-event')).map((event, index) => {
                const title = event.querySelector('h4').textContent;
                const value = event.querySelector('.event-value').textContent;
                const timestamp = event.querySelector('.event-timestamp').textContent;
                return `${index + 1}. ${title}\nערך: ${value}\nתאריך: ${timestamp}`;
            });
            const docDefinition = {
                content: [
                    { text: 'ציר זמן - כל המדידות', style: 'header' },
                    { text: entries.join('\n\n'), style: 'text' }
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'right' },
                    text: { fontSize: 12, alignment: 'right' }
                }
            };
            pdfMake.createPdf(docDefinition).download('timeline.pdf');
        }
        
        function downloadGlobalFinancePDF() {
            const docDefinition = {
                content: [
                    { text: 'דוח כספי כולל (כל הפרויקטים)', style: 'header' },
                    { text: `סה"כ הכנסות: ${globalTotalIncomeDisplay.textContent} ₪`, style: 'text' },
                    { text: `סה"כ הוצאות: ${globalTotalExpenseDisplay.textContent} ₪`, style: 'text' },
                    { text: `יתרה כוללת: ${globalTotalBalanceDisplay.textContent} ₪`, style: 'text' },
                    { text: 'פרויקטים:', style: 'subheader' },
                    ...Array.from(globalFinanceProjectsDetails.querySelectorAll('.global-finance-project-section')).map(section => {
                        const title = section.querySelector('h4').textContent;
                        const ps = Array.from(section.querySelectorAll('p')).map(p => p.textContent);
                        return { text: `${title}\n${ps.join('\n')}`, style: 'text' };
                    })
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'right' },
                    subheader: { fontSize: 14, bold: true, alignment: 'right' },
                    text: { fontSize: 12, alignment: 'right' }
                }
            };
            pdfMake.createPdf(docDefinition).download('global_finance_report.pdf');
        }
        function downloadYearlyFinancePDF() {
            const docDefinition = {
                content: [
                    { text: `דוח כספי לפי שנה - ${yearSelect.value} (${monthSelect?.value === 'all' ? 'כל השנה' : 'חודש ' + monthSelect?.value})`, style: 'header' },
                    { text: `סה"כ הכנסות: ${yearlyTotalIncomeDisplay.textContent} ₪`, style: 'text' },
                    { text: `סה"כ הוצאות: ${yearlyTotalExpenseDisplay.textContent} ₪`, style: 'text' },
                    { text: `יתרה נוכחית: ${yearlyTotalBalanceDisplay.textContent} ₪`, style: 'text' },
                    { text: 'פרויקטים:', style: 'subheader' },
                    ...Array.from(yearlyFinanceProjectsDetails.querySelectorAll('.finance-yearly-project-section')).map(section => {
                        const title = section.querySelector('h4').textContent;
                        const ps = Array.from(section.querySelectorAll('p')).map(p => p.textContent);
                        return { text: `${title}\n${ps.join('\n')}`, style: 'text' };
                    })
                ],
                styles: {
                    header: { fontSize: 18, bold: true, alignment: 'right' },
                    subheader: { fontSize: 14, bold: true, alignment: 'right' },
                    text: { fontSize: 12, alignment: 'right' }
                }
            };
            pdfMake.createPdf(docDefinition).download(`yearly_finance_report_${yearSelect.value}_${monthSelect?.value || 'all'}.pdf`);
        }
        window.onclick = function(event) {
            if (event.target === historyModal) {
                closeHistoryModal();
            }
            if (event.target === secondaryHistoryModal) {
                closeSecondaryHistoryModal();
            }
            if (event.target === projectSummaryModal) {
                closeProjectSummaryModal();
            }
            if (event.target === projectManagementModal) {
                closeProjectManagementModal();
            }
            if (event.target === financeModal) {
                closeFinanceModal();
            }
            if (event.target === globalFinanceReportModal) {
                closeGlobalFinanceReportModal();
            }
            if (event.target === financeYearlyModal) {
                closeFinanceYearlyModal();
            }
            if (event.target === inboxModal) {
                closeInboxModal();
            }
            if (event.target === remindersModal) {
                closeRemindersModal();
            }
            if (event.target === instructionsModal) {
                closeInstructionsModal();
            }
            if (event.target === timelineModal) {
                closeTimelineModal();
            }
            if (event.target === datePickerModal && !event.target.closest('.date-picker-modal-content')) {
                closeDatePickerModal();
            }
            if (event.target === projectSelectionModal) {
                closeProjectSelectionModal();
            }
            if (event.target === newProjectModal) {
                closeNewProjectModal();
            }
            if (event.target === customPropertyModal) {
                closeCustomPropertyModal();
            }
            if (event.target === financeEditModal) {
                closeFinanceEditModal();
            }
            const confirmationModal = document.getElementById('confirmationModal');
            if (event.target === confirmationModal) {
                // Close confirmation modal by clicking "No"
                const noBtn = document.getElementById('confirmNoBtn');
                if (noBtn) noBtn.click();
            }
            if (event.target === sidebarOverlay) {
                closeSidebar();
            }
        }
        function openAddMetricModal() {
            const modal = document.getElementById('addMetricModal');
            const title = modal?.querySelector('h3');
            if (title) {
                title.innerHTML = activeCategory === 'metrics'
                    ? '<i class="fas fa-chart-line"></i> הוסף מדד חדש לשלב הנוכחי'
                    : '<i class="fas fa-plus"></i> הוסף מדד חדש לדשבורד';
            }
            if (modal) modal.style.display = 'flex';
            const addMetricInput = document.getElementById('addMetricName');
            if (addMetricInput) {
                addMetricInput.value = '';
                addMetricInput.placeholder = activeCategory === 'extras'
                    ? 'למשל: שפייה'
                    : (activeCategory === 'additions' ? 'למשל: ביסולפיט' : 'למשל: בריקס נוסף');
                setTimeout(() => addMetricInput.focus(), 50);
            }
        }
        function closeAddMetricModal() {
            document.getElementById('addMetricModal').style.display = 'none';
        }
        function addNewMetric() {
            if (!ensureEditPermission()) {
                return;
            }
            ensureSecondaryCollections(projects[currentProjectId]);
            const name = document.getElementById('addMetricName').value.trim();
            if (!name) {
                alert('אנא הזן שם למדד.');
                return;
            }

            if (activeCategory === 'additions') {
                if (!projects[currentProjectId].additions[name]) {
                    projects[currentProjectId].additions[name] = [];
                }
                saveAllProjects();
                closeAddMetricModal();
                renderAdditionsPanel();
                renderActiveCategoryDashboard();
                return;
            }

            if (activeCategory === 'extras') {
                if (!projects[currentProjectId].extraTypes) {
                    projects[currentProjectId].extraTypes = [];
                }
                if (!projects[currentProjectId].extraTypes.includes(name)) {
                    projects[currentProjectId].extraTypes.push(name);
                }
                saveAllProjects();
                closeAddMetricModal();
                renderExtrasPanel();
                renderActiveCategoryDashboard();
                return;
            }

            const metricId = `customMetric_${Date.now()}`;
            if (!stagesConfig[currentStageId].customMetrics) {
                stagesConfig[currentStageId].customMetrics = {};
            }
            stagesConfig[currentStageId].customMetrics[metricId] = {
                name: name,
                type: 'text',
                placeholder: 'הכנס ערך'
            };
            if (!projects[currentProjectId].stages[currentStageId]) {
                projects[currentProjectId].stages[currentStageId] = {};
            }
            projects[currentProjectId].stages[currentStageId][metricId] = [];
            saveAllProjects();
            document.getElementById('addMetricName').value = '';
            closeAddMetricModal();
            loadCurrentStageContent();
        }
        function deleteCustomMetric(stageId, metricId, skipConfirm = false) {
            if (!ensureEditPermission()) {
                return;
            }
            if (!stageId || !metricId) return;
            if (!stagesConfig[stageId] || !stagesConfig[stageId].customMetrics || !stagesConfig[stageId].customMetrics[metricId]) return;
            if (!skipConfirm && !confirm('למחוק את המדד המותאם? פעולה זו תמחק גם את הנתונים שלו.')) return;
            delete stagesConfig[stageId].customMetrics[metricId];
            Object.keys(projects).forEach(pid => {
                if (projects[pid]?.stages?.[stageId]) {
                    delete projects[pid].stages[stageId][metricId];
                }
            });
            saveAllProjects();
            if (stageId === currentStageId) {
                loadCurrentStageContent();
            } else {
                updateDashboardForCurrentStage();
            }
        }
        function getCurrentAppState() {
            return {
                projects: projects,
                currentProjectId: currentProjectId,
                currentStageId: currentStageId,
                stagesConfig: stagesConfig, // Save custom metrics in stagesConfig
                darkMode: document.body.classList.contains('dark-mode'),
                savedAt: new Date().toISOString()
            };
        }
        
        // IndexedDB helper functions for reminders to avoid localStorage QuotaExceededError
        const REMINDERS_DB_NAME = "reminders-db";
        const REMINDERS_STORE_NAME = "reminders";
        
        function openRemindersDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(REMINDERS_DB_NAME, 1);
                req.onupgradeneeded = () => {
                    const db = req.result;
                    if (!db.objectStoreNames.contains(REMINDERS_STORE_NAME)) {
                        db.createObjectStore(REMINDERS_STORE_NAME, { keyPath: "id" });
                    }
                };
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        
        async function saveReminderToIndexedDB(reminder) {
            try {
                const db = await openRemindersDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(REMINDERS_STORE_NAME, "readwrite");
                    tx.objectStore(REMINDERS_STORE_NAME).put(reminder);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            } catch (error) {
                console.error('IndexedDB save error:', error);
                throw error;
            }
        }
        
        async function getAllRemindersFromIndexedDB() {
            try {
                const db = await openRemindersDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(REMINDERS_STORE_NAME, "readonly");
                    const req = tx.objectStore(REMINDERS_STORE_NAME).getAll();
                    req.onsuccess = () => resolve(req.result || []);
                    req.onerror = () => reject(req.error);
                });
            } catch (error) {
                console.error('IndexedDB read error:', error);
                return [];
            }
        }
        
        async function deleteReminderFromIndexedDB(id) {
            try {
                const db = await openRemindersDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(REMINDERS_STORE_NAME, "readwrite");
                    tx.objectStore(REMINDERS_STORE_NAME).delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            } catch (error) {
                console.error('IndexedDB delete error:', error);
                throw error;
            }
        }
        
        // Helper function to handle localStorage quota exceeded errors
        // Helper function to handle localStorage errors
        function handleLocalStorageError(err) {
            console.error('Error saving to localStorage:', err);
            if (err.name === 'QuotaExceededError') {
                alert('שגיאה: אחסון המכשיר מלא. אנא פנה מקום על ידי מחיקת קבצים או נתונים מהדפדפן ונסה שוב.');
            } else if (err.name === 'SecurityError') {
                // Private/incognito mode or security restrictions
                alert('שגיאה: לא ניתן לשמור נתונים במצב גלישה פרטית. אנא פתח את האתר במצב רגיל או התחבר כדי לשמור בענן.');
            } else {
                // Generic fallback for other errors
                console.error('Unexpected localStorage error:', err.name, err.message);
                // Note: Don't show alert for unexpected errors to avoid annoying users
            }
        }
        
        // Firebase-only mode: do not load data from localStorage.
        function loadAndRenderFromLocalStorage() {
            return;
        }
        
        function applyStateToUI(state) {
            if (!state) return;
            if (state.projects) {
                projects = state.projects;
            }
            if (state.stagesConfig) {
                // Merge stagesConfig to preserve custom metrics
                Object.keys(state.stagesConfig).forEach(stageId => {
                    if (state.stagesConfig[stageId].customMetrics) {
                        if (!stagesConfig[stageId]) {
                            stagesConfig[stageId] = state.stagesConfig[stageId];
                        } else {
                            stagesConfig[stageId].customMetrics = state.stagesConfig[stageId].customMetrics;
                        }
                    }
                });
            }
            if (state.currentProjectId && projects[state.currentProjectId]) {
                currentProjectId = state.currentProjectId;
                localStorage.setItem('currentProjectId', currentProjectId);
            }
            if (state.currentStageId && stagesConfig[state.currentStageId]) {
                currentStageId = state.currentStageId;
                localStorage.setItem('currentStageId', currentStageId);
            }
            if (state.darkMode) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'false');
            }
            if (typeof renderAllMainContent === 'function') {
                renderAllMainContent();
            } else if (typeof updateProjectDisplay === 'function') {
                updateProjectDisplay();
            }
        }
        
        function showConfirmation(message, title = 'אישור') {
            return new Promise((resolve) => {
                try {
                    const modal = document.getElementById('confirmationModal');
                    const titleEl = document.getElementById('confirmationTitle');
                    const messageEl = document.getElementById('confirmationMessage');
                    const yesBtn = document.getElementById('confirmYesBtn');
                    const noBtn = document.getElementById('confirmNoBtn');
                    
                    if (!modal || !titleEl || !messageEl || !yesBtn || !noBtn) {
                        // Log specific missing elements for debugging
                        const missing = [];
                        if (!modal) missing.push('confirmationModal');
                        if (!titleEl) missing.push('confirmationTitle');
                        if (!messageEl) missing.push('confirmationMessage');
                        if (!yesBtn) missing.push('confirmYesBtn');
                        if (!noBtn) missing.push('confirmNoBtn');
                        console.error('Confirmation modal components not found:', missing.join(', '));
                        // Resolve to false (safer than true for confirmations)
                        resolve(false);
                        return;
                    }
                    
                    titleEl.textContent = title;
                    messageEl.textContent = message;
                    modal.style.display = 'flex';
                    
                    // Focus management - delay allows modal to render before focusing
                    // This prevents focus issues on slower devices
                    const FOCUS_DELAY_MS = 100;
                    setTimeout(() => noBtn.focus(), FOCUS_DELAY_MS);
                
                const cleanup = () => {
                    yesBtn.removeEventListener('click', handleYes);
                    noBtn.removeEventListener('click', handleNo);
                    modal.removeEventListener('keydown', handleKeyDown);
                };
                
                const handleYes = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(true);
                };
                
                const handleNo = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve(false);
                };
                
                // Keyboard navigation: Escape to cancel, Tab trapping
                const handleKeyDown = (e) => {
                    if (e.key === 'Escape') {
                        handleNo();
                    } else if (e.key === 'Tab') {
                        // Tab trapping between the two buttons
                        const focusableElements = [yesBtn, noBtn];
                        const currentIndex = focusableElements.indexOf(document.activeElement);
                        
                        if (e.shiftKey) {
                            // Shift+Tab - go backwards
                            e.preventDefault();
                            const newIndex = currentIndex <= 0 ? focusableElements.length - 1 : currentIndex - 1;
                            focusableElements[newIndex].focus();
                        } else {
                            // Tab - go forwards
                            e.preventDefault();
                            const newIndex = currentIndex >= focusableElements.length - 1 ? 0 : currentIndex + 1;
                            focusableElements[newIndex].focus();
                        }
                    }
                };
                
                yesBtn.addEventListener('click', handleYes);
                noBtn.addEventListener('click', handleNo);
                modal.addEventListener('keydown', handleKeyDown);
                } catch (error) {
                    // Handle any unexpected errors during modal setup
                    console.error('Error showing confirmation modal:', error);
                    resolve(false);
                }
            });
        }
        
        /**
         * Generic confirmation dialog wrapper - alias for showConfirmation
         * @param {string} title - The dialog title
         * @param {string} message - The confirmation message
         * @param {Function} onConfirm - Callback function to execute on confirmation
         */
        async function openConfirmation(title, message, onConfirm) {
            const confirmed = await showConfirmation(message, title);
            if (confirmed && typeof onConfirm === 'function') {
                onConfirm();
            }
        }
        
        function isMobileViewport() {
            const hasCoarsePointer = window.matchMedia ? window.matchMedia('(pointer: coarse)').matches : false;
            const minDimension = Math.min(window.innerWidth, window.innerHeight);
            return (hasCoarsePointer || window.innerWidth <= 900) && minDimension <= 900;
        }
        
        // Initialize project details card position to prevent flickering on page load
        function initializeProjectDetailsCard() {
            if (!projectDetailsCard) return;
            
            // Temporarily disable transition
            projectDetailsCard.style.transition = 'none';
            
            if (isMobileViewport()) {
                // Mobile: hide card off-screen and keep invisible
                projectDetailsCard.style.left = '-280px';
                projectDetailsCard.style.pointerEvents = 'none';
                projectDetailsCard.style.visibility = 'hidden';
                cardOpen = false;
                setCardFabVisibility();
                updateCardFabState();
            } else {
                // Desktop: show card on screen
                projectDetailsCard.style.left = '15px';
                projectDetailsCard.style.pointerEvents = 'auto';
                projectDetailsCard.style.visibility = 'visible';
            }
            
            // Use requestAnimationFrame to restore transition
            requestAnimationFrame(() => {
                projectDetailsCard.style.transition = 'left 0.3s ease';
            });
        }
        
        function handleCardFabResize() {
            setCardFabVisibility();
            if (isMobileViewport()) {
                if (!cardOpen) {
                    projectDetailsCard.style.left = '-280px';
                    projectDetailsCard.style.pointerEvents = 'none';
                    projectDetailsCard.style.visibility = 'hidden';
                } else {
                    projectDetailsCard.style.visibility = 'visible';
                }
                updateCardFabState();
            } else {
                projectDetailsCard.style.pointerEvents = 'auto';
                projectDetailsCard.style.visibility = 'visible';
            }
        }
        function setCardFabVisibility() {
            if (!cardFab) return;
            // Show FAB on mobile, regardless of cardOpen state (icon changes, but button stays visible)
            const shouldShow = isMobileViewport();
            cardFab.style.display = shouldShow ? 'flex' : 'none';
        }
        
        // Helper function to hide card after slide-out animation
        function hideCardAfterDelay() {
            // Cancel any pending hide timeout to prevent race conditions
            // clearTimeout prevents the callback from running, so setting to null is safe
            if (cardHideTimeout) {
                clearTimeout(cardHideTimeout);
                cardHideTimeout = null;
            }
            
            // Schedule visibility hide after transition completes
            cardHideTimeout = setTimeout(() => {
                // Only hide if card is still closed and timeout wasn't canceled
                // If cardHideTimeout is null, it was canceled (clearTimeout was called)
                if (!cardOpen && cardHideTimeout) {
                    projectDetailsCard.style.visibility = 'hidden';
                    cardHideTimeout = null;
                }
            }, CARD_TRANSITION_DURATION);
        }
        
        // פונקציות הזזה לכרטיסיה במובייל
        function handleTouchStart(e) {
            if (!isMobileViewport()) return; // רק במובייל
            isDragging = true;
            startX = e.touches[0].clientX;
            currentX = startX;
            projectDetailsCard.style.transition = 'none'; // ביטול אנימציה במהלך הזזה
        }
        function handleTouchMove(e) {
            if (!isDragging || !isMobileViewport()) return;
            e.preventDefault();
            currentX = e.touches[0].clientX;
            const deltaX = currentX - startX;
            const newLeft = Math.min(15, Math.max(-280, 15 + deltaX)); // מגביל בין 15px ל- -280px
            projectDetailsCard.style.left = newLeft + 'px';
        }
        function handleTouchEnd(e) {
            if (!isDragging || !isMobileViewport()) return;
            isDragging = false;
            projectDetailsCard.style.transition = 'left 0.3s ease'; // הוספת אנימציה חזרה
            const deltaX = currentX - startX;
            if (deltaX > 50) {
                // פתח לגמרי אם הזיז ימינה מספיק
                if (cardHideTimeout) {
                    clearTimeout(cardHideTimeout);
                    cardHideTimeout = null;
                }
                projectDetailsCard.style.visibility = 'visible';
                projectDetailsCard.style.left = '15px';
                projectDetailsCard.style.pointerEvents = 'auto';
                cardOpen = true;
            } else if (deltaX < -50) {
                // סגור אם הזיז שמאלה מספיק
                projectDetailsCard.style.left = '-280px';
                projectDetailsCard.style.pointerEvents = 'none';
                cardOpen = false;
                hideCardAfterDelay();
            } else {
                // חזור למצב הקודם
                projectDetailsCard.style.left = cardOpen ? '15px' : '-280px';
                if (!cardOpen) {
                    hideCardAfterDelay();
                }
            }
            
            // Update icon based on final state
            const icon = document.getElementById('pullHandleIcon');
            if (icon) {
                icon.className = cardOpen ? 'fas fa-angle-double-left' : 'fas fa-angle-double-right';
            }
            updateCardFabState();
            setCardFabVisibility();
        }
        function updateCardFabState() {
            if (!cardFab) return;
            // Always update the entire button content to avoid stale references
            if (cardOpen) {
                cardFab.innerHTML = '<span class="card-fab-icon" aria-hidden="true">×</span><span class="sr-only">סגור כרטיס פרויקט</span>';
            } else {
                cardFab.innerHTML = '<img class="card-fab-icon" src="image_00b206.png" alt="" aria-hidden="true"><span class="sr-only">פתח כרטיס פרויקט</span>';
            }
            cardFab.setAttribute('aria-label', cardOpen ? 'סגור כרטיס פרויקט' : 'פתח כרטיס פרויקט');
        }
        function toggleCardFromFab() {
            toggleCard();
        }
        function toggleCard() {
            if (!isMobileViewport()) return; // רק במובייל
            cardOpen = !cardOpen;
            projectDetailsCard.style.transition = 'left 0.3s ease';
            
            if (cardOpen) {
                // Opening: Cancel any pending hide, make visible first, then slide in
                if (cardHideTimeout) {
                    clearTimeout(cardHideTimeout);
                    cardHideTimeout = null;
                }
                projectDetailsCard.style.visibility = 'visible';
                projectDetailsCard.style.left = '15px';
                projectDetailsCard.style.pointerEvents = 'auto';
            } else {
                // Closing: Slide out first, then hide after transition
                projectDetailsCard.style.left = '-280px';
                projectDetailsCard.style.pointerEvents = 'none';
                hideCardAfterDelay();
            }
            
            // Update icon direction
            const icon = document.getElementById('pullHandleIcon');
            if (icon) {
                icon.className = cardOpen ? 'fas fa-angle-double-left' : 'fas fa-angle-double-right';
            }
            updateCardFabState();
            setCardFabVisibility();
        }
        function closeCard() {
            if (!isMobileViewport()) return;
            cardOpen = false;
            projectDetailsCard.style.transition = 'left 0.3s ease';
            projectDetailsCard.style.left = '-280px';
            projectDetailsCard.style.pointerEvents = 'none';
            
            // Hide card after slide-out animation completes
            hideCardAfterDelay();
            
            // Update icon direction
            const icon = document.getElementById('pullHandleIcon');
            if (icon) {
                icon.className = 'fas fa-angle-double-right';
            }
            updateCardFabState();
            setCardFabVisibility();
        }
    </script>

    <!-- Firebase Integration (inline storage/auth logic + external firebase-config.js) -->
    <script type="module">
        import {
            auth,
            db,
            googleProvider,
            signInWithPopup,
            signInWithRedirect,
            getRedirectResult,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            doc,
            collection,
            getDocs,
            query,
            where,
            setDoc,
            deleteDoc,
            getDoc,
            onSnapshot,
            serverTimestamp,
            limit,
            collectionGroup,
            storage,
            storageRef,
            uploadBytes,
            getBlob,
            getDownloadURL,
            deleteObject
        } from './firebase-config.js';

        let currentUser = null;
        let activeDataAccountUid = null;
        let isInitialized = false;
        let realtimeListenersInitialized = false;
        const realtimeUnsubscribers = [];

        function getActiveDataAccountUid() {
            if (!currentUser) return null;
            return activeDataAccountUid || currentUser.uid;
        }

        function setActiveDataAccountUid(uid) {
            activeDataAccountUid = uid || (currentUser ? currentUser.uid : null);
        }

        const STORAGE_KEYS = {
            PROJECTS: 'projects',
            REMINDERS: 'reminders',
            INBOX: 'inbox',
            PREFERENCES: 'preferences',
            STAGES_CONFIG: 'stagesConfig'
        };



        function normalizeEmail(email) {
            return (email || '').trim().toLowerCase();
        }

        function emailLookupKey(email) {
            return `email_${encodeURIComponent(normalizeEmail(email))}`;
        }

        function legacyEmailLookupKey(email) {
            return normalizeEmail(email).replace(/[^a-z0-9]/g, '_');
        }

        async function ensureUserAccountIndex(user) {
            if (!user || !user.email) return;
            const normalizedEmail = normalizeEmail(user.email);
            await setDoc(doc(db, 'accounts', user.uid), {
                email: normalizedEmail,
                updatedAt: serverTimestamp(),
                createdAt: serverTimestamp()
            }, { merge: true });
            const lookupPayload = {
                uid: user.uid,
                email: normalizedEmail,
                updatedAt: serverTimestamp()
            };
            await Promise.all([
                setDoc(doc(db, 'usersByEmail', emailLookupKey(normalizedEmail)), lookupPayload, { merge: true }),
                setDoc(doc(db, 'usersByEmail', legacyEmailLookupKey(normalizedEmail)), lookupPayload, { merge: true })
            ]);
        }

        async function getUidByEmail(email) {
            const normalizedEmail = normalizeEmail(email);
            if (!normalizedEmail) return null;

            const keysToTry = [emailLookupKey(normalizedEmail), legacyEmailLookupKey(normalizedEmail)];
            for (const key of keysToTry) {
                const lookupDoc = await getDoc(doc(db, 'usersByEmail', key));
                if (lookupDoc.exists()) {
                    const payload = lookupDoc.data() || {};
                    if (payload.uid) return payload.uid;
                }
            }

            const accountQuery = query(collection(db, 'accounts'), where('email', '==', normalizedEmail), limit(1));
            const accountMatch = await getDocs(accountQuery);
            if (!accountMatch.empty) {
                return accountMatch.docs[0].id || null;
            }

            return null;
        }

        async function grantAccessPermission({ targetEmail, projectScope, permissionLevel, allowFinance }) {
            if (!currentUser || !currentUser.email) throw new Error('AUTH_REQUIRED');
            const normalizedTarget = normalizeEmail(targetEmail);
            if (!normalizedTarget) throw new Error('EMAIL_REQUIRED');

            const collaboratorUid = await getUidByEmail(normalizedTarget);
            if (!collaboratorUid) throw new Error('TARGET_NOT_FOUND');
            if (collaboratorUid === currentUser.uid) throw new Error('SELF_NOT_ALLOWED');

            const payload = {
                ownerUid: currentUser.uid,
                ownerEmail: normalizeEmail(currentUser.email),
                collaboratorUid,
                collaboratorEmail: normalizedTarget,
                projectScope: projectScope || 'all',
                permissionLevel: permissionLevel === 'edit' ? 'edit' : 'view',
                allowEdit: permissionLevel === 'edit',
                allowFinance: !!allowFinance,
                updatedAt: serverTimestamp(),
                createdAt: serverTimestamp()
            };

            await setDoc(doc(db, 'accounts', currentUser.uid, 'permissions', collaboratorUid), payload, { merge: true });

            let sharedListSyncWarning = false;
            try {
                await setDoc(doc(db, 'accounts', collaboratorUid, 'sharedWith', currentUser.uid), payload, { merge: true });
            } catch (error) {
                console.warn('Failed to sync sharedWith list for collaborator:', error);
                sharedListSyncWarning = true;
            }
            return { ...payload, sharedListSyncWarning };
        }

        async function revokeAccessPermission({ collaboratorUid }) {
            if (!currentUser || !currentUser.email) throw new Error('AUTH_REQUIRED');
            if (!collaboratorUid) throw new Error('COLLABORATOR_REQUIRED');

            await deleteDoc(doc(db, 'accounts', currentUser.uid, 'permissions', collaboratorUid));
            try {
                await deleteDoc(doc(db, 'accounts', collaboratorUid, 'sharedWith', currentUser.uid));
            } catch (error) {
                console.warn('Failed to remove sharedWith entry for collaborator:', error);
            }
        }

        async function listOwnerPermissions() {
            if (!currentUser) return [];
            const snap = await getDocs(collection(db, 'accounts', currentUser.uid, 'permissions'));
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        async function listSharedWithMe() {
            if (!currentUser) return [];
            const sharedWithSnap = await getDocs(collection(db, 'accounts', currentUser.uid, 'sharedWith'));
            const sharedWithItems = sharedWithSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            if (sharedWithItems.length) return sharedWithItems;

            // Fallback: if sharedWith wasn't synced (e.g. Firestore rules blocked it), derive from owners' permission docs.
            try {
                const fallbackQuery = query(collectionGroup(db, 'permissions'), where('collaboratorUid', '==', currentUser.uid));
                const fallbackSnap = await getDocs(fallbackQuery);
                return fallbackSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            } catch (error) {
                console.warn('Cannot derive shared accounts from permissions collection group.', error);
                return [];
            }
        }

        async function findOwnerByEmail(ownerEmail) {
            const ownerUid = await getUidByEmail(ownerEmail);
            if (!ownerUid) return null;

            try {
                const permDoc = await getDoc(doc(db, 'accounts', ownerUid, 'permissions', currentUser.uid));
                if (permDoc.exists()) {
                    return { ownerUid, permission: permDoc.data() };
                }
            } catch (error) {
                console.warn('Cannot read owner permissions directly, trying sharedWith fallback.', error);
            }

            const sharedDoc = await getDoc(doc(db, 'accounts', currentUser.uid, 'sharedWith', ownerUid));
            if (!sharedDoc.exists()) return null;
            return { ownerUid, permission: sharedDoc.data() };
        }

        async function loadOwnerProjects(ownerUid) {
            const snap = await getDoc(doc(db, 'accounts', ownerUid, 'data', 'projects'));
            if (!snap.exists()) return null;
            return snap.data() || null;
        }

        async function uploadFileToStorage(path, file, metadata = {}) {
            if (!currentUser) throw new Error('AUTH_REQUIRED');
            const safePath = path.replace(/[^a-zA-Z0-9_\-./]/g, '_');
            const fileRef = storageRef(storage, safePath);
            await uploadBytes(fileRef, file, {
                contentType: file.type || 'application/octet-stream',
                customMetadata: metadata
            });
            const downloadUrl = await getDownloadURL(fileRef);
            return { downloadUrl, storagePath: safePath };
        }

        async function deleteFileFromStorage(path) {
            if (!path) return;
            try {
                await deleteObject(storageRef(storage, path));
            } catch (error) {
                console.warn('Failed to delete file from storage:', error);
            }
        }

        function buildFinanceAttachmentPath(projectId, entryId, fileName) {
            const dataUid = getActiveDataAccountUid();
            const safeName = (fileName || 'attachment').replace(/\s+/g, '_').replace(/[^\w.\-]/g, '');
            return `accounts/${dataUid}/projects/${projectId}/finance/${entryId}/${Date.now()}_${safeName}`;
        }

        function buildMetricAttachmentPath(projectId, stageId, metricId, entryId, fileName) {
            const dataUid = getActiveDataAccountUid();
            const safeName = (fileName || 'metric-image').replace(/\s+/g, '_').replace(/[^\w.\-]/g, '');
            const safeStageId = String(stageId || 'stage').replace(/[^\w.\-]/g, '_');
            const safeMetricId = String(metricId || 'metric').replace(/[^\w.\-]/g, '_');
            const safeEntryId = String(entryId || Date.now()).replace(/[^\w.\-]/g, '_');
            return `accounts/${dataUid}/projects/${projectId}/metrics/${safeStageId}/${safeMetricId}/${safeEntryId}/${Date.now()}_${safeName}`;
        }

        window.firebaseAccess = {
            getCurrentUser: () => currentUser,
            normalizeEmail,
            ensureUserAccountIndex,
            grantAccessPermission,
            listOwnerPermissions,
            listSharedWithMe,
            revokeAccessPermission,
            findOwnerByEmail,
            loadOwnerProjects,
            uploadFileToStorage,
            deleteFileFromStorage,
            getStorageBlobByPath: async (path) => {
                if (!path) throw new Error('STORAGE_PATH_REQUIRED');
                return getBlob(storageRef(storage, path));
            },
            getStorageDownloadUrlByPath: async (path) => {
                if (!path) throw new Error('STORAGE_PATH_REQUIRED');
                return getDownloadURL(storageRef(storage, path));
            },
            buildFinanceAttachmentPath,
            buildMetricAttachmentPath,
            reloadOwnAccountData: () => loadAllDataFromFirebase(),
            loadAccountDataByUid: async (uid) => {
                setActiveDataAccountUid(uid || null);
                detachRealtimeListeners();
                await loadAllDataFromFirebase();
                initializeRealtimeDataListeners();
            }
        };

        window.setActiveDataAccountUid = setActiveDataAccountUid;
        function clearLegacyLocalData() {
            Object.values(STORAGE_KEYS).forEach((key) => {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.warn(`Failed to clear localStorage key ${key}:`, error);
                }
            });
        }

        function setCurrentUser(user) {
            currentUser = user;
        }

        let syncUpdateBannerCooldownUntil = 0;
        function showSyncUpdateBanner(message) {
            if (!message) return;
            const now = Date.now();
            if (now < syncUpdateBannerCooldownUntil) return;
            syncUpdateBannerCooldownUntil = now + 2600;
            const banner = document.createElement('div');
            banner.className = 'app-notification success';
            banner.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            document.body.appendChild(banner);
            setTimeout(() => {
                banner.classList.add('fade-out');
                setTimeout(() => banner.remove(), 300);
            }, 2000);
        }

        function refreshProjectsAndMetricsUI() {
            const selectedYear = document.getElementById('projectYearFilter')?.value || 'all';

            if (typeof window.renderProjectList === 'function') window.renderProjectList(selectedYear);
            if (typeof window.populatePermissionProjectOptions === 'function') window.populatePermissionProjectOptions();
            if (typeof window.renderStageNavigation === 'function') window.renderStageNavigation();
            if (typeof window.loadCurrentStageContent === 'function') window.loadCurrentStageContent();
            if (typeof window.updateProjectDetailsCard === 'function') window.updateProjectDetailsCard();
            if (typeof window.renderPreviousStageOverview === 'function') window.renderPreviousStageOverview();
            if (typeof window.renderComparisonProjectList === 'function') window.renderComparisonProjectList();
        }

        function detachRealtimeListeners() {
            while (realtimeUnsubscribers.length) {
                const unsubscribe = realtimeUnsubscribers.pop();
                try {
                    unsubscribe();
                } catch (error) {
                    console.warn('Failed to detach realtime listener:', error);
                }
            }
            realtimeListenersInitialized = false;
        }

        function applyRemoteProjectsData(data, isInitialSnapshot) {
            const remoteProjects = data.projects || {};
            if (typeof window.setProjectsData === 'function') {
                window.setProjectsData(remoteProjects);
            } else if (typeof window.projects !== 'undefined') {
                window.projects = remoteProjects;
            }

            if (data.stagesConfig) {
                if (typeof window.setStagesConfigData === 'function') {
                    window.setStagesConfigData(data.stagesConfig);
                } else {
                    window.stagesConfig = data.stagesConfig;
                }
            }

            refreshProjectsAndMetricsUI();

            if (!isInitialSnapshot) {
                showSyncUpdateBanner('הנתונים עודכנו.');
            }
        }

        function initializeRealtimeDataListeners() {
            if (!currentUser || realtimeListenersInitialized) return;
            const dataUid = getActiveDataAccountUid();
            if (!dataUid) return;

            const listeners = [
                {
                    key: 'projects',
                    docRef: doc(db, 'accounts', dataUid, 'data', 'projects'),
                    applyData: (data, isInitialSnapshot) => applyRemoteProjectsData(data, isInitialSnapshot)
                },
                {
                    key: 'reminders',
                    docRef: doc(db, 'accounts', dataUid, 'data', 'reminders'),
                    applyData: (data, isInitialSnapshot) => {
                        const remoteReminders = data.reminders || [];
                        if (typeof window.setRemindersData === 'function') {
                            window.setRemindersData(remoteReminders);
                        } else if (typeof window.reminders !== 'undefined') {
                            window.reminders = remoteReminders;
                        }
                        if (typeof window.renderRemindersList === 'function') window.renderRemindersList();
                        if (!isInitialSnapshot) showSyncUpdateBanner('הנתונים עודכנו.');
                    }
                },
                {
                    key: 'inbox',
                    docRef: doc(db, 'accounts', dataUid, 'data', 'inbox'),
                    applyData: (data, isInitialSnapshot) => {
                        const remoteInbox = data.inbox || [];
                        if (typeof window.setInboxData === 'function') {
                            window.setInboxData(remoteInbox);
                        } else if (typeof window.inbox !== 'undefined') {
                            window.inbox = remoteInbox;
                        }
                        if (typeof window.renderInbox === 'function') window.renderInbox();
                        if (!isInitialSnapshot) showSyncUpdateBanner('הנתונים עודכנו.');
                    }
                }
            ];

            listeners.forEach(({ key, docRef, applyData }) => {
                let isInitialSnapshot = true;
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (!docSnap.exists() || docSnap.metadata.hasPendingWrites) return;
                    const data = docSnap.data() || {};
                    applyData(data, isInitialSnapshot);
                    isInitialSnapshot = false;
                }, (error) => {
                    console.error(`Realtime listener error (${key}):`, error);
                });
                realtimeUnsubscribers.push(unsubscribe);
            });

            realtimeListenersInitialized = true;
            console.log('Realtime listeners initialized');
        }
        function isWebViewEnvironment() {
            const ua = navigator.userAgent || '';
            return /; wv\)|\bwv\b|WebView|FBAN|FBAV|Instagram|Line\//i.test(ua);
        }

        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent || '');
        }

        function shouldPreferRedirectFlow() {
            return isWebViewEnvironment() || isIOS();
        }

        function getGoogleSignInHint(errorCode) {
            if (errorCode === 'auth/unauthorized-domain') {
                return 'הדומיין לא מורשה ב-Firebase. יש להוסיף את הדומיין/סכמת האפליקציה ב-Authentication > Settings > Authorized domains.';
            }
            if (errorCode === 'auth/operation-not-supported-in-this-environment') {
                return 'הסביבה הנוכחית לא תומכת בחלון קופץ. נסו התחברות בהפניה או פתיחה בדפדפן חיצוני.';
            }
            return 'אם זה בתוך WebView, ודא שהאפליקציה מאפשרת ניווט חיצוני/Custom Tabs, Cookies צד-שלישי ו-JavaScript.';
        }

        async function signInWithGoogle() {
            await setPersistence(auth, browserLocalPersistence);
            if (shouldPreferRedirectFlow()) {
                await signInWithRedirect(auth, googleProvider);
                return null;
            }

            try {
                const result = await signInWithPopup(auth, googleProvider);
                return result.user;
            } catch (error) {
                const fallbackErrors = [
                    'auth/popup-blocked',
                    'auth/popup-closed-by-user',
                    'auth/cancelled-popup-request',
                    'auth/operation-not-supported-in-this-environment',
                    'auth/internal-error'
                ];

                if (fallbackErrors.includes(error.code)) {
                    await signInWithRedirect(auth, googleProvider);
                    return null;
                }

                throw error;
            }
        }

        async function registerWithEmail(email, password) {
            await setPersistence(auth, browserLocalPersistence);
            const result = await createUserWithEmailAndPassword(auth, email, password);
            const userDocRef = doc(db, 'accounts', result.user.uid);
            await setDoc(userDocRef, {
                email: result.user.email,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            });
            return result.user;
        }

        async function signInWithEmail(email, password) {
            await setPersistence(auth, browserLocalPersistence);
            const result = await signInWithEmailAndPassword(auth, email, password);
            return result.user;
        }

        async function signOutUser() {
            await signOut(auth);
            currentUser = null;
        }

        async function saveProjects(projects) {
            if (!currentUser) return;
            try {
                const dataUid = getActiveDataAccountUid();
                if (!dataUid) return;
                const userDocRef = doc(db, 'accounts', dataUid, 'data', 'projects');
                await setDoc(userDocRef, { projects, updatedAt: serverTimestamp() }, { merge: true });
            } catch (error) {
                console.error('Error saving projects to Firestore:', error);
            }
        }

        async function loadProjectsFromFirebase() {
            if (currentUser) {
                try {
                    const dataUid = getActiveDataAccountUid();
                    if (!dataUid) return {};
                    const userDocRef = doc(db, 'accounts', dataUid, 'data', 'projects');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data.projects || {};
                    }
                    return {};
                } catch (error) {
                    console.error('Error loading projects from Firestore:', error);
                    return {};
                }
            }
            return {};
        }

        async function saveReminders(reminders) {
            if (!currentUser) return;
            try {
                const dataUid = getActiveDataAccountUid();
                if (!dataUid) return;
                const userDocRef = doc(db, 'accounts', dataUid, 'data', 'reminders');
                await setDoc(userDocRef, { reminders, updatedAt: serverTimestamp() }, { merge: true });
            } catch (error) {
                console.error('Error saving reminders to Firestore:', error);
            }
        }

        async function loadReminders() {
            if (currentUser) {
                try {
                    const dataUid = getActiveDataAccountUid();
                    if (!dataUid) return [];
                    const userDocRef = doc(db, 'accounts', dataUid, 'data', 'reminders');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data.reminders || [];
                    }
                    return [];
                } catch (error) {
                    console.error('Error loading reminders from Firestore:', error);
                    return [];
                }
            }
            return [];
        }

        async function saveInbox(inbox) {
            if (!currentUser) return;
            try {
                const dataUid = getActiveDataAccountUid();
                if (!dataUid) return;
                const userDocRef = doc(db, 'accounts', dataUid, 'data', 'inbox');
                await setDoc(userDocRef, { inbox, updatedAt: serverTimestamp() }, { merge: true });
            } catch (error) {
                console.error('Error saving inbox to Firestore:', error);
            }
        }

        async function loadInbox() {
            if (currentUser) {
                try {
                    const dataUid = getActiveDataAccountUid();
                    if (!dataUid) return [];
                    const userDocRef = doc(db, 'accounts', dataUid, 'data', 'inbox');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data.inbox || [];
                    }
                    return [];
                } catch (error) {
                    console.error('Error loading inbox from Firestore:', error);
                    return [];
                }
            }
            return [];
        }

        async function savePreferences(preferences) {
            if (!currentUser) return;
            try {
                const dataUid = getActiveDataAccountUid();
                if (!dataUid) return;
                const userDocRef = doc(db, 'accounts', dataUid, 'data', 'preferences');
                await setDoc(userDocRef, { preferences, updatedAt: serverTimestamp() }, { merge: true });
            } catch (error) {
                console.error('Error saving preferences to Firestore:', error);
            }
        }

        async function loadPreferences() {
            if (currentUser) {
                try {
                    const dataUid = getActiveDataAccountUid();
                    if (!dataUid) return {};
                    const userDocRef = doc(db, 'accounts', dataUid, 'data', 'preferences');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        return data.preferences || {};
                    }
                    return {};
                } catch (error) {
                    console.error('Error loading preferences from Firestore:', error);
                    return {};
                }
            }
            return {};
        }

        async function saveStagesConfig(config) {
            if (!currentUser) return;
            try {
                const dataUid = getActiveDataAccountUid();
                if (!dataUid) return;
                const userDocRef = doc(db, 'accounts', dataUid, 'data', 'projects');
                await setDoc(userDocRef, { stagesConfig: config, updatedAt: serverTimestamp() }, { merge: true });
            } catch (error) {
                console.error('Error saving stages config to Firestore:', error);
            }
        }

        async function loadStagesConfig() {
            if (currentUser) {
                try {
                    const dataUid = getActiveDataAccountUid();
                    if (!dataUid) return null;
                    const userDocRef = doc(db, 'accounts', dataUid, 'data', 'projects');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.stagesConfig) {
                                        return data.stagesConfig;
                        }
                    }
                    return null;
                } catch (error) {
                    console.error('Error loading stages config from Firestore:', error);
                    return null;
                }
            }
            return null;
        }

        // Show auth error message
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            if (!errorDiv) return;
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Clear auth error message
        function clearAuthError() {
            const errorDiv = document.getElementById('authError');
            if (!errorDiv) return;
            errorDiv.textContent = '';
            errorDiv.style.display = 'none';
        }

        // Update UI based on authentication state
        function updateAuthUi() {
            const authStatus = document.getElementById('authStatus');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const connectionStatus = document.getElementById('connectionStatus');

            if (currentUser) {
                if (authStatus) authStatus.textContent = currentUser.email || 'משתמש מחובר';
                if (loginBtn) loginBtn.style.display = 'none';
                if (logoutBtn) logoutBtn.style.display = 'block';
                if (connectionStatus) {
                    connectionStatus.classList.remove('disconnected');
                    connectionStatus.classList.add('connected');
                    connectionStatus.querySelector('span').textContent = 'מחובר';
                }
            } else {
                if (authStatus) authStatus.textContent = 'לא מחובר';
                if (loginBtn) loginBtn.style.display = 'block';
                if (logoutBtn) logoutBtn.style.display = 'none';
                if (connectionStatus) {
                    connectionStatus.classList.add('disconnected');
                    connectionStatus.classList.remove('connected');
                    connectionStatus.querySelector('span').textContent = 'לא מחובר';
                }
            }
        }

        // Load all data from Firebase after authentication
        async function loadAllDataFromFirebase() {
            if (!currentUser) return;

            try {
                // Load all data from Firebase
                const [projects, reminders, inbox, preferences, stagesConf] = await Promise.all([
                    loadProjectsFromFirebase(),
                    loadReminders(),
                    loadInbox(),
                    loadPreferences(),
                    loadStagesConfig()
                ]);

                // Update global variables if they exist
                if (projects && Object.keys(projects).length > 0) {
                    if (typeof window.setProjectsData === 'function') {
                        window.setProjectsData(projects);
                    } else if (typeof window.projects !== 'undefined') {
                        window.projects = projects;
                    }
                }
                if (reminders) {
                    if (typeof window.setRemindersData === 'function') {
                        window.setRemindersData(reminders);
                    } else if (typeof window.reminders !== 'undefined') {
                        window.reminders = reminders;
                    }
                }
                if (inbox) {
                    if (typeof window.setInboxData === 'function') {
                        window.setInboxData(inbox);
                    } else if (typeof window.inbox !== 'undefined') {
                        window.inbox = inbox;
                    }
                }
                if (stagesConf) {
                    if (typeof window.setStagesConfigData === 'function') {
                        window.setStagesConfigData(stagesConf);
                    } else {
                        window.stagesConfig = stagesConf;
                    }
                }

                // Reload UI
                refreshProjectsAndMetricsUI();
                if (typeof window.renderRemindersList === 'function') window.renderRemindersList();
                if (typeof window.renderInbox === 'function') window.renderInbox();

                console.log('Successfully loaded data from Firebase');
            } catch (error) {
                console.error('Failed to load data from Firebase:', error);
            }
        }

        // Save all current data to Firebase
        async function syncAllDataToFirebase() {
            if (!currentUser) return;

            try {
                const promises = [];

                // Save projects
                if (typeof window.projects !== 'undefined') {
                    promises.push(saveProjects(window.projects));
                }

                // Save reminders
                if (typeof window.reminders !== 'undefined') {
                    promises.push(saveReminders(window.reminders));
                }

                // Save inbox
                if (typeof window.inbox !== 'undefined') {
                    promises.push(saveInbox(window.inbox));
                }

                // Save stages config
                if (typeof window.stagesConfig !== 'undefined') {
                    promises.push(saveStagesConfig(window.stagesConfig));
                }

                await Promise.all(promises);
                console.log('Successfully synced data to Firebase');
            } catch (error) {
                console.error('Failed to sync data to Firebase:', error);
            }
        }

        // Debounced sync function
        let syncTimeout = null;
        function queueSync() {
            if (!currentUser) return;
            if (syncTimeout) clearTimeout(syncTimeout);
            syncTimeout = setTimeout(() => {
                syncAllDataToFirebase().catch((error) => {
                    console.error('Firebase sync failed:', error);
                });
                syncTimeout = null;
            }, 500);
        }

        // Hook into save functions to trigger Firebase sync
        function wireSaveHooks() {
            const hookTargets = ['saveAllProjects', 'queueRemindersSave', 'queueInboxSave'];
            hookTargets.forEach((fnName) => {
                const original = window[fnName];
                if (typeof original !== 'function') return;
                window[fnName] = function(...args) {
                    const result = original.apply(this, args);
                    queueSync();
                    return result;
                };
            });

            // Sync on page unload
            window.addEventListener('beforeunload', () => {
                if (currentUser) {
                    syncAllDataToFirebase().catch(() => {});
                }
            });
        }

        // Open authentication modal
        function openAuthModal() {
            const modal = document.getElementById('authModal');
            if (modal) modal.style.display = 'flex';
            clearAuthError();
        }

        // Close authentication modal
        function closeAuthModal() {
            const modal = document.getElementById('authModal');
            if (modal) modal.style.display = 'none';
            clearAuthError();
        }

        // Toggle between login and register forms
        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const title = document.getElementById('authModalTitle');
            if (!loginForm || !registerForm || !title) return;

            const showingLogin = loginForm.style.display !== 'none';
            loginForm.style.display = showingLogin ? 'none' : 'block';
            registerForm.style.display = showingLogin ? 'block' : 'none';
            title.textContent = showingLogin ? 'הרשמה למערכת' : 'התחבר למערכת';
            clearAuthError();
        }

        // Expose functions globally
        window.closeAuthModal = closeAuthModal;
        window.toggleAuthForm = toggleAuthForm;

        // Initialize Firebase integration when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Firebase integration initializing...');

            clearLegacyLocalData();

            // Wire save hooks
            wireSaveHooks();

            try {
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.warn('Failed to enforce local auth persistence:', error);
            }

            try {
                const redirectResult = await getRedirectResult(auth);
                if (redirectResult?.user) {
                    closeAuthModal();
                }
            } catch (error) {
                console.error('Redirect sign-in error:', error);
            }

            // Set up auth modal buttons
            document.getElementById('loginBtn')?.addEventListener('click', openAuthModal);
            
            document.getElementById('logoutBtn')?.addEventListener('click', async () => {
                try {
                    await signOutUser();
                    currentUser = null;
                    updateAuthUi();
                } catch (error) {
                    console.error('Sign out error:', error);
                    showAuthError('שגיאה בהתנתקות. נסה שוב.');
                }
            });

            // Google Sign-In
            document.getElementById('googleSignInBtn')?.addEventListener('click', async () => {
                clearAuthError();
                try {
                    const user = await signInWithGoogle();
                    if (user) {
                        closeAuthModal();
                    }
                } catch (error) {
                    console.error('Google sign-in error:', error);
                    showAuthError(`התחברות עם Google נכשלה. ${getGoogleSignInHint(error?.code)}`);
                }
            });

            // Email/Password Login
            document.getElementById('loginForm')?.addEventListener('submit', async (event) => {
                event.preventDefault();
                clearAuthError();

                const email = document.getElementById('loginEmail')?.value?.trim();
                const password = document.getElementById('loginPassword')?.value || '';

                if (!email || !password) {
                    showAuthError('נא למלא את כל השדות.');
                    return;
                }

                try {
                    await signInWithEmail(email, password);
                    closeAuthModal();
                } catch (error) {
                    console.error('Email sign-in error:', error);
                    showAuthError('אימייל או סיסמה לא תקינים.');
                }
            });

            // Email/Password Registration
            document.getElementById('registerForm')?.addEventListener('submit', async (event) => {
                event.preventDefault();
                clearAuthError();

                const email = document.getElementById('registerEmail')?.value?.trim();
                const password = document.getElementById('registerPassword')?.value || '';
                const confirmPassword = document.getElementById('registerPasswordConfirm')?.value || '';

                if (!email || !password || !confirmPassword) {
                    showAuthError('נא למלא את כל השדות.');
                    return;
                }

                if (password !== confirmPassword) {
                    showAuthError('הסיסמאות לא תואמות.');
                    return;
                }

                if (password.length < 6) {
                    showAuthError('הסיסמה חייבת להכיל לפחות 6 תווים.');
                    return;
                }

                try {
                    await registerWithEmail(email, password);
                    closeAuthModal();
                } catch (error) {
                    console.error('Registration error:', error);
                    let errorMessage = 'ההרשמה נכשלה. נסה שוב.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'האימייל כבר קיים במערכת.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'כתובת אימייל לא תקינה.';
                    }
                    showAuthError(errorMessage);
                }
            });

            const addMetricNameInput = document.getElementById('addMetricName');
            addMetricNameInput?.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addNewMetric();
                }
            });

            const cameraButton = document.querySelector('.camera-btn');
            cameraButton?.addEventListener('click', async () => {
                if (!navigator.mediaDevices?.getUserMedia) return;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    console.warn('Camera permission preflight failed:', error);
                }
            }, { once: true });


            // Close modal on background click
            const authModal = document.getElementById('authModal');
            authModal?.addEventListener('click', (event) => {
                if (event.target === authModal) closeAuthModal();
            });

            console.log('Firebase integration initialized');
        });

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            console.log('Auth state changed:', user ? user.email : 'No user');
            currentUser = user;
            setActiveDataAccountUid(user ? user.uid : null);
            setCurrentUser(user);
            window.currentFirebaseUser = user;
            updateAuthUi();

            if (user && !isInitialized) {
                isInitialized = true;
                closeAuthModal();
                try {
                    await ensureUserAccountIndex(user);
                } catch (error) {
                    console.warn('Failed to update user account index:', error);
                }
                // Load data from Firebase when user signs in
                const restoredSharedAccess = typeof window.restoreSharedAccessFromStorage === 'function'
                    ? window.restoreSharedAccessFromStorage()
                    : false;
                if (!restoredSharedAccess) {
                    if (typeof window.clearSharedAccess === 'function') {
                        window.clearSharedAccess();
                    }
                }
                const restoredOwnerUid = window.sharedAccessContext?.ownerUid || localStorage.getItem('sharedAccessOwnerUid');
                if (restoredSharedAccess && restoredOwnerUid) {
                    setActiveDataAccountUid(restoredOwnerUid);
                }
                await loadAllDataFromFirebase();
                initializeRealtimeDataListeners();
            } else if (!user) {
                isInitialized = false;
                detachRealtimeListeners();
                if (typeof window.clearSharedAccess === 'function') {
                    window.clearSharedAccess();
                }
                // Show auth modal when user is not logged in
                setTimeout(() => {
                    openAuthModal();
                }, 300);
            }
        });
    </script>

    <script>
        // Stage Navigation Fix - Deterministic renderer (always shows 6 categories)
        // Uses global stagesConfig from main script to avoid duplication

        function getStageDefinitions() {
          // If stagesConfig is available globally, use it
          if (window.stagesConfig) {
            const stages = ['stage1', 'stage2', 'stage3', 'stage4', 'stage5', 'stage6'];
            return stages
              .filter(id => window.stagesConfig[id])
              .map(id => {
                const config = window.stagesConfig[id];
                return {
                  id,
                  longName: config.longName || config.name
                };
              });
          }
          
          // Fallback definitions if stagesConfig not available
          return [
            { id: 'stage1', longName: 'בציר' },
            { id: 'stage2', longName: 'ריסוק והכנה לתסיסה' },
            { id: 'stage3', longName: 'תסיסה אלכוהולית' },
            { id: 'stage4', longName: 'תסיסה מלולקטית' },
            { id: 'stage5', longName: 'יישון' },
            { id: 'stage6', longName: 'הכנה לבקבוק' }
          ];
        }

        function createButton(stage) {
          const btn = document.createElement('button');
          btn.className = 'stage-nav-button';
          btn.type = 'button';
          btn.textContent = stage.longName;
          if (stage.id === 'stage3' || stage.id === 'stage4') btn.classList.add('tight-hebrew');
          btn.onclick = () => {
            if (typeof window.switchStage === 'function') {
              window.switchStage(stage.id);
            } else {
              console.log('[StageNavFix] Clicked:', stage.id, '(switchStage not available)');
            }
          };
          return btn;
        }

        let renderPending = false;

        function renderStageNavDeterministic() {
          const container = document.getElementById('stageNavContainer');
          if (!container) return;

          if (renderPending) return;
          renderPending = true;
          
          requestAnimationFrame(() => {
            const stages = getStageDefinitions();
            
            container.innerHTML = '';
            const rowLeft = document.createElement('div');
            const logoRow = document.createElement('div');
            logoRow.className = 'wine-icon-container';
            const rowRight = document.createElement('div');

            stages.slice(0, 3).forEach(s => rowLeft.appendChild(createButton(s)));
            
            const wineIconLink = document.createElement('a');
            wineIconLink.href = '#';
            wineIconLink.onclick = (e) => { e.preventDefault(); };
            const wineIconImg = document.createElement('img');
            wineIconImg.src = 'image_00b206.png';
            wineIconImg.alt = 'Wine Icon';
            wineIconLink.appendChild(wineIconImg);
            logoRow.appendChild(wineIconLink);
            
            stages.slice(3, 6).forEach(s => rowRight.appendChild(createButton(s)));

            container.appendChild(rowLeft);
            container.appendChild(logoRow);
            container.appendChild(rowRight);

            [rowLeft, logoRow, rowRight].forEach(el => {
              el.style.display = 'flex';
              el.style.visibility = 'visible';
            });
            
            renderPending = false;
          });
        }

        let observerActive = false;
        let observer = null;
        let visibilityHandler = null;
        let resizeHandler = null;

        function setupObserver() {
          const container = document.getElementById('stageNavContainer');
          if (!container || observerActive) return;

          const ensureSix = () => {
            if (renderPending) return;
            
            const buttons = container.querySelectorAll('.stage-nav-button');
            if (buttons.length !== 6) {
              console.warn('[StageNavFix] Buttons lost/incorrect count, re-rendering...');
              renderStageNavDeterministic();
            }
          };

          ensureSix();

          observer = new MutationObserver(ensureSix);
          observer.observe(container, { childList: true, subtree: true });
          observerActive = true;

          visibilityHandler = ensureSix;
          resizeHandler = ensureSix;
          
          document.addEventListener('visibilitychange', visibilityHandler);
          window.addEventListener('resize', resizeHandler);
        }

        function cleanup() {
          if (observer) {
            observer.disconnect();
            observer = null;
            observerActive = false;
          }
          
          if (visibilityHandler) {
            document.removeEventListener('visibilitychange', visibilityHandler);
            visibilityHandler = null;
          }
          if (resizeHandler) {
            window.removeEventListener('resize', resizeHandler);
            resizeHandler = null;
          }
        }

        function initStageNavFix() {
          renderStageNavDeterministic();
          setupObserver();
        }

        window.addEventListener('beforeunload', cleanup);

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initStageNavFix);
        } else {
          initStageNavFix();
        }
    </script>
</body>
</html>
